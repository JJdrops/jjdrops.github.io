<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>代码审计基础 | J_drops</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">代码审计基础</h1><a id="logo" href="/.">J_drops</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">代码审计基础</h1><div class="post-meta">Oct 22, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="1-审计方法与步骤"><a href="#1-审计方法与步骤" class="headerlink" title="1 审计方法与步骤"></a>1 审计方法与步骤</h2><h4 id="A-审计前的准备"><a href="#A-审计前的准备" class="headerlink" title="A 审计前的准备"></a>A 审计前的准备</h4><p>1 获得源码-安装网站（在本地搭建网站，一边审计一边测试，实时跟踪各种动态变化)</p>
<p>2 把我大局</p>
<ul>
<li>网站结构（浏览源码文件夹，了解程序的大致目录）</li>
<li>入口文件（index.php,admin.php文件一般是整个文件的入口，详细读一下index.php文件可知道程序的架构，运行流程等）</li>
<li>配置文件（一般类似config.php等文件，保存一些数据库相关信息程序的一些信息。先看看数据库编码，如果是gbk则可能存在宽字节注入。如果变量的值是双引号，则可能存在双引号解析代码执行问题）</li>
<li>(重点）过滤功能-通过详读公共函数文件和安全过滤文件，清晰掌握用户输入的数据，哪些被过滤，哪些无过滤；过滤方式是替换还是正则?有没有GPC？有没有使用addslasher()处理</li>
</ul>
<a id="more"></a>
<p><img src="http://i1.piimg.com/567571/dfffc0b2306e5093.png" alt=""></p>
<h4 id="B-审计方法"><a href="#B-审计方法" class="headerlink" title="B 审计方法"></a>B 审计方法</h4><ul>
<li>通读源码（一般是企业对自身产品的审计，对于小型应用也可读一读）—-方法：把握大局，然后根据入口文件进行各个模块的审计</li>
<li>敏感函数参数回朔法（shell_exec)—利用Seay法师审计系统，然后可以分析判断敏感函数的上下文，追踪参数源头</li>
<li><p>(重要）定向功能分析法–主要根据程序的业务逻辑来审计，首先用浏览器逐个访问浏览，看看这套程序有哪些功能。根据相关功能，大概存在哪些漏洞。</p>
<p>  常见功能漏洞：（包括但不限于）<br>  初始化安装<br>  站点信息泄露<br>  文件上传，管理<br>  登录认证，权限管理<br>  数据库备份恢复<br>  找回密码<br>  验证码<br>总结：</p>
</li>
<li><p>首先，把握大局，不管什么程序，都要把握大局</p>
</li>
<li>其次，根据定向功能针对每一项功能进行审计；</li>
<li>最后，就是明娜函数参数回溯<h2 id="2-常见的INI配置"><a href="#2-常见的INI配置" class="headerlink" title="2 常见的INI配置"></a>2 常见的INI配置</h2><h4 id="A-配置文件"><a href="#A-配置文件" class="headerlink" title="A 配置文件"></a>A 配置文件</h4></li>
<li>php.ini： 在PHP启动时被读取。对于服务器模块版本的PHP，仅在web服务器启动时读取一次</li>
<li>.user.ini文件：自PHP5.3.0起，php支持基于每个目录的.htaccess风格的INI文件</li>
<li><p>还可以在httpd.conf中覆盖php.ini的值，以进行更灵活的配置</p>
<h4 id="B-配置文件语法"><a href="#B-配置文件语法" class="headerlink" title="B 配置文件语法"></a>B 配置文件语法</h4><h4 id="C-变量相关的配置"><a href="#C-变量相关的配置" class="headerlink" title="C 变量相关的配置"></a>C 变量相关的配置</h4><p>php.ini<br>-<br>  变量相关：<br>  启用全局变量    register_globals = off 作用是关闭自动注册的全局变量，在设置为on的时候，php会将$_POST,$_GET,$_COOKIE,$_ENV,$_SESSION数组总的$key-&gt;$value直接注册为变量，比如$_POST[“username”]就会被注册为$username</p>
<p>  虽然方便了调用，但是有三个问题：</p>
<ul>
<li>不知道变量是哪里来的$_POST的还是$_SESSION来的，非常不方便阅读代码</li>
<li>变量之间互相覆盖，引起不必要的麻烦(重点）</li>
<li><p>安全问题，所以要设置为off<br>短标签：<br>short_open_tag = on<br>这个设置决定是否使用PHP代码开始标志的缩写形式（&lt;??&gt;），若禁用，开始标签必须是完整形式（&lt;?php ?&gt;）<br>同时会影响到缩写形式&lt;?=,它和&lt;?echo等价，从php5.4.0起,&lt;?=总是可用的<br>主要在文件上传使用到，若开启我们可以在上传一句话等使用变形</p>
<h4 id="D-安全模式的配置"><a href="#D-安全模式的配置" class="headerlink" title="D 安全模式的配置"></a>D 安全模式的配置</h4><p>safe_mode = off（默认）</p>
<p>能够控制一些php中的函数，比如system(),同时把很多文件操作函数进行了权限控制，也不允许对某些关键文件的文件，比如/etc/passwd，但是默认的php.ini是没有打开安全模式的<br>本特性已经在PHP5.3.0起飞起并将PHP5.40起移除</p>
<p>禁用类/函数<br>disable_classes=,disable_functions=,disable_function=opendir,readir,scandir,fopen,unlink<br>禁用某些类，禁用某些函数。接受函数分隔的函数名列表作为参数。只能设置在php.ini中</p>
<h4 id="E-上传文件及目录权限的配置"><a href="#E-上传文件及目录权限的配置" class="headerlink" title="E 上传文件及目录权限的配置"></a>E 上传文件及目录权限的配置</h4><p>设置上传及最大上传文件大小<br>file_uploads = on<br>upload_max_filesze = 8M<br>文件上传的临时目录<br>upload_tmp_dir=<br>上传临时文件保存的目录，需要可写，如果不设置，则采用系统临时目录（/tmp,C:\Windows\temp)<br>用户访问目录限制<br>open_basedir = .:/tmp/    linux下:代表不同目录的分隔；windows下;代表不同目录分割<br>能够避免PHP脚本访问不应该访问的文件，一定程度上限制了phpshell的危害。我们一般可以设置为只能访问网站目录，表示允许访问当前目录（即PHP脚本文件所在目录）和/tmp/目录，有效防止php木马跨站运行</p>
<h4 id="F-错误信息的配置"><a href="#F-错误信息的配置" class="headerlink" title="F 错误信息的配置"></a>F 错误信息的配置</h4><p>错误信息控制：<br>display_error = On<br>站点发布后应关闭此功能，以免暴漏信息，调试的时候为了输出错误信息，故打开<br>设置错误报告级别：<br>error_reporting = E_ALL<br>这个设置的作用是将错误级别设置为最高，可以显示所有的问题，方便查错，也有利于写出高质量的代码。推荐使用E_ALL|E_STRICT,即所有级别。<br>错误日志：<br>error_log=<br>错误日志的位置，必须对web用户可写入，如果不定义则默认写入到web服务器的错误日志中<br>log_errors = on<br>如下所言，建议将错误日志输出到文件，而不知直接输出到前端</p>
<h4 id="G-魔术引号及远程文件的配置"><a href="#G-魔术引号及远程文件的配置" class="headerlink" title="G 魔术引号及远程文件的配置"></a>G 魔术引号及远程文件的配置</h4><p>魔术引号（本特性已自PHP5.3.0起废弃并将自PHP5.4.0起移除<br>magic_quotes_gpc = On<br>gagic_quotes_runtime = Off<br>为GPC（Get/Post/Cookie)操作设置magic_quotes状态，当magic_quotes为on，所有单引号，双引号，反斜杠和NULL(%00)被一个反斜杠自动转义<br>是否允许打开远程文件<br>allow_url_fopen = on<br>是否允许包含远程文件（include/require)<br>allow_url_include = false</p>
<h2 id="3-常见危险函数及特殊函数"><a href="#3-常见危险函数及特殊函数" class="headerlink" title="3 常见危险函数及特殊函数"></a>3 常见危险函数及特殊函数</h2><h4 id="代码执行函数"><a href="#代码执行函数" class="headerlink" title="代码执行函数"></a>代码执行函数</h4><p>eval$assert（调试函数，和eval同样有把字符长当做php执行的功能）&amp;preg_replace</p>
</li>
<li>mixed eval(string $code)<br>把字符串$code作为php代码执行<br>很多的webshell都是用的eval执行具体的操作&lt;?php @eval($_POST[“0”]);?&gt;</li>
<li>bool assert(mixed $assertion[string $description])<br>检查一个断言是否为FALSE<br>因为大多数杀软把eval列入黑名单，故用assert来替代eval来执行具体的操作</li>
<li>preg_replace($pattern, $replacement, $string)<br>搜索$string中符合正则规则$pattern的部分，以$replacement替换，返回替换后的内容。<br>/e修正符使preg_replace()将replacement参数当做php代码<h4 id="包含函数"><a href="#包含函数" class="headerlink" title="包含函数"></a>包含函数</h4>require，include，require_once，include_once<br>包含函数也能读取任意文件内容，这需要用到[支持的协议和封装协议]和[过滤器]<br>例如：利用php流filter读取任意文件<br>include($_GET[“file”]);<br>?file=php://filter/convert.base64.encode/resource=index.php<h4 id="命令执行函数"><a href="#命令执行函数" class="headerlink" title="命令执行函数"></a>命令执行函数</h4></li>
</ul>
</li>
<li>exec() -执行一个外部程 *</li>
<li>passthru() - 执行外部程序并显示原始输出 *</li>
<li>proc_open() - 执行一个命令并打开文件指针用于读取以及写入</li>
<li>shell_exec() - 通过 Shell 执行命令，并将执行结果作为字符串返回 *</li>
<li>system() - 允许执行一个外部程序并回显输出，类似于 passthru()。 *</li>
<li>popen() - 通过popen()参数传递一条命令，并对popen()所打开的文件进行执行</li>
</ul>
<p>只要命令的参数可控就能执行系统命令<br>例如：</p>
<pre><code>system($cmd);或者system(&apos;ping -c 3&apos;.$target);
当$cmd可以控就能执行任意命令
当$target可控的话，可以使用管道符等特殊函数截断从而执行任意命令
$target = &apos;a | whoami&apos;:

大体的思路就是，先把握大局-&gt;针对漏洞有目的的搜索危险函数-&gt;定位危险函数所在文件-&gt;回溯危险源-&gt;找到执行的函数-&gt;过滤防护
</code></pre><h4 id="文件操作函数"><a href="#文件操作函数" class="headerlink" title="文件操作函数"></a>文件操作函数</h4><ul>
<li>copy -拷贝函数</li>
<li>file_get_contents - 把整个文件读入为一个字符串</li>
<li>file_put_contents -将一个字符串写入文件</li>
<li>file -把整个文件读入一个数组中</li>
<li>fopen - 打开文件或者URL</li>
<li>move_uploaded_file -将上传的文件移动到新的位置</li>
<li>readfile - 输出文件</li>
<li>rename -重命名一个文件或目录</li>
<li>rmdir -删除目录</li>
<li>unlink&amp;delete - 删除文件</li>
</ul>
<p>任意文件读取写入删除往往是上面几个函数收到了控制</p>
<h4 id="特殊函数"><a href="#特殊函数" class="headerlink" title="特殊函数"></a>特殊函数</h4><ul>
<li>string getenv(string $varname)<br>获取一个环境变量</li>
<li>bool putenv(string $setting)<br>添加setting到服务器环境变量，环境变量仅存活与当前请求期间，在请求结束时环境就会自动恢复到初始状态</li>
</ul>
<p>配置相关</p>
<ul>
<li>string ini_get(string $varname)  成功时返回配置选项的值</li>
<li>string ini_set(string $varname,string $newvalue)</li>
<li>string ini_alter(string $varname,string $newvalue)</li>
</ul>
<p>设置指定配置选项的值，这个选项会在脚本运行时保持新的值，并在脚本结束时恢复。</p>
<pre><code>&lt;?php
splay_errors = &quot;.(ini_get(&apos;display_errors&apos;)?&apos;On&apos;:&apos;Off&apos;);
ini_set(&quot;display_errors&quot;,0);
echo &quot;\r\n&lt;br/&gt;display_errors = &quot;.(ini_get(&apos;display_errors&apos;)?&apos;On&apos;:&apos;Off&apos;);
?&gt;
</code></pre><p>数字判断</p>
<ul>
<li>bool is_numeric(mixed $var)<br>如果var是数字和数字字符串则返回TURE，否则返回FALSE，如果仅用is_numeric判断而不用inval转换就有可能插入16进制的字符创到数据库中，进而导致sql的二次注入</li>
</ul>
<p>数组相关</p>
<ul>
<li>bool in_array(mixed $needle,array $haystack[,bool $strict = FALSE])</li>
</ul>
<p>在haystack中搜索needle，若没有设置strict则使用宽松的比较。<br>该函数有一个特性，比较之前会进行自动类型转换</p>
<pre><code> $a = &apos;1abc&apos;
in_array($a,array(1,2,3)的返回值会是真
</code></pre><p>变量覆盖</p>
<pre><code>- void parse_str(string $str[,arrary &amp;$arr])

若str是URL传递的查询字符串(query string),则将它解析为变量并设置到当前域。

&lt;?php
//parse_str
$str = &quot;first=value&amp;arr[]=foobar&amp;arr[]=baz&quot;;
echo &quot;&lt;pre&gt;&quot;;
parse_str($str,$array);
print_r($array);

var_dump(isset($first));//已经复制到数组中，不在当前域

parse_str($str);
var_dump(isset($first));
echo &quot;\$first = $first&quot;;
echo &quot;r\n&lt;br /&gt;&quot;;
echo &quot;\$arr[0]=$arr[0]&quot;;
echo &quot;r\n&lt;br /&gt;&quot;;
echo &quot;\$arr[1]=$arr[1]&quot;;
?&gt;
&lt;pre&gt;Array
(
    [first] =&gt; value
    [arr] =&gt; Array
        (
            [0] =&gt; foobar
            [1] =&gt; baz
        )

)
bool(false)
bool(true)
$first = valuer
&lt;br /&gt;$arr[0]=foobarr
&lt;br /&gt;$arr[1]=baz[Finished in 0.1s]
</code></pre><p>列目录</p>
<pre><code>glob()函数依照libc glob()函数使用的规则寻找所有与pattern匹配的文件路径；
&lt;?php
//glob
echo &quot;&lt;pre&gt;&quot;;
print_r(glob(&quot;t*.php&quot;));//匹配t开头的
?&gt;
</code></pre></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/10/22/代码审计基础/" data-id="cj0bw5cvq000miguf20ltwyoz" class="article-share-link">Share</a><div class="tags"><a href="/tags/代码审计/">代码审计</a></div><div class="post-nav"><a href="/2016/10/25/sql注入绕过技巧/" class="pre">sql注入绕过技巧</a><a href="/2016/10/21/代码审计知识储备/" class="next">代码审计知识储备</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/python-web开发/" style="font-size: 15px;">python web开发</a> <a href="/tags/python3/" style="font-size: 15px;">python3</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/python运维/" style="font-size: 15px;">python运维</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/WAF/" style="font-size: 15px;">WAF</a> <a href="/tags/代码审计-PHP/" style="font-size: 15px;">代码审计  PHP</a> <a href="/tags/PHP/" style="font-size: 15px;">PHP</a> <a href="/tags/渗透测试-CTF/" style="font-size: 15px;">渗透测试 CTF</a> <a href="/tags/代码审计/" style="font-size: 15px;">代码审计</a> <a href="/tags/python3-数据库/" style="font-size: 15px;">python3 数据库</a> <a href="/tags/渗透测试/" style="font-size: 15px;">渗透测试</a> <a href="/tags/总结感想/" style="font-size: 15px;">总结感想</a> <a href="/tags/渗透技巧/" style="font-size: 15px;">渗透技巧</a> <a href="/tags/ctf/" style="font-size: 15px;">ctf</a> <a href="/tags/代码审计-PHP/" style="font-size: 15px;">代码审计 PHP</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/03/14/文件包含-phar-LFI/">文件包含-phar LFI</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/02/攻破MrRobot-黑客技能训练/">攻破MrRobot-黑客技能训练</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/模拟渗透测试get到的技巧/">模拟渗透测试get到的技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/17/Linux常用命令使用总结/">Linux常用命令使用总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/15/渗透绕WAF的方法/">渗透绕WAF的方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/10/docker学习/">docker学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/29/全局防护Bypass之宽字节注入/">全局防护Bypass之宽字节注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/28/PHP代码解析标签/">PHP代码解析标签</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/sql注入绕过技巧/">sql注入绕过技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/22/代码审计基础/">代码审计基础</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">J_drops.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>